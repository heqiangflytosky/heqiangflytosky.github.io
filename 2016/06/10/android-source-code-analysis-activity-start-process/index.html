<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android源码分析,startActivity," />





  <link rel="alternate" href="/atom.xml" title="孤舟蓑笠翁，独钓寒江雪" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="基于Android6.0来分析 Activity 的启动过程">
<meta property="og:type" content="article">
<meta property="og:title" content="Android startActivity 流程分析">
<meta property="og:url" content="http://yoursite.com/2016/06/10/android-source-code-analysis-activity-start-process/index.html">
<meta property="og:site_name" content="孤舟蓑笠翁，独钓寒江雪">
<meta property="og:description" content="基于Android6.0来分析 Activity 的启动过程">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/pLTDJnin4Btlht13hrL5Zf62590g8WLKiQ5LLLN8U0TYiTWhsqdXrgzJUu1J3-sv4ZTwwQc7_fa6-1draat8ElP-PMbxYPBn-BsPyRDdCg01e0FErJu_yJpzWHghKg5E5A6dWXEGie5MUlHmeDR38NWH5eeI6c6cVOYY8wfEKyOkaqeCZu4fh2XdrWrRcE5341h_v1HXQRNlhNh00dGNLMVBdqMKXRgjUKUGvU63655YT_4L9aV-C8fT91Tkd_HA58MKt2RS7mZ0mMqAHW9D_QjCMGjLgPaTHsgrCKMOhA77A6rukDcOvqaGPaayMfijjQJIkBFpn_4NhE1E4TCloBdf2HSx88UXojbjwAa59q1yExifFUFtV2nffUMbO-ZIRhR0JwJOqeSXC9CQrWcTYDPgjG0d2YuOzrJlTdDH-8xSbI1g836kM9fb2vy-nzHIAFDYEknPH08a3qVWhfV94S1zX97AjyV94GJUlVFiCZA0cAfkmXBff35pJahVspwF4WSAilQuJOwbObz4wp86egPot9ROZu3G0qhAAiV3eK8FY7xB5Mp3wwJxU0XLka4uz2tdZL1k61byBrVY7lXgpT56Mr9BDnY6qCD3hUBPzKM8SKqeuYQgVupFBd___3O-UtVpvltLv-ytlxvUNtoAxUUNuuyNSxkkltou-l5siXWtjnWbbO6zcICq_nmKyN5K0a89gDfvsDxd1C1z4iO3ZL3fFi1cOUu0uI8emMMfn_BnLCoxI2pvFbeoNf7Eu78flx0CQBbkLit5AD0o7iaSv7QOpc1p7kROPzbijNdjTd8DaRw7qx4SjTkfKNTolLl7cBB5jpOPaOsvUd4tLhgAWmhxqxD-WZFt-EJCgatxhDhy5xDgyTWhpwiB5AuUQH1bCTbRqZvbWJqLUsEmcwq49R0NOItQ6s0MXB3k14rBqN9HB2iBWUItnWf_30eVPot_3UoJJNMkYbDDdKegJL58KBtExlR6vbvdezzzrks_gFugJfJf3Auacgxy0HV71U6AwVmltOrwElF_qPgR6MLoB_q1">
<meta property="og:updated_time" content="2019-07-05T01:22:37.912Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android startActivity 流程分析">
<meta name="twitter:description" content="基于Android6.0来分析 Activity 的启动过程">
<meta name="twitter:image" content="http://www.plantuml.com/plantuml/svg/pLTDJnin4Btlht13hrL5Zf62590g8WLKiQ5LLLN8U0TYiTWhsqdXrgzJUu1J3-sv4ZTwwQc7_fa6-1draat8ElP-PMbxYPBn-BsPyRDdCg01e0FErJu_yJpzWHghKg5E5A6dWXEGie5MUlHmeDR38NWH5eeI6c6cVOYY8wfEKyOkaqeCZu4fh2XdrWrRcE5341h_v1HXQRNlhNh00dGNLMVBdqMKXRgjUKUGvU63655YT_4L9aV-C8fT91Tkd_HA58MKt2RS7mZ0mMqAHW9D_QjCMGjLgPaTHsgrCKMOhA77A6rukDcOvqaGPaayMfijjQJIkBFpn_4NhE1E4TCloBdf2HSx88UXojbjwAa59q1yExifFUFtV2nffUMbO-ZIRhR0JwJOqeSXC9CQrWcTYDPgjG0d2YuOzrJlTdDH-8xSbI1g836kM9fb2vy-nzHIAFDYEknPH08a3qVWhfV94S1zX97AjyV94GJUlVFiCZA0cAfkmXBff35pJahVspwF4WSAilQuJOwbObz4wp86egPot9ROZu3G0qhAAiV3eK8FY7xB5Mp3wwJxU0XLka4uz2tdZL1k61byBrVY7lXgpT56Mr9BDnY6qCD3hUBPzKM8SKqeuYQgVupFBd___3O-UtVpvltLv-ytlxvUNtoAxUUNuuyNSxkkltou-l5siXWtjnWbbO6zcICq_nmKyN5K0a89gDfvsDxd1C1z4iO3ZL3fFi1cOUu0uI8emMMfn_BnLCoxI2pvFbeoNf7Eu78flx0CQBbkLit5AD0o7iaSv7QOpc1p7kROPzbijNdjTd8DaRw7qx4SjTkfKNTolLl7cBB5jpOPaOsvUd4tLhgAWmhxqxD-WZFt-EJCgatxhDhy5xDgyTWhpwiB5AuUQH1bCTbRqZvbWJqLUsEmcwq49R0NOItQ6s0MXB3k14rBqN9HB2iBWUItnWf_30eVPot_3UoJJNMkYbDDdKegJL58KBtExlR6vbvdezzzrks_gFugJfJf3Auacgxy0HV71U6AwVmltOrwElF_qPgR6MLoB_q1">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '6377131610457769000',
      author: '寒江蓑笠'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/06/10/android-source-code-analysis-activity-start-process/"/>





  <title> Android startActivity 流程分析 | 孤舟蓑笠翁，独钓寒江雪 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  








  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1261134288&web_id=1261134288" language="JavaScript"></script>
  </div>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">孤舟蓑笠翁，独钓寒江雪</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">程序猿的世界</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-users"></i> <br />
            
            友情链接
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/10/android-source-code-analysis-activity-start-process/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="寒江蓑笠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/icon.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="孤舟蓑笠翁，独钓寒江雪">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="孤舟蓑笠翁，独钓寒江雪" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android startActivity 流程分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-10T10:00:00+08:00">
                2016-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">Android源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2016/06/10/android-source-code-analysis-activity-start-process/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/06/10/android-source-code-analysis-activity-start-process/" class="leancloud_visitors" data-flag-title="Android startActivity 流程分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
              <div class="post-description">
                  基于Android6.0来分析 Activity 的启动过程
              </div>
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Activity的启动方式有两种，一种是显式的，一种是隐式的。<br>而且，启动的 <code>Activity</code> 和原 <code>Activity</code> 的进程关系的不同又可以分为两种情况，一种是在同一个进程，另外一种情况是开启一个新的进程来启动 <code>Activity</code>。</p>
<h2 id="相关类介绍"><a href="#相关类介绍" class="headerlink" title="相关类介绍"></a>相关类介绍</h2><p>涉及到的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">frameworks/base/core/java/android/app/Activity.java</div><div class="line">frameworks/base/core/java/android/app/ActivityThread.java</div><div class="line">frameworks/base/core/java/android/app/Instrumentation.java</div><div class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</div><div class="line">frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</div><div class="line">frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</div></pre></td></tr></table></figure>
<ul>
<li>ActivityThread：代表了应用的主线程，在Activity.attach()方法中初始化</li>
<li>TaskRecord：Activity的管理者</li>
<li>ActivityStack：Stack的管理者</li>
<li>ActivityStackSupervisor：ActivityStack的管理者，早期的Android版本是没有这个类的，直到Android 6.0才出现。</li>
</ul>
<h2 id="启动流程图"><a href="#启动流程图" class="headerlink" title="启动流程图"></a>启动流程图</h2><p><img src="http://www.plantuml.com/plantuml/svg/pLTDJnin4Btlht13hrL5Zf62590g8WLKiQ5LLLN8U0TYiTWhsqdXrgzJUu1J3-sv4ZTwwQc7_fa6-1draat8ElP-PMbxYPBn-BsPyRDdCg01e0FErJu_yJpzWHghKg5E5A6dWXEGie5MUlHmeDR38NWH5eeI6c6cVOYY8wfEKyOkaqeCZu4fh2XdrWrRcE5341h_v1HXQRNlhNh00dGNLMVBdqMKXRgjUKUGvU63655YT_4L9aV-C8fT91Tkd_HA58MKt2RS7mZ0mMqAHW9D_QjCMGjLgPaTHsgrCKMOhA77A6rukDcOvqaGPaayMfijjQJIkBFpn_4NhE1E4TCloBdf2HSx88UXojbjwAa59q1yExifFUFtV2nffUMbO-ZIRhR0JwJOqeSXC9CQrWcTYDPgjG0d2YuOzrJlTdDH-8xSbI1g836kM9fb2vy-nzHIAFDYEknPH08a3qVWhfV94S1zX97AjyV94GJUlVFiCZA0cAfkmXBff35pJahVspwF4WSAilQuJOwbObz4wp86egPot9ROZu3G0qhAAiV3eK8FY7xB5Mp3wwJxU0XLka4uz2tdZL1k61byBrVY7lXgpT56Mr9BDnY6qCD3hUBPzKM8SKqeuYQgVupFBd___3O-UtVpvltLv-ytlxvUNtoAxUUNuuyNSxkkltou-l5siXWtjnWbbO6zcICq_nmKyN5K0a89gDfvsDxd1C1z4iO3ZL3fFi1cOUu0uI8emMMfn_BnLCoxI2pvFbeoNf7Eu78flx0CQBbkLit5AD0o7iaSv7QOpc1p7kROPzbijNdjTd8DaRw7qx4SjTkfKNTolLl7cBB5jpOPaOsvUd4tLhgAWmhxqxD-WZFt-EJCgatxhDhy5xDgyTWhpwiB5AuUQH1bCTbRqZvbWJqLUsEmcwq49R0NOItQ6s0MXB3k14rBqN9HB2iBWUItnWf_30eVPot_3UoJJNMkYbDDdKegJL58KBtExlR6vbvdezzzrks_gFugJfJf3Auacgxy0HV71U6AwVmltOrwElF_qPgR6MLoB_q1" alt="效果图"></p>
<!-- 
------------------------------------------------------------------------------ FirstActivity 进程
├── Activity.startActivity()
     ├── Activity.startActivityForResult()
          ├── Instrumentation.execStartActivity()
               ├── ActivityManagerNative.ActivityManagerProxy.startActivity()
------------------------------------------------------------------------------ FirstActivity 进程
------------------------------------------------------------------------------ AMS 进程
                    ├── ActivityManagerNative.onTransact()
                         ├── ActivityManagerService.startActivity()
                              ├── ActivityManagerService.startActivityAsUser()
                                   ├── ActivityStackSupervisor.startActivityMayWait()
                                        ├── ActivityStackSupervisor.resolveActivity()
                                        ├── ActivityStackSupervisor.startActivityLocked()
                                             ├── ActivityStackSupervisor.startActivityUncheckedLocked()
                                                  ├── ActivityStack.startActivityLocked()
                                                       ├── ActivityStackSupervisor.resumeTopActivitiesLocked()
                                                            ├── ActivityStack.resumeTopActivityLocked()
                                                                 ├── ActivityStack.resumeTopActivityInnerLocked()
                                                                      ├── ActivityStackSupervisor.startSpecificActivityLocked()
                                                                           ├── ActivityStackSupervisor.realStartActivityLocked() 在本进程启动
                                                                               此方法的分析同新进程启动Activity中的realStartActivityLocked()，下面分析
                                                                                ├── ApplicationThreadNative.ApplicationThreadProxy.scheduleLaunchActivity()
------------------------------------------------------------------------------ AMS 进程
------------------------------------------------------------------------------ FirstActivity 进程
├── ActivityThread.H.handleMessage():LAUNCH_ACTIVITY
     ├── ActivityThread.handleLaunchActivity()
          ├── ActivityThread.performLaunchActivity()
------------------------------------------------------------------------------ FirstActivity 进程
------------------------------------------------------------------------------ AMS 进程
                                                                           ├── ActivityManagerService.startProcessLocked() 启动新的进程
                                                                                ├── ActivityManagerService.newProcessRecordLocked()
                                                                                ├── ActivityManagerService.startProcessLocked()
                                                                                     ├── Process.start()
------------------------------------------------------------------------------ AMS 进程
------------------------------------------------------------------------------ SecondActivity 进程
├── ActivityThread.main()
     ├── ActivityThread.attach()
          ├── ActivityManagerNative.ActivityManagerProxy.attachApplication()
------------------------------------------------------------------------------ SecondActivity 进程
------------------------------------------------------------------------------ AMS 进程
├── ActivityManagerNative.onTransact()
     ├── ActivityManagerService.attachApplication()
          ├── ActivityManagerService.attachApplicationLocked()
               ├── ApplicationThreadNative.ApplicationThreadProxy.bindApplication()
------------------------------------------------------------------------------ AMS 进程
------------------------------------------------------------------------------ SecondActivity 进程
                    ├── ApplicationThread.bindApplication()
                         ├── ActivityThread.handleBindApplication()
------------------------------------------------------------------------------ SecondActivity 进程
------------------------------------------------------------------------------ AMS 进程
               ├── ActivityStackSupervisor.attachApplicationLocked()
                    ├── ActivityStackSupervisor.realStartActivityLocked() 此处同上面的同一进程启动Activity
                         ├── ApplicationThreadNative.ApplicationThreadProxy.scheduleLaunchActivity()
------------------------------------------------------------------------------ AMS 进程
------------------------------------------------------------------------------ SecondActivity 进程
├── ApplicationThread.scheduleLaunchActivity()
   ├── ActivityThread.H.handleMessage():LAUNCH_ACTIVITY
        ├── ActivityThread.handleLaunchActivity()
             ├── ActivityThread.performLaunchActivity()
------------------------------------------------------------------------------ SecondActivity 进程

http://www.plantuml.com/plantuml/png/jLVTYjj65BxNKqnDBsn8qhIzMGmRyCffruuDnZRgPHbBi_OGQKQCHjdrdKCefOKa5oqfj9IIGjbUDIsqjFI7lapjZT-YvqYMFBBbzR9i3AlrdByvSxvlT8wZXro4LD601598Tw9am8XMCREYN1FfgS_WgRYhuy2t9jnZv4HAFP9dbWKschiyf4AJIZyMcWUiuMh-YEjfXT28z1j5c-FfI77FuUoq5OH-OdBij3RYG7Iq8E-GxElRnsaqfsZPZeOJnQW7bjdNbMLxMBHq3XAnSr0Kz-YOTQc0fqhqlMvHNpWBB3OJZJLJBN4Yq-mspk4qfHi7JEXqQrWLzI2mPH1AaPaqxGq3vahLeLFO9jLtBElmaBnxXzXIH13Q8wCfQG_8uQ5bzHlazZseTvr8yO1Dc_9KM1JJfveX3AaUYbqdOtb4tOThBI80Vuc_iws6glSTLBQ7THBAIACwL2oArZPGRu_jM86_iSBDJ6N3ijf3Y9w67vM6JWm0l3fXPyo5eXz9wJCg1gxYeQvMqAk7NeXdjLQfhRq1SUU0tCxYkwl2cIc0YKLzJTxAbGG-gwIm81CgF9zr8Jw6xmu-_FYeOJ_ezUyF1hN4jdZqSebP3aJnlIAA1XCJE1CNICgGtnapRSSA2EUnisgDt2Dt4pFyf03rkca5St6-AH0xa_MwcUbObXfkM685fC0yeCGsr6BCjjtWKCLKCgwa3WwF-CXd2JpIz_3_BN92_OZLjcEj2fQ3aCTAuTxlKA2A8xcNySJTIYQ4HylBSgcKP0Fio6H5pfH8ZKJsIf46cTYNCYHGbnnTm5QmqtoP6vQXqcU1VBGYxMMuR6FJPF1UbrCCKkvjP6uK5zszwxXkml91BC1SYch526TWi0k7tLZihloLDKR5cF1sNuQKsDuLhiAMJqjqAHTflohrtmY0hGDBhgaxiIVSznGJ9KJ51fD9SO6kJNk_8xITJDQqCwT8GoTg21vGH2Wt418S51zFT9qilZfVllnj-Uttyp-Up7-PBMUp-QT_pZ__yUBBl_PlakuYHRx5VU5TCJML41vUdXeQPzeU1_I4-TDB_Gs8tvGqGQ1OAaXK9GHu_Upt-VCNQRsMdpoz-EUd__vzkNZyQfChs9wPHhBWN572ZjRQevNsDGmVRZgOZ6wL4uhgQn9gd-CRHosDYkUcNZ9CLWDZLhf5xjQkS2sRdSjPda27HeiNFviyNtpsnVplsKwUTqfpxrYNlsgCYyTq70vXlXbHrH3UHrnuyXGdhh6IyPuxSYEytTE_RxPVbx-Ir_N7Zh6SVNtntGyuvow--NKDnlDNhyyVBsRdr-xzDz7kzy2wezyROcCmsvOo64foDSoCxnTdnkpN2GwCHVH0Wo_NesmkBkjJ-7EcPEiTujMXafQOF8m9_dy0

@startuml
hide footbox

box "1st App Process" #LightBlue
participant Activity
participant Instrumentation
participant ActivityManagerProxy as ActivityManagerProxy_1
end box

box "AMS Process"
participant ActivityManagerNative
participant ActivityManagerService
participant ActivityStackSupervisor
participant ActivityStack
participant ApplicationThreadProxy
end box

box "2nd App Process" #LightBlue
participant ActivityManagerProxy as ActivityManagerProxy_2
participant ApplicationThread
participant "ActivityThread / ActivityThread$H" as ActivityThread
end box

-> Activity:startActivity
activate Activity
Activity -> Activity:startActivityForResult
activate Activity
Activity -> Instrumentation:execStartActivity
activate Instrumentation
Instrumentation -> ActivityManagerProxy_1:startActivity
activate ActivityManagerProxy_1
ActivityManagerProxy_1 -> ActivityManagerNative:onTransact
activate ActivityManagerNative
ActivityManagerNative -> ActivityManagerService:startActivity
activate ActivityManagerService
ActivityManagerService -> ActivityManagerService:startActivityAsUser
activate ActivityManagerService
ActivityManagerService -> ActivityStackSupervisor:startActivityMayWait
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStackSupervisor:resolveActivity
activate ActivityStackSupervisor
deactivate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStackSupervisor:startActivityLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStackSupervisor:startActivityUncheckedLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStack:startActivityLocked
activate ActivityStack
ActivityStack -> ActivityStackSupervisor:resumeTopActivitiesLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStack:resumeTopActivityLocked
activate ActivityStack
ActivityStack -> ActivityStack:resumeTopActivityInnerLocked
activate ActivityStack
ActivityStack -> ActivityStackSupervisor:startSpecificActivityLocked
activate ActivityStackSupervisor

alt !createNewProcess
  ActivityStackSupervisor -> ActivityStackSupervisor:realStartActivityLocked
  activate ActivityStackSupervisor
  ActivityStackSupervisor -[#Blue]> ApplicationThreadProxy:scheduleLaunchActivity
  note right
  可以参考新进程
  启动Activity
  的流程
  end note
  activate ApplicationThreadProxy
  deactivate ApplicationThreadProxy
  deactivate ActivityStackSupervisor
else createNewProcess
  ActivityStackSupervisor -> ActivityManagerService:startProcessLocked
  activate ActivityManagerService
  ActivityManagerService -> ActivityManagerService:newProcessRecordLocked
  activate ActivityManagerService
  deactivate ActivityManagerService
  ActivityManagerService -> ActivityManagerService:startProcessLocked
  activate ActivityManagerService
  deactivate ActivityManagerService
  deactivate ActivityManagerService
end

deactivate ActivityStackSupervisor
deactivate ActivityStack
deactivate ActivityStack
deactivate ActivityStackSupervisor
deactivate ActivityStack
deactivate ActivityStackSupervisor
deactivate ActivityStackSupervisor
deactivate ActivityStackSupervisor
deactivate ActivityManagerService
deactivate ActivityManagerService
deactivate ActivityManagerNative
deactivate ActivityManagerProxy_1
deactivate Instrumentation
deactivate Activity
deactivate Activity

== create New Process ==

-> ActivityThread:main
activate ActivityThread
ActivityThread -> ActivityThread:attach
activate ActivityThread
ActivityThread -> ActivityManagerProxy_2:attachApplication
activate ActivityManagerProxy_2
ActivityManagerProxy_2 -> ActivityManagerNative:onTransact
activate ActivityManagerNative
ActivityManagerNative -> ActivityManagerService:attachApplication
activate ActivityManagerService
ActivityManagerService -> ActivityManagerService:attachApplicationLocked
activate ActivityManagerService

ActivityManagerService -> ApplicationThreadProxy:bindApplication
activate ApplicationThreadProxy
ApplicationThreadProxy -> ApplicationThread:bindApplication
activate ApplicationThread
ApplicationThread -> ActivityThread:handleBindApplication
activate ActivityThread
deactivate ActivityThread
deactivate ApplicationThread
deactivate ApplicationThreadProxy

ActivityManagerService -> ActivityStackSupervisor:attachApplicationLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStackSupervisor:realStartActivityLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -[#Blue]> ApplicationThreadProxy:scheduleLaunchActivity
activate ApplicationThreadProxy
ApplicationThreadProxy -> ApplicationThread:scheduleLaunchActivity
activate ApplicationThread
ApplicationThread -> ActivityThread:LAUNCH_ACTIVITY
activate ActivityThread
ActivityThread -> ActivityThread:handleLaunchActivity
activate ActivityThread
ActivityThread -> ActivityThread:performLaunchActivity
activate ActivityThread
deactivate ActivityThread
deactivate ActivityThread
deactivate ActivityThread
deactivate ApplicationThread
deactivate ApplicationThreadProxy
deactivate ActivityStackSupervisor
deactivate ActivityStackSupervisor

deactivate ActivityManagerService
deactivate ActivityManagerService
deactivate ActivityManagerNative
deactivate ActivityManagerProxy_2
deactivate ActivityThread

deactivate ActivityThread
@enduml

-->
<h2 id="进程间的通信"><a href="#进程间的通信" class="headerlink" title="进程间的通信"></a>进程间的通信</h2><h2 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h2><h3 id="启动前期，当前进程"><a href="#启动前期，当前进程" class="headerlink" title="启动前期，当前进程"></a>启动前期，当前进程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">    <span class="comment">// 一般情况下会走mParent == null分支</span></div><div class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//调用Instrumentation.execStartActivity()启动新的Activity。mMainThread类型为ActivityThread, 在attach()函数被回调时被赋值。</span></div><div class="line">        Instrumentation.ActivityResult ar =</div><div class="line">            mInstrumentation.execStartActivity(</div><div class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</div><div class="line">                intent, requestCode, options);</div><div class="line">        <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 如果activity之前已经启动，而且处于阻塞状态，execStartActivity函数直接返回要启动的activity的result或者null。</span></div><div class="line">            <span class="comment">//如果结果不为空，发送结果</span></div><div class="line">            mMainThread.sendActivityResult(</div><div class="line">                mToken, mEmbeddedID, requestCode, ar.getResultCode(),</div><div class="line">                ar.getResultData());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 如果需要一个返回结果，那么赋值mStartedActivity为true，在结果返回来之前保持当前Activity不可见</span></div><div class="line">            mStartedActivity = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        cancelInputsAndStartExitTransition(options);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里注意到 <code>mParent</code> 变量，一般情况下这里 <code>mParent</code> 是为空的，除非是启动 <code>ActivityGroup</code> 等可以嵌套 <code>Activity</code> 的内部的 <code>Activity</code> 时才会不为空。</p>
<p>Instrumentation.execStartActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></div><div class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</div><div class="line">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options) &#123;</div><div class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">    Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</div><div class="line">        intent.putExtra(Intent.EXTRA_REFERRER, referrer);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 判断mActivityMonitors是否为空，mActivityMonitors可以通过addMonitor()方法创建，一般在自动化测试时使用</span></div><div class="line">    <span class="comment">// 一般情况下不会走这个分支</span></div><div class="line">    <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (mSync) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">                <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</div><div class="line">                <span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</div><div class="line">                    am.mHits++;</div><div class="line">                    <span class="comment">// 如果处于阻塞状态，直接返回</span></div><div class="line">                    <span class="keyword">if</span> (am.isBlocking()) &#123;</div><div class="line">                        <span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        intent.migrateExtraStreamToClipData();</div><div class="line">        intent.prepareToLeaveProcess();</div><div class="line">        <span class="comment">// 这里的ActivityManagerNative.getDefault返回ActivityManagerService的远程接口，即ActivityManagerProxy接口</span></div><div class="line">        <span class="comment">// 由它通过进程间通信调用 AMS 的 startActivity 方法</span></div><div class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</div><div class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">                    token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</div><div class="line">                    requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</div><div class="line">        checkStartActivityResult(result, intent);</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>mActivityMonitors</code> 是 <code>ActivityMonitor</code> 的一个集合，该类用来监控应用中的单个活动，可监控一些指定的意图。一般在一些测试Case时使用。创建 <code>ActivityMonitor</code> 实例后，通过调用 <code>ActivityInstrumentationTestCase2</code> 的 <code>getInstrumentation()</code> 方法获取 <code>Instrumentation</code> 实例，然后通过 <code>addMonitor</code> 方法添加这个实例，当目标活动启动后，系统会匹配 <code>Instrumentation</code> 中的 <code>ActivityMonitor</code> 实例列表，如果匹配，就会累加计数器。</p>
<h3 id="ActivityManagerService的处理"><a href="#ActivityManagerService的处理" class="headerlink" title="ActivityManagerService的处理"></a>ActivityManagerService的处理</h3><h4 id="ActivityManagerService-startActivityAsUser"><a href="#ActivityManagerService-startActivityAsUser" class="headerlink" title="ActivityManagerService.startActivityAsUser"></a>ActivityManagerService.startActivityAsUser</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options, <span class="keyword">int</span> userId) &#123;</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</div><div class="line">    userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</div><div class="line">            <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</div><div class="line">            resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</div><div class="line">            profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, options, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从这里开始就在AMS进程中执行了，下面简单介绍一下这些参数代表的意义：</p>
<ul>
<li>resultTo： 指调用者Activity的mToken，mToken对象保存它所处的ActivityRecord信息</li>
</ul>
<h4 id="ActivityStackSupervisor-startActivityMayWait"><a href="#ActivityStackSupervisor-startActivityMayWait" class="headerlink" title="ActivityStackSupervisor.startActivityMayWait()"></a>ActivityStackSupervisor.startActivityMayWait()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></div><div class="line">         String callingPackage, Intent intent, String resolvedType,</div><div class="line">         IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">         IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</div><div class="line">         ProfilerInfo profilerInfo, WaitResult outResult, Configuration config,</div><div class="line">         Bundle options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</div><div class="line">         IActivityContainer iContainer, TaskRecord inTask) &#123;</div><div class="line">     <span class="comment">// 不允许传递文件描述符</span></div><div class="line">     <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors()) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">boolean</span> componentSpecified = intent.getComponent() != <span class="keyword">null</span>;</div><div class="line">     <span class="comment">// 重新实例化一个Intent对象，防止对intent的修改</span></div><div class="line">     intent = <span class="keyword">new</span> Intent(intent);</div><div class="line"></div><div class="line">     <span class="comment">// 通过Intent解析Activity信息，最终会调用PackageManagerService.resolveIntent()来查询和选择相关的Activity</span></div><div class="line">     <span class="comment">// 如果有多个Activity匹配，那么就会弹框让用户来选择，这部分分析此处省略</span></div><div class="line">     ActivityInfo aInfo =</div><div class="line">             resolveActivity(intent, resolvedType, startFlags, profilerInfo, userId);</div><div class="line"></div><div class="line">     ActivityContainer container = (ActivityContainer)iContainer;</div><div class="line">     <span class="keyword">synchronized</span> (mService) &#123;</div><div class="line">         <span class="comment">// 一般情况下container 为null</span></div><div class="line">         <span class="keyword">if</span> (container != <span class="keyword">null</span> &amp;&amp; container.mParentActivity != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                 container.mParentActivity.state != RESUMED) &#123;</div><div class="line">             <span class="keyword">return</span> ActivityManager.START_CANCELED;</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">final</span> <span class="keyword">int</span> realCallingPid = Binder.getCallingPid();</div><div class="line">         <span class="keyword">final</span> <span class="keyword">int</span> realCallingUid = Binder.getCallingUid();</div><div class="line">         <span class="keyword">int</span> callingPid;</div><div class="line">         <span class="keyword">if</span> (callingUid &gt;= <span class="number">0</span>) &#123;</div><div class="line">             callingPid = -<span class="number">1</span>;</div><div class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (caller == <span class="keyword">null</span>) &#123;</div><div class="line">             callingPid = realCallingPid;</div><div class="line">             callingUid = realCallingUid;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             callingPid = callingUid = -<span class="number">1</span>;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">final</span> ActivityStack stack;</div><div class="line">         <span class="keyword">if</span> (container == <span class="keyword">null</span> || container.mStack.isOnHomeDisplay()) &#123;</div><div class="line">             <span class="comment">// 一般会走到这里，将当前的ActivityStack赋值给stack</span></div><div class="line">             stack = mFocusedStack;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             stack = container.mStack;</div><div class="line">         &#125;</div><div class="line">         stack.mConfigWillChange = config != <span class="keyword">null</span> &amp;&amp; mService.mConfiguration.diff(config) != <span class="number">0</span>;</div><div class="line"></div><div class="line">         <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (aInfo != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                 (aInfo.applicationInfo.privateFlags</div><div class="line">                         &amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</div><div class="line">             <span class="comment">// 处理heavy-weight process，即重量级进程，这种进程在内存不足时不会被kill掉</span></div><div class="line">             <span class="comment">// 一般不会走这里</span></div><div class="line">             <span class="keyword">if</span> (aInfo.processName.equals(aInfo.applicationInfo.packageName)) &#123;</div><div class="line">                 <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                         (mService.mHeavyWeightProcess.info.uid != aInfo.applicationInfo.uid ||</div><div class="line">                         !mService.mHeavyWeightProcess.processName.equals(aInfo.processName))) &#123;</div><div class="line">                     <span class="keyword">int</span> appCallingUid = callingUid;</div><div class="line">…………<span class="comment">//此处代码省略</span></div><div class="line">                 &#125;</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">int</span> res = startActivityLocked(caller, intent, resolvedType, aInfo,</div><div class="line">                 voiceSession, voiceInteractor, resultTo, resultWho,</div><div class="line">                 requestCode, callingPid, callingUid, callingPackage,</div><div class="line">                 realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity,</div><div class="line">                 componentSpecified, <span class="keyword">null</span>, container, inTask);</div><div class="line"></div><div class="line">         Binder.restoreCallingIdentity(origId);</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (stack.mConfigWillChange) &#123;</div><div class="line">             <span class="comment">// 一般不会走这里</span></div><div class="line">             …………</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="comment">// 一般不会走这里</span></div><div class="line">             ……</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">return</span> res;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-startActivityLocked"><a href="#ActivityStackSupervisor-startActivityLocked" class="headerlink" title="ActivityStackSupervisor.startActivityLocked()"></a>ActivityStackSupervisor.startActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">        Intent intent, String resolvedType, ActivityInfo aInfo,</div><div class="line">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">        <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage,</div><div class="line">        <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags, Bundle options,</div><div class="line">        <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity,</div><div class="line">        ActivityContainer container, TaskRecord inTask) &#123;</div><div class="line">    <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</div><div class="line"></div><div class="line">    ProcessRecord callerApp = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 获取调用者所在的ProcessRecord</span></div><div class="line">        callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">        <span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</div><div class="line">            callingPid = callerApp.pid;</div><div class="line">            callingUid = callerApp.info.uid;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            err = ActivityManager.START_PERMISSION_DENIED;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 获取userId，如果是管理员用户该值为0</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = aInfo != <span class="keyword">null</span> ? UserHandle.getUserId(aInfo.applicationInfo.uid) : <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS) &#123;</div><div class="line">        <span class="comment">// 打印一些信息</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ActivityRecord sourceRecord = <span class="keyword">null</span>;</div><div class="line">    ActivityRecord resultRecord = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">// resultTo为调用者Activity的mToken，保存了它所处的ActivityRecord信息</span></div><div class="line">    <span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 获取调用者Activity所对用的ActivityRecord</span></div><div class="line">        sourceRecord = isInAnyStackLocked(resultTo);</div><div class="line">        <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 如果需要返回结果，即requestCode不为-1，赋值resultRecord</span></div><div class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</div><div class="line">                resultRecord = sourceRecord;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> launchFlags = intent.getFlags();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class="number">0</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 对Intent.FLAG_ACTIVITY_FORWARD_RESULT处理，如果设置了这个flag，执行结果相当于透传</span></div><div class="line">        <span class="comment">// 比如Activity启动顺序A-&gt;B-&gt;C，那么C的结果将直接返回给A</span></div><div class="line">        …………<span class="comment">//此处代码忽略</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class="keyword">null</span>) &#123;</div><div class="line">        err = ActivityManager.START_INTENT_NOT_RESOLVED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 如果待启动的Activity没有在Manifestfest中显示声明，就会有这个error</span></div><div class="line">        err = ActivityManager.START_CLASS_NOT_FOUND;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS</div><div class="line">            &amp;&amp; !isCurrentProfileLocked(userId)</div><div class="line">            &amp;&amp; (aInfo.flags &amp; FLAG_SHOW_FOR_ALL_USERS) == <span class="number">0</span>) &#123;</div><div class="line">        err = ActivityManager.START_NOT_CURRENT_USER_ACTIVITY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class="keyword">null</span></div><div class="line">            &amp;&amp; sourceRecord.task.voiceSession != <span class="keyword">null</span>) &#123;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; voiceSession != <span class="keyword">null</span>) &#123;</div><div class="line">        ……</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ActivityStack resultStack = resultRecord == <span class="keyword">null</span> ? <span class="keyword">null</span> : resultRecord.task.stack;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err != ActivityManager.START_SUCCESS) &#123;</div><div class="line">        <span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">            resultStack.sendActivityResultLocked(-<span class="number">1</span>,</div><div class="line">                resultRecord, resultWho, requestCode,</div><div class="line">                Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">return</span> err;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> abort = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> startAnyPerm = mService.checkPermission(</div><div class="line">            START_ANY_ACTIVITY, callingPid, callingUid);</div><div class="line"></div><div class="line">    执行一系列的权限检查</div><div class="line">    …………</div><div class="line"></div><div class="line">    abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</div><div class="line">            callingPid, resolvedType, aInfo.applicationInfo);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mService.mController != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// The Intent we give to the watcher has the extra data</span></div><div class="line">            <span class="comment">// stripped off, since it can contain private information.</span></div><div class="line">            Intent watchIntent = intent.cloneFilter();</div><div class="line">            abort |= !mService.mController.activityStarting(watchIntent,</div><div class="line">                    aInfo.applicationInfo.packageName);</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            mService.mController = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (abort) &#123;</div><div class="line">        <span class="comment">// 权限检查不通过就退出</span></div><div class="line">        <span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">            resultStack.sendActivityResultLocked(-<span class="number">1</span>, resultRecord, resultWho, requestCode,</div><div class="line">                    Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 新建一个ActivityRecord，对应将要启动的Activity</span></div><div class="line">    ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</div><div class="line">            intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</div><div class="line">            requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, <span class="keyword">this</span>, container, options);</div><div class="line">    <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        outActivity[<span class="number">0</span>] = r;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.appTimeTracker == <span class="keyword">null</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">        r.appTimeTracker = sourceRecord.appTimeTracker;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 当前的ActivityStack</span></div><div class="line">    <span class="keyword">final</span> ActivityStack stack = mFocusedStack;</div><div class="line">    <span class="keyword">if</span> (voiceSession == <span class="keyword">null</span> &amp;&amp; (stack.mResumedActivity == <span class="keyword">null</span></div><div class="line">            || stack.mResumedActivity.info.applicationInfo.uid != callingUid)) &#123;</div><div class="line">        <span class="keyword">if</span> (!mService.checkAppSwitchAllowedLocked(callingPid, callingUid,</div><div class="line">                realCallingPid, realCallingUid, <span class="string">"Activity start"</span>)) &#123;</div><div class="line">            PendingActivityLaunch pal =</div><div class="line">                    <span class="keyword">new</span> PendingActivityLaunch(r, sourceRecord, startFlags, stack);</div><div class="line">            mPendingActivityLaunches.add(pal);</div><div class="line">            ActivityOptions.abort(options);</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_SWITCHES_CANCELED;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mService.mDidAppSwitch) &#123;</div><div class="line">        mService.mAppSwitchesAllowedTime = <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mService.mDidAppSwitch = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">    err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor,</div><div class="line">            startFlags, <span class="keyword">true</span>, options, inTask);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</div><div class="line">        notifyActivityDrawnForKeyguard();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-startActivityUncheckedLocked"><a href="#ActivityStackSupervisor-startActivityUncheckedLocked" class="headerlink" title="ActivityStackSupervisor.startActivityUncheckedLocked()"></a>ActivityStackSupervisor.startActivityUncheckedLocked()</h4><p>参数中 r 代表即将要启动的 <code>Activity</code> 对应的 <code>ActivityRecord</code>，<code>sourceRecord</code> 代表调用者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityUncheckedLocked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></div><div class="line">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> startFlags,</div><div class="line">        <span class="keyword">boolean</span> doResume, Bundle options, TaskRecord inTask) &#123;</div><div class="line">    <span class="keyword">final</span> Intent intent = r.intent;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = r.launchedFromUid;</div><div class="line"></div><div class="line">    <span class="comment">// 如果指定的inTask不在Recents列表中，认为inTask是无效的</span></div><div class="line">    <span class="comment">// inTask不为空，表示调用者希望在指定的task里面启动activity</span></div><div class="line">    <span class="comment">// 一般情况下为null</span></div><div class="line">    <span class="keyword">if</span> (inTask != <span class="keyword">null</span> &amp;&amp; !inTask.inRecents) &#123;</div><div class="line">        inTask = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 被启动Activity的启动模式</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTop = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleInstance = r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTask = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> launchFlags = intent.getFlags();</div><div class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_DOCUMENT) != <span class="number">0</span> &amp;&amp;</div><div class="line">            (launchSingleInstance || launchSingleTask)) &#123;</div><div class="line">        <span class="comment">//当Inent中定义的launch flag和manifest中定义的有冲突的话优先使用manifest中定义的</span></div><div class="line">        launchFlags &amp;=</div><div class="line">                ~(Intent.FLAG_ACTIVITY_NEW_DOCUMENT | Intent.FLAG_ACTIVITY_MULTIPLE_TASK);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">switch</span> (r.info.documentLaunchMode) &#123;</div><div class="line">            <span class="keyword">case</span> ActivityInfo.DOCUMENT_LAUNCH_NONE:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> ActivityInfo.DOCUMENT_LAUNCH_INTO_EXISTING:</div><div class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_DOCUMENT;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> ActivityInfo.DOCUMENT_LAUNCH_ALWAYS:</div><div class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_DOCUMENT;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> ActivityInfo.DOCUMENT_LAUNCH_NEVER:</div><div class="line">                launchFlags &amp;= ~Intent.FLAG_ACTIVITY_MULTIPLE_TASK;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 是否为后台启动任务的标志位</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchTaskBehind = r.mLaunchTaskBehind</div><div class="line">            &amp;&amp; !launchSingleTask &amp;&amp; !launchSingleInstance</div><div class="line">            &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_DOCUMENT) != <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span> &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span></div><div class="line">            &amp;&amp; r.resultTo.task.stack != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 如果需要返回结果，但是此时的launchFlags有FLAG_ACTIVITY_NEW_TASK，则取消返回结果</span></div><div class="line">        r.resultTo.task.stack.sendActivityResultLocked(-<span class="number">1</span>,</div><div class="line">                r.resultTo, r.resultWho, r.requestCode,</div><div class="line">                Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">        r.resultTo = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_DOCUMENT) != <span class="number">0</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 赋予FLAG_ACTIVITY_NEW_TASK标志</span></div><div class="line">        launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 如果设置了android:documentLaunchMode为always，那么设置FLAG_ACTIVITY_MULTIPLE_TASK标志</span></div><div class="line">        <span class="comment">// 即使在其他task里面有该Activity以及启动，仍然新建Task再次启动一个Activity</span></div><div class="line">        <span class="keyword">if</span> (launchTaskBehind</div><div class="line">                || r.info.documentLaunchMode == ActivityInfo.DOCUMENT_LAUNCH_ALWAYS) &#123;</div><div class="line">            launchFlags |= Intent.FLAG_ACTIVITY_MULTIPLE_TASK;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 判断一下是否是用户的行为，比如用户按下Home键等等</span></div><div class="line">    <span class="comment">// 如果是用户的行为的话Activity跳转的时候是要调用onUserLeaveHint()方法的</span></div><div class="line">    mUserLeaving = (launchFlags &amp; Intent.FLAG_ACTIVITY_NO_USER_ACTION) == <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 如果设置了不需要resume，那么设置延迟resume标志</span></div><div class="line">    <span class="keyword">if</span> (!doResume) &#123;</div><div class="line">        r.delayedResume = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// FLAG_ACTIVITY_PREVIOUS_IS_TOP标志来决定待启动Activity会不会被作为栈顶，</span></div><div class="line">    <span class="comment">// 如果调用者希望待启动的Activity马上销毁，就会使用该启动参数。</span></div><div class="line">    <span class="comment">// 通常情况下notTop为null</span></div><div class="line">    ActivityRecord notTop =</div><div class="line">            (launchFlags &amp; Intent.FLAG_ACTIVITY_PREVIOUS_IS_TOP) != <span class="number">0</span> ? r : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">        ActivityRecord checkedCaller = sourceRecord;</div><div class="line">        <span class="keyword">if</span> (checkedCaller == <span class="keyword">null</span>) &#123;</div><div class="line">            checkedCaller = mFocusedStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!checkedCaller.realActivity.equals(r.realActivity)) &#123;</div><div class="line">            <span class="comment">// 如果调用者和被调用者不是同一个Activity，去掉这个标志，因为这个时候都需要启动</span></div><div class="line">            startFlags &amp;= ~ActivityManager.START_FLAG_ONLY_IF_NEEDED;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> addingToTask = <span class="keyword">false</span>;<span class="comment">//表示是否需要在inTask中启动activity</span></div><div class="line">    TaskRecord reuseTask = <span class="keyword">null</span>;<span class="comment">//表示可以复用的task</span></div><div class="line">    <span class="comment">//当调用者不是来自activity，而是明确指定task的情况。</span></div><div class="line">    <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> &amp;&amp; inTask != <span class="keyword">null</span> &amp;&amp; inTask.stack != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> Intent baseIntent = inTask.getBaseIntent();</div><div class="line">        <span class="keyword">final</span> ActivityRecord root = inTask.getRootActivity();</div><div class="line">        </div><div class="line">        ……</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 如果inTask是个空的task，从baseIntent里面挑选出一些flag设置到launchFlags</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flagsOfInterest = Intent.FLAG_ACTIVITY_NEW_TASK</div><div class="line">                    | Intent.FLAG_ACTIVITY_MULTIPLE_TASK | Intent.FLAG_ACTIVITY_NEW_DOCUMENT</div><div class="line">                    | Intent.FLAG_ACTIVITY_RETAIN_IN_RECENTS;</div><div class="line">            launchFlags = (launchFlags&amp;~flagsOfInterest)</div><div class="line">                    | (baseIntent.getFlags()&amp;flagsOfInterest);</div><div class="line">            intent.setFlags(launchFlags);</div><div class="line">            inTask.setIntent(r);</div><div class="line">            addingToTask = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 如果inTask非空，launchFlags要求在新task里面启动那么就不加入到这个task里面去</span></div><div class="line">            addingToTask = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 其他情况就加入到inTask</span></div><div class="line">            addingToTask = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 如果inTask不为空，就作为复用的task</span></div><div class="line">        reuseTask = inTask;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        inTask = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (inTask == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 当没有指定task</span></div><div class="line">        <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 调用者不是一个activity，那么就在一个新的task里面启动activity</span></div><div class="line">            <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span> &amp;&amp; inTask == <span class="keyword">null</span>) &#123;</div><div class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;</div><div class="line">            <span class="comment">// 如果调用者是一个activity，而且调用者的启动模式是LAUNCH_SINGLE_INSTANCE，</span></div><div class="line">            <span class="comment">// 那么也需要在新的task里面启动</span></div><div class="line">            launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (launchSingleInstance || launchSingleTask) &#123;</div><div class="line">            <span class="comment">// 启动标志位里面是SingleInstance或者launchSingleTask，也需要在新task里面启动</span></div><div class="line">            launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ActivityInfo newTaskInfo = <span class="keyword">null</span>;</div><div class="line">    Intent newTaskIntent = <span class="keyword">null</span>;</div><div class="line">    ActivityStack sourceStack;</div><div class="line">    <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (sourceRecord.finishing) &#123;</div><div class="line">            <span class="comment">// 如果调用者activity处于正在销毁的状态，那么就需要在新的task里启动</span></div><div class="line">            <span class="comment">// 并且保存一些调用者的信息，并把sourceRecord和sourceStack置空</span></div><div class="line">            <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span>) &#123;</div><div class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">                newTaskInfo = sourceRecord.info;</div><div class="line">                newTaskIntent = sourceRecord.task.intent;</div><div class="line">            &#125;</div><div class="line">            sourceRecord = <span class="keyword">null</span>;</div><div class="line">            sourceStack = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 如果不在销毁状态，把其所在的栈赋于sourceStack</span></div><div class="line">            sourceStack = sourceRecord.task.stack;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        sourceStack = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> movedHome = <span class="keyword">false</span>;</div><div class="line">    ActivityStack targetStack;</div><div class="line">    <span class="comment">// 至此，启动参数的修正工作结束，设置给intent</span></div><div class="line">    intent.setFlags(launchFlags);</div><div class="line">    <span class="comment">// 看是否需要动画</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> noAnimation = (launchFlags &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">// FLAG_ACTIVITY_NEW_TASK &amp;&amp; FLAG_ACTIVITY_MULTIPLE_TASK 表示不是在当前任务中启动，</span></div><div class="line">    <span class="comment">// 但是要查看是否有目标Activity已经存在的任务，同launchSingleInstance和launchSingleTask</span></div><div class="line">    <span class="keyword">if</span> (((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</div><div class="line">            (launchFlags &amp; Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</div><div class="line">            || launchSingleInstance || launchSingleTask) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (inTask == <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 在没有指定task且不要返回结果的情况下，去查找是否有匹配的activity</span></div><div class="line">            <span class="comment">// findTaskLocked是找到匹配的目标ActivityRecord所在的任务栈(TaskRecord)，包含taskAffinity的操作</span></div><div class="line">            <span class="comment">// 这个方法后面会详细介绍</span></div><div class="line">            <span class="comment">// 从栈顶至栈底遍历ActivityStack中的所有Activity，根据Intent和ActivityInfo这</span></div><div class="line">            <span class="comment">// 两个参数得到的Activity的包名</span></div><div class="line">            ActivityRecord intentActivity = !launchSingleInstance ?</div><div class="line">                    findTaskLocked(r) : findActivityLocked(intent, r.info);</div><div class="line">            <span class="keyword">if</span> (intentActivity != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// intentActivity不为空表示找到目标activity，那么目标Activity所在的任务(TaskRecord)</span></div><div class="line">                <span class="comment">// 和任务所在的栈(ActivityRecord)就是宿主任务和宿主栈</span></div><div class="line">                <span class="comment">// 这里通过isLockTaskModeViolation锁定屏幕的那些Task</span></div><div class="line">                <span class="keyword">if</span> (isLockTaskModeViolation(intentActivity.task,</div><div class="line">                        (launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">                        == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))) &#123;</div><div class="line">                    <span class="comment">// 如果不是锁定的task，就结束启动流程</span></div><div class="line">                    <span class="comment">// lock task mode 是Android 5.0 Lollipop添加的功能</span></div><div class="line">                    showLockTaskToast();</div><div class="line">                    <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (r.task == <span class="keyword">null</span>) &#123;</div><div class="line">                    r.task = intentActivity.task;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (intentActivity.task.intent == <span class="keyword">null</span>) &#123;</div><div class="line">                    intentActivity.task.setIntent(r);</div><div class="line">                &#125;</div><div class="line">                targetStack = intentActivity.task.stack;</div><div class="line">                targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                <span class="comment">// 如果目标task不在前台就需要把它移至前台</span></div><div class="line">                <span class="comment">// 这里首先获取焦点所在的栈</span></div><div class="line">                <span class="keyword">final</span> ActivityStack focusStack = getFocusedStack();</div><div class="line">                <span class="comment">//从焦点栈里面找到当前可见的ActivityRecord</span></div><div class="line">                ActivityRecord curTop = (focusStack == <span class="keyword">null</span>)</div><div class="line">                        ? <span class="keyword">null</span> : focusStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">                <span class="keyword">boolean</span> movedToFront = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (curTop != <span class="keyword">null</span> &amp;&amp; (curTop.task != intentActivity.task ||</div><div class="line">                        curTop.task != focusStack.topTask())) &#123;</div><div class="line">                    <span class="comment">// 满足上面的条件表示待启动的activity和当前可见activity不在同一个task</span></div><div class="line">                    <span class="comment">// 那么就需要将待启动的activity所在的栈移动到前台</span></div><div class="line">                    r.intent.addFlags(Intent.FLAG_ACTIVITY_BROUGHT_TO_FRONT);</div><div class="line">                    <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> || (sourceStack.topActivity() != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                            sourceStack.topActivity().task == sourceRecord.task)) &#123;</div><div class="line">                        <span class="keyword">if</span> (launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">                            intentActivity.setTaskToAffiliateWith(sourceRecord.task);</div><div class="line">                        &#125;</div><div class="line">                        movedHome = <span class="keyword">true</span>;</div><div class="line">                        <span class="comment">// 将目标任务移动到栈顶</span></div><div class="line">                        targetStack.moveTaskToFrontLocked(intentActivity.task, noAnimation,</div><div class="line">                                options, r.appTimeTracker, <span class="string">"bringingFoundTaskToFront"</span>);</div><div class="line">                        movedToFront = <span class="keyword">true</span>;</div><div class="line">                        <span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">                                (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">                                == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">                            <span class="comment">//将toReturnTo设置为home</span></div><div class="line">                            intentActivity.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">                        &#125;</div><div class="line">                        options = <span class="keyword">null</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">                    <span class="comment">// 将当前栈移动到前台</span></div><div class="line">                    targetStack.moveToFront(<span class="string">"intentActivityFound"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 根据需要重置activity所在的task</span></div><div class="line">                <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                    intentActivity = targetStack.resetTaskIfNeededLocked(intentActivity, r);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// 如果不需要启动一个新的activity，结束启动流程</span></div><div class="line">                    <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                        resumeTopActivitiesLocked(targetStack, <span class="keyword">null</span>, options);</div><div class="line">                        <span class="comment">// 如果没有移动到前台，通知Keyguard</span></div><div class="line">                        <span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">                            notifyActivityDrawnForKeyguard();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        ActivityOptions.abort(options);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> ((launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">                        == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK)) &#123;</div><div class="line">                    <span class="comment">// 这里需要移除目标task中所有关联的其他activity，即要完全替代目标task</span></div><div class="line">                    <span class="comment">// 将该启动activity变为task中的根activity</span></div><div class="line">                    reuseTask = intentActivity.task;</div><div class="line">                    reuseTask.performClearTaskLocked();</div><div class="line">                    reuseTask.setIntent(r);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span></div><div class="line">                        || launchSingleInstance || launchSingleTask) &#123;</div><div class="line">                    <span class="comment">// 清除task中目标activity上面的所有activity，返回目标activity</span></div><div class="line">                    ActivityRecord top =</div><div class="line">                            intentActivity.task.performClearTaskLocked(r, launchFlags);</div><div class="line">                    <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (top.frontOfTask) &#123;</div><div class="line">                            top.task.setIntent(r);</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//触发调用onNewIntent()</span></div><div class="line">                        top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">// A special case: we need to start the activity because it is not</span></div><div class="line">                        <span class="comment">// currently running, and the caller has asked to clear the current</span></div><div class="line">                        <span class="comment">// task to have this activity at the top.</span></div><div class="line">                        addingToTask = <span class="keyword">true</span>;</div><div class="line">                        <span class="comment">// Now pretend like this activity is being started by the top of its</span></div><div class="line">                        <span class="comment">// task, so it is put in the right place.</span></div><div class="line">                        sourceRecord = intentActivity;</div><div class="line">                        TaskRecord task = sourceRecord.task;</div><div class="line">                        <span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; task.stack == <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="comment">// Target stack got cleared when we all activities were removed</span></div><div class="line">                            <span class="comment">// above. Go ahead and reset it.</span></div><div class="line">                            targetStack = computeStackFocus(sourceRecord, <span class="keyword">false</span> <span class="comment">/* newTask */</span>);</div><div class="line">                            targetStack.addTask(</div><div class="line">                                    task, !launchTaskBehind <span class="comment">/* toTop */</span>, <span class="keyword">false</span> <span class="comment">/* moving */</span>);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.realActivity.equals(intentActivity.task.realActivity)) &#123;</div><div class="line">                    <span class="comment">// In this case the top activity on the task is the</span></div><div class="line">                    <span class="comment">// same as the one being launched, so we take that</span></div><div class="line">                    <span class="comment">// as a request to bring the task to the foreground.</span></div><div class="line">                    <span class="comment">// If the top activity in the task is the root</span></div><div class="line">                    <span class="comment">// activity, deliver this new intent to it if it</span></div><div class="line">                    <span class="comment">// desires.</span></div><div class="line">                    <span class="keyword">if</span> (((launchFlags&amp;Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span> || launchSingleTop)</div><div class="line">                            &amp;&amp; intentActivity.realActivity.equals(r.realActivity)) &#123;</div><div class="line">                        ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r,</div><div class="line">                                intentActivity.task);</div><div class="line">                        <span class="keyword">if</span> (intentActivity.frontOfTask) &#123;</div><div class="line">                            intentActivity.task.setIntent(r);</div><div class="line">                        &#125;</div><div class="line">                        intentActivity.deliverNewIntentLocked(callingUid, r.intent,</div><div class="line">                                r.launchedFromPackage);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!r.intent.filterEquals(intentActivity.task.intent)) &#123;</div><div class="line">                        <span class="comment">// In this case we are launching the root activity</span></div><div class="line">                        <span class="comment">// of the task, but with a different intent.  We</span></div><div class="line">                        <span class="comment">// should start a new instance on top.</span></div><div class="line">                        addingToTask = <span class="keyword">true</span>;</div><div class="line">                        sourceRecord = intentActivity;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// In this case an activity is being launched in to an</span></div><div class="line">                    <span class="comment">// existing task, without resetting that task.  This</span></div><div class="line">                    <span class="comment">// is typically the situation of launching an activity</span></div><div class="line">                    <span class="comment">// from a notification or shortcut.  We want to place</span></div><div class="line">                    <span class="comment">// the new activity on top of the current task.</span></div><div class="line">                    addingToTask = <span class="keyword">true</span>;</div><div class="line">                    sourceRecord = intentActivity;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!intentActivity.task.rootWasReset) &#123;</div><div class="line">                    <span class="comment">// In this case we are launching in to an existing task</span></div><div class="line">                    <span class="comment">// that has not yet been started from its front door.</span></div><div class="line">                    <span class="comment">// The current task has been brought to the front.</span></div><div class="line">                    <span class="comment">// Ideally, we'd probably like to place this new task</span></div><div class="line">                    <span class="comment">// at the bottom of its stack, but that's a little hard</span></div><div class="line">                    <span class="comment">// to do with the current organization of the code so</span></div><div class="line">                    <span class="comment">// for now we'll just drop it.</span></div><div class="line">                    intentActivity.task.setIntent(r);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!addingToTask &amp;&amp; reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// 如果不需要加入指定的task，且不用复用task，那么直接把找到的目标activity推到前台</span></div><div class="line">                    <span class="comment">// 并结束启动流程</span></div><div class="line">                    <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                        targetStack.resumeTopActivityLocked(<span class="keyword">null</span>, options);</div><div class="line">                        <span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">                            notifyActivityDrawnForKeyguard();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        ActivityOptions.abort(options);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="comment">//end of (intentActivity != null)</span></div><div class="line">        &#125;<span class="comment">//end of (inTask == null &amp;&amp; r.resultTo == null)</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.packageName != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 待启动activity包名不为空</span></div><div class="line">        ActivityStack topStack = mFocusedStack;</div><div class="line">        ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">        <span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">                <span class="comment">// 待启动的activity和前台显示的activity是同一个activity的情况</span></div><div class="line">                <span class="keyword">if</span> (top.app != <span class="keyword">null</span> &amp;&amp; top.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">                        || launchSingleTop || launchSingleTask) &#123;</div><div class="line">                        ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top,</div><div class="line">                                top.task);</div><div class="line">                        topStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">                        <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                            resumeTopActivitiesLocked();</div><div class="line">                        &#125;</div><div class="line">                        ActivityOptions.abort(options);</div><div class="line">                        <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                            <span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">                        &#125;</div><div class="line">                        top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                        <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//如果目标activity包名为空，表示找不到待启动的activity，结束启动流程</span></div><div class="line">        <span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span> &amp;&amp; r.resultTo.task.stack != <span class="keyword">null</span>) &#123;</div><div class="line">            r.resultTo.task.stack.sendActivityResultLocked(-<span class="number">1</span>, r.resultTo, r.resultWho,</div><div class="line">                    r.requestCode, Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">return</span> ActivityManager.START_CLASS_NOT_FOUND;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>目标activity不存在的情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">// 接下来处理目标activity不存在的情况</span></div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> keepCurTransition = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    TaskRecord taskToAffiliate = launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span> ?</div><div class="line">            sourceRecord.task : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span> &amp;&amp; inTask == <span class="keyword">null</span> &amp;&amp; !addingToTask</div><div class="line">            &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 这种情况下要在一个新的task中启动activity</span></div><div class="line">        newTask = <span class="keyword">true</span>;</div><div class="line">        targetStack = computeStackFocus(r, newTask);</div><div class="line">        targetStack.moveToFront(<span class="string">"startingNewTask"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 如果没有可以复用的就新建一个</span></div><div class="line">            r.setTask(targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">                    newTaskInfo != <span class="keyword">null</span> ? newTaskInfo : r.info,</div><div class="line">                    newTaskIntent != <span class="keyword">null</span> ? newTaskIntent : intent,</div><div class="line">                    voiceSession, voiceInteractor, !launchTaskBehind <span class="comment">/* toTop */</span>),</div><div class="line">                    taskToAffiliate);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 复用task</span></div><div class="line">            r.setTask(reuseTask, taskToAffiliate);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isLockTaskModeViolation(r.task)) &#123;</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!movedHome) &#123;</div><div class="line">            <span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">                    (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">                    == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">                <span class="comment">// 把当前新启动的任务置于Home任务之上，也就是按back键从这个任务返回的时候</span></div><div class="line">                <span class="comment">// 会回到home，即使这个不是他们最后看见的activity</span></div><div class="line">                r.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 不用在新task中启动activity</span></div><div class="line">        <span class="keyword">final</span> TaskRecord sourceTask = sourceRecord.task;</div><div class="line">        <span class="keyword">if</span> (isLockTaskModeViolation(sourceTask)) &#123;</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 那么目标activity的栈也就是调用者所在的栈</span></div><div class="line">        targetStack = sourceTask.stack;</div><div class="line">        targetStack.moveToFront(<span class="string">"sourceStackToFront"</span>);</div><div class="line">        <span class="keyword">final</span> TaskRecord topTask = targetStack.topTask();</div><div class="line">        <span class="keyword">if</span> (topTask != sourceTask) &#123;</div><div class="line">            <span class="comment">// 移动task到前台</span></div><div class="line">            targetStack.moveTaskToFrontLocked(sourceTask, noAnimation, options,</div><div class="line">                    r.appTimeTracker, <span class="string">"sourceTaskToFront"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!addingToTask &amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 清除activity</span></div><div class="line">            ActivityRecord top = sourceTask.performClearTaskLocked(r, launchFlags);</div><div class="line">            keepCurTransition = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">                ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, top.task);</div><div class="line">                top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                    targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">                &#125;</div><div class="line">                ActivityOptions.abort(options);</div><div class="line">                <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!addingToTask &amp;&amp;</div><div class="line">                (launchFlags&amp;Intent.FLAG_ACTIVITY_REORDER_TO_FRONT) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">final</span> ActivityRecord top = sourceTask.findActivityInHistoryLocked(r);</div><div class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> TaskRecord task = top.task;</div><div class="line">                task.moveActivityToFrontLocked(top);</div><div class="line">                ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, task);</div><div class="line">                top.updateOptionsLocked(options);</div><div class="line">                top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                    targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        r.setTask(sourceTask, <span class="keyword">null</span>);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inTask != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 在指定的task中启动activity</span></div><div class="line">        <span class="keyword">if</span> (isLockTaskModeViolation(inTask)) &#123;</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">        &#125;</div><div class="line">        targetStack = inTask.stack;</div><div class="line">        targetStack.moveTaskToFrontLocked(inTask, noAnimation, options, r.appTimeTracker,</div><div class="line">                <span class="string">"inTaskToFront"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// check一下是在这个task中启动一个新的activity或者是复用当前栈顶的activity</span></div><div class="line">        ActivityRecord top = inTask.getTopActivity();</div><div class="line">        <span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">            <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">                    || launchSingleTop || launchSingleTask) &#123;</div><div class="line">                ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top, top.task);</div><div class="line">                <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">                &#125;</div><div class="line">                top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!addingToTask) &#123;</div><div class="line">            ActivityOptions.abort(options);</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        r.setTask(inTask, <span class="keyword">null</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 既不启动一个新的activity，也不在指定的task中启动</span></div><div class="line">        <span class="comment">// 目前不会走到这个分支中</span></div><div class="line">        targetStack = computeStackFocus(r, newTask);</div><div class="line">        targetStack.moveToFront(<span class="string">"addingToTopTask"</span>);</div><div class="line">        ActivityRecord prev = targetStack.topActivity();</div><div class="line">        r.setTask(prev != <span class="keyword">null</span> ? prev.task : targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">                        r.info, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">true</span>), <span class="keyword">null</span>);</div><div class="line">        mWindowManager.moveTaskToTop(r.task.taskId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</div><div class="line">            intent, r.getUriPermissionsLocked(), r.userId);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span> &amp;&amp; sourceRecord.isRecentsActivity()) &#123;</div><div class="line">        r.task.setTaskToReturnTo(RECENTS_ACTIVITY_TYPE);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (newTask) &#123;</div><div class="line">        EventLog.writeEvent(EventLogTags.AM_CREATE_TASK, r.userId, r.task.taskId);</div><div class="line">    &#125;</div><div class="line">    ActivityStack.logStartActivity(EventLogTags.AM_CREATE_ACTIVITY, r, r.task);</div><div class="line">    targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">// 进行下一步流程，启动activity</span></div><div class="line">    targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options);</div><div class="line">    <span class="keyword">if</span> (!launchTaskBehind) &#123;</div><div class="line">        <span class="comment">// 如果不是在后台启动就把焦点设置在当前activity</span></div><div class="line">        mService.setFocusedActivityLocked(r, <span class="string">"startedActivity"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到这个方法首先是修正了一些启动参数，接着根据目标Activity是否存在分别进行了处理，然后启动activity。</p>
<h4 id="ActivityStack-startActivityLocked"><a href="#ActivityStack-startActivityLocked" class="headerlink" title="ActivityStack.startActivityLocked()"></a>ActivityStack.startActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask,</span></span></div><div class="line">        <span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options) &#123;</div><div class="line">    TaskRecord rTask = r.task;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> taskId = rTask.taskId;</div><div class="line">    <span class="keyword">if</span> (!r.mLaunchTaskBehind &amp;&amp; (taskForIdLocked(taskId) == <span class="keyword">null</span> || newTask)) &#123;</div><div class="line">        <span class="comment">// 历史activity被清除了或者是明确要求在新的task启动activity</span></div><div class="line">        <span class="comment">// 将task插入stack栈顶</span></div><div class="line">        insertTaskAtTop(rTask, r);</div><div class="line">        <span class="comment">// 调用WindowManagerService </span></div><div class="line">        mWindowManager.moveTaskToTop(taskId);</div><div class="line">    &#125;</div><div class="line">    TaskRecord task = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (!newTask) &#123;</div><div class="line">        <span class="comment">// 在一个已经存在的task中启动activity</span></div><div class="line">        <span class="keyword">boolean</span> startIt = <span class="keyword">true</span>;<span class="comment">// 是否需要启动activity的标志位</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</div><div class="line">            task = mTaskHistory.get(taskNdx);</div><div class="line">            <span class="keyword">if</span> (task.getTopActivity() == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//  该task中已经没有activity了</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (task == r.task) &#123;</div><div class="line">                <span class="comment">// 匹配到目标task</span></div><div class="line">                <span class="keyword">if</span> (!startIt) &#123;</div><div class="line">                    <span class="comment">// 如果不需要启动，就先添加到栈顶</span></div><div class="line">                    task.addActivityToTop(r);</div><div class="line">                    r.putInHistory();</div><div class="line">                    <span class="comment">// 调用WindowManagerService 添加apptoken</span></div><div class="line">                    mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">                            r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">                            (r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>,</div><div class="line">                            r.userId, r.info.configChanges, task.voiceSession != <span class="keyword">null</span>,</div><div class="line">                            r.mLaunchTaskBehind);</div><div class="line">                    <span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</div><div class="line">                        validateAppTokensLocked();</div><div class="line">                    &#125;</div><div class="line">                    ActivityOptions.abort(options);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.numFullscreen &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// 如果在这个任务中有全屏显示的activity，就先不显示</span></div><div class="line">                startIt = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 走到这里已经把目标activity所在的task推到了stack的栈顶</span></div><div class="line"></div><div class="line">    <span class="comment">// 如果不需要在新的activity中启动，而且上面查到了目标task，且task在栈顶，就不需要调用onUserLeaving方法</span></div><div class="line">    <span class="keyword">if</span> (task == r.task &amp;&amp; mTaskHistory.indexOf(task) != (mTaskHistory.size() - <span class="number">1</span>)) &#123;</div><div class="line">        mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    task = r.task;</div><div class="line"></div><div class="line">    <span class="comment">// 将activity放到task的栈顶</span></div><div class="line">    task.addActivityToTop(r);</div><div class="line">    <span class="comment">// activity移动或者销毁之后调用setFrontOfTask方法</span></div><div class="line">    task.setFrontOfTask();</div><div class="line"></div><div class="line">    r.putInHistory();</div><div class="line">    <span class="keyword">if</span> (!isHomeStack() || numActivities() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 进入这个分支的条件当前stack不是桌面stack，也即当前是否是桌面。或者当前stack中已有task</span></div><div class="line"></div><div class="line">        <span class="comment">// 一些切换动画相关的操作</span></div><div class="line">        <span class="keyword">boolean</span> showStartingIcon = newTask;</div><div class="line">        ProcessRecord proc = r.app;</div><div class="line">        <span class="keyword">if</span> (proc == <span class="keyword">null</span>) &#123;</div><div class="line">            proc = mService.mProcessNames.get(r.processName, r.info.applicationInfo.uid);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.thread == <span class="keyword">null</span>) &#123;</div><div class="line">            showStartingIcon = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</div><div class="line">            mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, keepCurTransition);</div><div class="line">            mNoAnimActivities.add(r);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mWindowManager.prepareAppTransition(newTask</div><div class="line">                    ? r.mLaunchTaskBehind</div><div class="line">                            ? AppTransition.TRANSIT_TASK_OPEN_BEHIND</div><div class="line">                            : AppTransition.TRANSIT_TASK_OPEN</div><div class="line">                    : AppTransition.TRANSIT_ACTIVITY_OPEN, keepCurTransition);</div><div class="line">            mNoAnimActivities.remove(r);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 调用WindowManagerService 添加apptoken</span></div><div class="line">        mWindowManager.addAppToken(task.mActivities.indexOf(r),</div><div class="line">                r.appToken, r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">                (r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">                r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">        <span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</div><div class="line">        <span class="comment">// 一些显示StartingWindow的操作</span></div><div class="line">        <span class="keyword">if</span> (newTask) &#123;</div><div class="line">            <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                resetTaskIfNeededLocked(r, r);</div><div class="line">                doShow = topRunningNonDelayedActivityLocked(<span class="keyword">null</span>) == r;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options != <span class="keyword">null</span> &amp;&amp; <span class="keyword">new</span> ActivityOptions(options).getAnimationType()</div><div class="line">                == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</div><div class="line">            doShow = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</div><div class="line">            mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</div><div class="line">            ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</div><div class="line">            ActivityRecord prev = mResumedActivity;</div><div class="line">            <span class="comment">// prev 表示当前在resumed状态的activity</span></div><div class="line">            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// 如果它和目标activity不在同一个task</span></div><div class="line">                <span class="keyword">if</span> (prev.task != r.task) &#123;</div><div class="line">                    prev = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 在同一个task且已经显示</span></div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</div><div class="line">                    prev = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            mWindowManager.setAppStartingWindow(</div><div class="line">                    r.appToken, r.packageName, r.theme,</div><div class="line">                    mService.compatibilityInfoForPackageLocked(</div><div class="line">                            r.info.applicationInfo), r.nonLocalizedLabel,</div><div class="line">                    r.labelRes, r.icon, r.logo, r.windowFlags,</div><div class="line">                    prev != <span class="keyword">null</span> ? prev.appToken : <span class="keyword">null</span>, showStartingIcon);</div><div class="line">            r.mStartingWindowShown = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 进入这个分支条件：目标stack中还没有任何activity，那就不要做任何动画</span></div><div class="line">        <span class="comment">// 调用addAppToken绑定窗口</span></div><div class="line">        mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">                r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">                (r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">                r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        options = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</div><div class="line">        validateAppTokensLocked();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 显示activity</span></div><div class="line">    <span class="keyword">if</span> (doResume) &#123;</div><div class="line">        mStackSupervisor.resumeTopActivitiesLocked(<span class="keyword">this</span>, r, options);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-resumeTopActivitiesLocked"><a href="#ActivityStackSupervisor-resumeTopActivitiesLocked" class="headerlink" title="ActivityStackSupervisor.resumeTopActivitiesLocked()"></a>ActivityStackSupervisor.resumeTopActivitiesLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivitiesLocked</span><span class="params">(ActivityStack targetStack, ActivityRecord target,</span></span></div><div class="line">        Bundle targetOptions) &#123;</div><div class="line">    <span class="keyword">if</span> (targetStack == <span class="keyword">null</span>) &#123;</div><div class="line">        targetStack = mFocusedStack;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Do targetStack first.</span></div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (isFrontStack(targetStack)) &#123;</div><div class="line">        result = targetStack.resumeTopActivityLocked(target, targetOptions);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 遍历所有显示设备上的ActivityStack</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</div><div class="line">        <span class="keyword">final</span> ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</div><div class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</div><div class="line">            <span class="keyword">if</span> (stack == targetStack) &#123;</div><div class="line">                <span class="comment">// 上面已经处理过</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (isFrontStack(stack)) &#123;</div><div class="line">                <span class="comment">// 由其他显示设备进行处理</span></div><div class="line">                stack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityStack-resumeTopActivityLocked"><a href="#ActivityStack-resumeTopActivityLocked" class="headerlink" title="ActivityStack.resumeTopActivityLocked()"></a>ActivityStack.resumeTopActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</div><div class="line">        <span class="comment">// Don't even start recursing.</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 防止递归调用</span></div><div class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) &#123;</div><div class="line">            mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN;</div><div class="line">            mService.updateSleepIfNeededLocked();</div><div class="line">        &#125;</div><div class="line">        result = resumeTopActivityInnerLocked(prev, options);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityStack-resumeTopActivityInnerLocked"><a href="#ActivityStack-resumeTopActivityInnerLocked" class="headerlink" title="ActivityStack.resumeTopActivityInnerLocked()"></a>ActivityStack.resumeTopActivityInnerLocked()</h4><p>这里的参数 <code>prev</code> 表示待启动的 <code>ActivityRecord</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!mService.mBooting &amp;&amp; !mService.mBooted) &#123;</div><div class="line">        <span class="comment">// 如果系统还没有启动结束，这里结束启动流程</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ActivityRecord parent = mActivityContainer.mParentActivity;</div><div class="line">    <span class="keyword">if</span> ((parent != <span class="keyword">null</span> &amp;&amp; parent.state != ActivityState.RESUMED) ||</div><div class="line">            !mActivityContainer.isAttachedLocked()) &#123;</div><div class="line">        <span class="comment">// 如果存在ParentActivity且ParentActivity还没有resume，那么结束启动流程</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 在当前activity下面的activity如果有处于INITIALIZING而且正在做窗口动画</span></div><div class="line">    <span class="comment">// 那么就取消这些窗口动画</span></div><div class="line">    cancelInitializingActivities();</div><div class="line"></div><div class="line">    <span class="comment">// 找到当前栈顶正在运行的activity，一般表示将要显示的activity</span></div><div class="line">    <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> userLeaving = mStackSupervisor.mUserLeaving;</div><div class="line">    mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TaskRecord prevTask = prev != <span class="keyword">null</span> ? prev.task : <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 没有将要显示的activity</span></div><div class="line">        <span class="keyword">final</span> String reason = <span class="string">"noMoreActivities"</span>;</div><div class="line">        <span class="keyword">if</span> (!mFullscreen) &#123;</div><div class="line">            <span class="keyword">final</span> ActivityStack stack = getNextVisibleStackLocked();</div><div class="line">            <span class="keyword">if</span> (adjustFocusToNextVisibleStackLocked(stack, reason)) &#123;</div><div class="line">                <span class="keyword">return</span> mStackSupervisor.resumeTopActivitiesLocked(stack, prev, <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 显示桌面，结束启动流程</span></div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> returnTaskType = prevTask == <span class="keyword">null</span> || !prevTask.isOverHomeStack() ?</div><div class="line">                HOME_ACTIVITY_TYPE : prevTask.getTaskToReturnTo();</div><div class="line">        <span class="keyword">return</span> isOnHomeDisplay() &amp;&amp;</div><div class="line">                mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, reason);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    next.delayedResume = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</div><div class="line">                mStackSupervisor.allResumedActivitiesComplete()) &#123;</div><div class="line">        <span class="comment">// 当前正在显示的activity就是下一个将要显示的activity，那么结束启动流程</span></div><div class="line">        mWindowManager.executeAppTransition();</div><div class="line">        mNoAnimActivities.clear();</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TaskRecord nextTask = next.task;</div><div class="line">    <span class="keyword">if</span> (prevTask != <span class="keyword">null</span> &amp;&amp; prevTask.stack == <span class="keyword">this</span> &amp;&amp;</div><div class="line">            prevTask.isOverHomeStack() &amp;&amp; prev.finishing &amp;&amp; prev.frontOfTask) &#123;</div><div class="line">        <span class="keyword">if</span> (prevTask == nextTask) &#123;</div><div class="line">            prevTask.setFrontOfTask();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevTask != topTask()) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> taskNdx = mTaskHistory.indexOf(prevTask) + <span class="number">1</span>;</div><div class="line">            mTaskHistory.get(taskNdx).setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isOnHomeDisplay()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isHomeStack())&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> returnTaskType = prevTask == <span class="keyword">null</span> || !prevTask.isOverHomeStack() ?</div><div class="line">                    HOME_ACTIVITY_TYPE : prevTask.getTaskToReturnTo();</div><div class="line">            <span class="keyword">return</span> isOnHomeDisplay() &amp;&amp;</div><div class="line">                    mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, <span class="string">"prevFinished"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 如果系统在休眠状态且栈顶activity在pause状态，结束启动流程</span></div><div class="line">    <span class="keyword">if</span> (mService.isSleepingOrShuttingDown()</div><div class="line">            &amp;&amp; mLastPausedActivity == next</div><div class="line">            &amp;&amp; mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">        mWindowManager.executeAppTransition();</div><div class="line">        mNoAnimActivities.clear();</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 找不到待启动activity的user，结束启动流程</span></div><div class="line">    <span class="keyword">if</span> (mService.mStartedUsers.get(next.userId) == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 从Stopping状态进入休眠状态和待显示状态列表中删除待启动activity</span></div><div class="line">    <span class="comment">// 待启动activity有可能处于这些数组中</span></div><div class="line">    mStackSupervisor.mStoppingActivities.remove(next);</div><div class="line">    mStackSupervisor.mGoingToSleepActivities.remove(next);</div><div class="line">    next.sleeping = <span class="keyword">false</span>;</div><div class="line">    mStackSupervisor.mWaitingVisibleActivities.remove(next);</div><div class="line"></div><div class="line">    <span class="comment">// 如果当前正在pause一些activity，那么就要把这些工作做完</span></div><div class="line">    <span class="comment">// 这种情况下也会结束启动流程</span></div><div class="line">    <span class="keyword">if</span> (!mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>接下来就开始进行一些activity的切换工作，首先要pause当前activity，将待显示的activity进行resume。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">// 设置WakeLock，保证在启动过程中系统不会休眠</span></div><div class="line">    mStackSupervisor.setLaunchSource(next.info.applicationInfo.uid);</div><div class="line"></div><div class="line">    <span class="comment">// 开始把当前activity进入pause状态，这样才能把待显示activity进入resume状态</span></div><div class="line">    <span class="comment">// 如果启动参数里面有FLAG_RESUME_WHILE_PAUSING，表示当前的activity正在pause时，可以执行待显示</span></div><div class="line">    <span class="comment">// activity的resume动作</span></div><div class="line">    <span class="keyword">boolean</span> dontWaitForPause = (next.info.flags&amp;ActivityInfo.FLAG_RESUME_WHILE_PAUSING) != <span class="number">0</span>;</div><div class="line">    <span class="comment">// 开始pause stack里面的activity</span></div><div class="line">    <span class="keyword">boolean</span> pausing = mStackSupervisor.pauseBackStacks(userLeaving, <span class="keyword">true</span>, dontWaitForPause);</div><div class="line">    <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 把当前正在显示的activity进入pasue状态</span></div><div class="line">        pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, <span class="keyword">true</span>, dontWaitForPause);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (pausing) &#123;</div><div class="line">        <span class="comment">// pausing为true表示当前有正在pause的activity，那么这里先返回，等完全pause再执行后面的操作</span></div><div class="line">        <span class="comment">// 一般第一次会走这里，但是在startPausingLocked中发送的消息执行以后还会再次执行这个函数</span></div><div class="line">        <span class="comment">// ActivityStack.activityPausedLocked-&gt;ActivityStack.completePauseLocked-&gt;</span></div><div class="line">        <span class="comment">// ActivityStackSupervisor.resumeTopActivitiesLocked-&gt;ActivityStack.resumeTopActivityLocked()</span></div><div class="line">        <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">            mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mService.isSleeping() &amp;&amp; mLastNoHistoryActivity != <span class="keyword">null</span> &amp;&amp;</div><div class="line">            !mLastNoHistoryActivity.finishing) &#123;</div><div class="line">        requestFinishActivityLocked(mLastNoHistoryActivity.appToken, Activity.RESULT_CANCELED,</div><div class="line">                <span class="keyword">null</span>, <span class="string">"resume-no-history"</span>, <span class="keyword">false</span>);</div><div class="line">        mLastNoHistoryActivity = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span> &amp;&amp; prev != next) &#123;</div><div class="line">        <span class="keyword">if</span> (!mStackSupervisor.mWaitingVisibleActivities.contains(prev)</div><div class="line">                &amp;&amp; next != <span class="keyword">null</span> &amp;&amp; !next.nowVisible) &#123;</div><div class="line">            mStackSupervisor.mWaitingVisibleActivities.add(prev);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (prev.finishing) &#123;</div><div class="line">                mWindowManager.setAppVisibility(prev.appToken, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        AppGlobals.getPackageManager().setPackageStoppedState(</div><div class="line">                next.packageName, <span class="keyword">false</span>, next.userId); <span class="comment">/* <span class="doctag">TODO:</span> Verify if correct userid */</span></div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e1) &#123;</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> anim = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (prev.finishing) &#123;</div><div class="line">            <span class="keyword">if</span> (mNoAnimActivities.contains(prev)) &#123;</div><div class="line">                anim = <span class="keyword">false</span>;</div><div class="line">                mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mWindowManager.prepareAppTransition(prev.task == next.task</div><div class="line">                        ? AppTransition.TRANSIT_ACTIVITY_CLOSE</div><div class="line">                        : AppTransition.TRANSIT_TASK_CLOSE, <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            mWindowManager.setAppWillBeHidden(prev.appToken);</div><div class="line">            mWindowManager.setAppVisibility(prev.appToken, <span class="keyword">false</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION,</div><div class="line">                    <span class="string">"Prepare open transition: prev="</span> + prev);</div><div class="line">            <span class="keyword">if</span> (mNoAnimActivities.contains(next)) &#123;</div><div class="line">                anim = <span class="keyword">false</span>;</div><div class="line">                mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mWindowManager.prepareAppTransition(prev.task == next.task</div><div class="line">                        ? AppTransition.TRANSIT_ACTIVITY_OPEN</div><div class="line">                        : next.mLaunchTaskBehind</div><div class="line">                                ? AppTransition.TRANSIT_TASK_OPEN_BEHIND</div><div class="line">                                : AppTransition.TRANSIT_TASK_OPEN, <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">            mWindowManager.setAppWillBeHidden(prev.appToken);</div><div class="line">            mWindowManager.setAppVisibility(prev.appToken, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mNoAnimActivities.contains(next)) &#123;</div><div class="line">            anim = <span class="keyword">false</span>;</div><div class="line">            mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, <span class="keyword">false</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mWindowManager.prepareAppTransition(AppTransition.TRANSIT_ACTIVITY_OPEN, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Bundle resumeAnimOptions = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (anim) &#123;</div><div class="line">        ActivityOptions opts = next.getOptionsForTargetActivityLocked();</div><div class="line">        <span class="keyword">if</span> (opts != <span class="keyword">null</span>) &#123;</div><div class="line">            resumeAnimOptions = opts.toBundle();</div><div class="line">        &#125;</div><div class="line">        next.applyOptionsLocked();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        next.clearOptionsLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ActivityStack lastStack = mStackSupervisor.getLastStack();</div><div class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 走到这个分支说明待启动activity所在的进程已经存在了？</span></div><div class="line">        mWindowManager.setAppVisibility(next.appToken, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// schedule launch ticks to collect information about slow apps.</span></div><div class="line">        next.startLaunchTickingLocked();</div><div class="line"></div><div class="line">        ActivityRecord lastResumedActivity =</div><div class="line">                lastStack == <span class="keyword">null</span> ? <span class="keyword">null</span> :lastStack.mResumedActivity;</div><div class="line">        ActivityState lastState = next.state;</div><div class="line"></div><div class="line">        mService.updateCpuStats();</div><div class="line">        <span class="comment">// 待启动activity状态已经是RESUMED</span></div><div class="line">        next.state = ActivityState.RESUMED;</div><div class="line">        mResumedActivity = next;</div><div class="line">        next.task.touchActiveTime();</div><div class="line">        mRecentTasks.addLocked(next.task);</div><div class="line">        mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">        updateLRUListLocked(next);</div><div class="line">        mService.updateOomAdjLocked();</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> notUpdated = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (mStackSupervisor.isFrontStack(<span class="keyword">this</span>)) &#123;</div><div class="line">            Configuration config = mWindowManager.updateOrientationFromAppTokens(</div><div class="line">                    mService.mConfiguration,</div><div class="line">                    next.mayFreezeScreenLocked(next.app) ? next.appToken : <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</div><div class="line">                next.frozenBeforeDestroy = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            notUpdated = !mService.updateConfigurationLocked(config, next, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (notUpdated) &#123;</div><div class="line">            ActivityRecord nextNext = topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span> (nextNext != next) &#123;</div><div class="line">                mStackSupervisor.scheduleResumeTopActivities();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mStackSupervisor.reportResumedActivityLocked(next)) &#123;</div><div class="line">                mNoAnimActivities.clear();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ArrayList&lt;ResultInfo&gt; a = next.results;</div><div class="line">            <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = a.size();</div><div class="line">                <span class="keyword">if</span> (!next.finishing &amp;&amp; N &gt; <span class="number">0</span>) &#123;</div><div class="line">                    next.app.thread.scheduleSendResult(next.appToken, a);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (next.newIntents != <span class="keyword">null</span>) &#123;</div><div class="line">                next.app.thread.scheduleNewIntent(next.newIntents, next.appToken);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            EventLog.writeEvent(EventLogTags.AM_RESUME_ACTIVITY, next.userId,</div><div class="line">                    System.identityHashCode(next), next.task.taskId, next.shortComponentName);</div><div class="line"></div><div class="line">            next.sleeping = <span class="keyword">false</span>;</div><div class="line">            mService.showAskCompatModeDialogLocked(next);</div><div class="line">            next.app.pendingUiClean = <span class="keyword">true</span>;</div><div class="line">            next.app.forceProcessStateUpTo(mService.mTopProcessState);</div><div class="line">            next.clearOptionsLocked();</div><div class="line">            next.app.thread.scheduleResumeActivity(next.appToken, next.app.repProcState,</div><div class="line">                    mService.isNextTransitionForward(), resumeAnimOptions);</div><div class="line"></div><div class="line">            mStackSupervisor.checkReadyForSleepLocked();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="comment">// Whoops, need to restart this activity!</span></div><div class="line">            next.state = lastState;</div><div class="line">            <span class="keyword">if</span> (lastStack != <span class="keyword">null</span>) &#123;</div><div class="line">                lastStack.mResumedActivity = lastResumedActivity;</div><div class="line">            &#125;</div><div class="line">            Slog.i(TAG, <span class="string">"Restarting because process died: "</span> + next);</div><div class="line">            <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</div><div class="line">                next.hasBeenLaunched = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span>  <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; lastStack != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                    mStackSupervisor.isFrontStack(lastStack)) &#123;</div><div class="line">                mWindowManager.setAppStartingWindow(</div><div class="line">                        next.appToken, next.packageName, next.theme,</div><div class="line">                        mService.compatibilityInfoForPackageLocked(next.info.applicationInfo),</div><div class="line">                        next.nonLocalizedLabel, next.labelRes, next.icon, next.logo,</div><div class="line">                        next.windowFlags, <span class="keyword">null</span>, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">            mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            next.visible = <span class="keyword">true</span>;</div><div class="line">            completeResumeLocked(next);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            requestFinishActivityLocked(next.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</div><div class="line">                    <span class="string">"resume-exception"</span>, <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        next.stopped = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 走到这个分支说明待启动activity所在的进程没有指定</span></div><div class="line">        <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</div><div class="line">            next.hasBeenLaunched = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW) &#123;</div><div class="line">                mWindowManager.setAppStartingWindow(</div><div class="line">                        next.appToken, next.packageName, next.theme,</div><div class="line">                        mService.compatibilityInfoForPackageLocked(</div><div class="line">                                next.info.applicationInfo),</div><div class="line">                        next.nonLocalizedLabel,</div><div class="line">                        next.labelRes, next.icon, next.logo, next.windowFlags,</div><div class="line">                        <span class="keyword">null</span>, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此方法中把待启动activity推到栈顶，并把activity的状态置为resume状态。</p>
<h4 id="ActivityStackSupervisor-startSpecificActivityLocked"><a href="#ActivityStackSupervisor-startSpecificActivityLocked" class="headerlink" title="ActivityStackSupervisor.startSpecificActivityLocked()"></a>ActivityStackSupervisor.startSpecificActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></div><div class="line">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig) &#123;</div><div class="line">    <span class="comment">// 这里获取一下activity所运行的进程</span></div><div class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</div><div class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    r.task.stack.setLaunchTime(r);</div><div class="line">    <span class="comment">// 这里会走两个分支，一个是进程已经存在，一个是不存在</span></div><div class="line">    <span class="comment">// 已经存在进程的case下面走的流程已经包含在创建进程case的流程里面</span></div><div class="line">    <span class="comment">// 这里就不再单独介绍</span></div><div class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></div><div class="line">                    || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</div><div class="line">                app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</div><div class="line">                        mService.mProcessStats);</div><div class="line">            &#125;</div><div class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;&#125;</div><div class="line"></div><div class="line">        <span class="comment">// 如果抛出异常，那么重启发起启动activity进程</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//启动一个新进程</span></div><div class="line">    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</div><div class="line">            <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="AMS中启动新进程"><a href="#AMS中启动新进程" class="headerlink" title="AMS中启动新进程"></a>AMS中启动新进程</h3><h4 id="ActivityManagerService-startProcessLocked"><a href="#ActivityManagerService-startProcessLocked" class="headerlink" title="ActivityManagerService.startProcessLocked()"></a>ActivityManagerService.startProcessLocked()</h4><p>这里先介绍一些什么是bad进程：如果一个进程在一分钟内crash两次，那么就会被认为是bad进程而被添加到<code>mBadProcesses</code>列表，<code>BadProcessInfo</code>里面保存了添加的时间。如果如果用户重新启动进程，那么就把该进程重列表中删除，直到下次crash时。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info,</span></span></div><div class="line">        <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, String hostingType, ComponentName hostingName,</div><div class="line">        <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid, <span class="keyword">boolean</span> keepIfLarge,</div><div class="line">        String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler) &#123;</div><div class="line">    <span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</div><div class="line">    ProcessRecord app;</div><div class="line">    <span class="comment">// 代表是否是完全隔绝的沙箱进程，完全隔绝的沙箱进程每次启动都是独立的，不能复用已有的进程信息。</span></div><div class="line">    <span class="keyword">if</span> (!isolated) &#123;</div><div class="line">        app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: after getProcessRecord"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((intentFlags &amp; Intent.FLAG_FROM_BACKGROUND) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 如果是后台进程要判断一下是否是bad进程，如果是bad进程，直接退出</span></div><div class="line">            <span class="keyword">if</span> (mBadProcesses.get(info.processName, info.uid) != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 如果是前台启动，清除bad进程标志</span></div><div class="line">            mProcessCrashTimes.remove(info.processName, info.uid);</div><div class="line">            <span class="keyword">if</span> (mBadProcesses.get(info.processName, info.uid) != <span class="keyword">null</span>) &#123;</div><div class="line">                EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,</div><div class="line">                        UserHandle.getUserId(info.uid), info.uid,</div><div class="line">                        info.processName);</div><div class="line">                mBadProcesses.remove(info.processName, info.uid);</div><div class="line">                <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</div><div class="line">                    app.bad = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 如果是完全隔绝的沙箱进程，那么就不能复用一些已经存在的进程的信息。</span></div><div class="line">        app = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span>(ActivityManagerService.<span class="keyword">this</span>) &#123;</div><div class="line">        nativeMigrateToBoost();</div><div class="line">        mIsBoosted = <span class="keyword">true</span>;</div><div class="line">        mBoostStartTime = SystemClock.uptimeMillis();</div><div class="line">        Message msg = mHandler.obtainMessage(APP_BOOST_DEACTIVATE_MSG);</div><div class="line">        mHandler.sendMessageDelayed(msg, APP_BOOST_MESSAGE_DELAY);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ProcessRecord已经存在，且已经分配了pid</span></div><div class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!knownToBeDead || app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 调用者不认为该进程已死亡或者没有thread对象attached到该进程.则不应该清理该进程</span></div><div class="line">            app.addPackage(info.packageName, info.versionCode, mProcessStats);</div><div class="line">            checkTime(startTime, <span class="string">"startProcess: done, added package to proc"</span>);</div><div class="line">            <span class="keyword">return</span> app;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 有thread实例attach到该进程，那么杀死并清理该进程</span></div><div class="line">        checkTime(startTime, <span class="string">"startProcess: bad proc running, killing"</span>);</div><div class="line">        killProcessGroup(app.info.uid, app.pid);</div><div class="line">        handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: done killing old proc"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String hostingNameStr = hostingName != <span class="keyword">null</span></div><div class="line">            ? hostingName.flattenToShortString() : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: creating new process record"</span>);</div><div class="line">        <span class="comment">// 创建新的ProcessRecord对象</span></div><div class="line">        app = newProcessRecordLocked(info, processName, isolated, isolatedUid);</div><div class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 创建失败</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        app.crashHandler = crashHandler;</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: done creating new process record"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//如果这是进程中新package，则添加到列表</span></div><div class="line">        app.addPackage(info.packageName, info.versionCode, mProcessStats);</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: added package to existing proc"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//当系统未准备完毕，则将当前进程加入到mProcessesOnHold</span></div><div class="line">    <span class="keyword">if</span> (!mProcessesReady</div><div class="line">            &amp;&amp; !isAllowedWhileBooting(info)</div><div class="line">            &amp;&amp; !allowWhileBooting) &#123;</div><div class="line">        <span class="keyword">if</span> (!mProcessesOnHold.contains(app)) &#123;</div><div class="line">            mProcessesOnHold.add(app);</div><div class="line">        &#125;</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: returning with proc on hold"</span>);</div><div class="line">        <span class="keyword">return</span> app;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    checkTime(startTime, <span class="string">"startProcess: stepping in to startProcess"</span>);</div><div class="line">    <span class="comment">// 启动进程</span></div><div class="line">    startProcessLocked(</div><div class="line">            app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: done starting proc!"</span>);</div><div class="line">    <span class="keyword">return</span> (app.pid != <span class="number">0</span>) ? app : <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityManagerService-newProcessRecordLocked"><a href="#ActivityManagerService-newProcessRecordLocked" class="headerlink" title="ActivityManagerService.newProcessRecordLocked()"></a>ActivityManagerService.newProcessRecordLocked()</h4><p>创建新的ProcessRecord对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess,</span></span></div><div class="line">        <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid) &#123;</div><div class="line">    String proc = customProcess != <span class="keyword">null</span> ? customProcess : info.processName;</div><div class="line">    <span class="comment">// 电量统计</span></div><div class="line">    BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(info.uid);</div><div class="line">    <span class="keyword">int</span> uid = info.uid;</div><div class="line">    <span class="keyword">if</span> (isolated) &#123;</div><div class="line">        <span class="comment">// 隔离进程相关</span></div><div class="line">        ......</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> ProcessRecord r = <span class="keyword">new</span> ProcessRecord(stats, info, proc, uid);</div><div class="line">    <span class="keyword">if</span> (!mBooted &amp;&amp; !mBooting</div><div class="line">            &amp;&amp; userId == UserHandle.USER_OWNER</div><div class="line">            &amp;&amp; (info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</div><div class="line">        r.persistent = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    addProcessNameLocked(r);</div><div class="line">    <span class="keyword">return</span> r;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityManagerService-startProcessLocked-1"><a href="#ActivityManagerService-startProcessLocked-1" class="headerlink" title="ActivityManagerService.startProcessLocked()"></a>ActivityManagerService.startProcessLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType,</span></span></div><div class="line">        String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs) &#123;</div><div class="line">    <span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</div><div class="line">    <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != MY_PID) &#123;</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: removing from pids map"</span>);</div><div class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</div><div class="line">            mPidsSelfLocked.remove(app.pid);</div><div class="line">            mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</div><div class="line">        &#125;</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: done removing from pids map"</span>);</div><div class="line">        app.setPid(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 从HoldProcesses列表中移除该ProcessRecord</span></div><div class="line">    mProcessesOnHold.remove(app);</div><div class="line"></div><div class="line">    checkTime(startTime, <span class="string">"startProcess: starting to update cpu stats"</span>);</div><div class="line">    updateCpuStats();</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: done updating cpu stats"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (AppGlobals.getPackageManager().isPackageFrozen(app.info.packageName)) &#123;</div><div class="line">                <span class="comment">// This is caught below as if we had failed to fork zygote</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Package "</span> + app.info.packageName + <span class="string">" is frozen!"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            <span class="keyword">throw</span> e.rethrowAsRuntimeException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> uid = app.uid;</div><div class="line">        <span class="keyword">int</span>[] gids = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</div><div class="line">        <span class="keyword">if</span> (!app.isolated) &#123;</div><div class="line">            <span class="keyword">int</span>[] permGids = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                checkTime(startTime, <span class="string">"startProcess: getting gids from package manager"</span>);</div><div class="line">                <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</div><div class="line">                permGids = pm.getPackageGids(app.info.packageName, app.userId);</div><div class="line">                MountServiceInternal mountServiceInternal = LocalServices.getService(</div><div class="line">                        MountServiceInternal.class);</div><div class="line">                mountExternal = mountServiceInternal.getExternalStorageMountMode(uid,</div><div class="line">                        app.info.packageName);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                <span class="keyword">throw</span> e.rethrowAsRuntimeException();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (ArrayUtils.isEmpty(permGids)) &#123;</div><div class="line">                gids = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                gids = <span class="keyword">new</span> <span class="keyword">int</span>[permGids.length + <span class="number">2</span>];</div><div class="line">                System.arraycopy(permGids, <span class="number">0</span>, gids, <span class="number">2</span>, permGids.length);</div><div class="line">            &#125;</div><div class="line">            gids[<span class="number">0</span>] = UserHandle.getSharedAppGid(UserHandle.getAppId(uid));</div><div class="line">            gids[<span class="number">1</span>] = UserHandle.getUserGid(UserHandle.getUserId(uid));</div><div class="line">        &#125;</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: building args"</span>);</div><div class="line">        <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_OFF) &#123;</div><div class="line">            <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</div><div class="line">                    &amp;&amp; mTopComponent != <span class="keyword">null</span></div><div class="line">                    &amp;&amp; app.processName.equals(mTopComponent.getPackageName())) &#123;</div><div class="line">                uid = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_HIGH_LEVEL</div><div class="line">                    &amp;&amp; (app.info.flags&amp;ApplicationInfo.FLAG_FACTORY_TEST) != <span class="number">0</span>) &#123;</div><div class="line">                uid = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 设置一些debug参数</span></div><div class="line">        <span class="keyword">int</span> debugFlags = <span class="number">0</span>;</div><div class="line">        ......</div><div class="line"></div><div class="line">        String requiredAbi = (abiOverride != <span class="keyword">null</span>) ? abiOverride : app.info.primaryCpuAbi;</div><div class="line">        <span class="keyword">if</span> (requiredAbi == <span class="keyword">null</span>) &#123;</div><div class="line">            requiredAbi = Build.SUPPORTED_ABIS[<span class="number">0</span>];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String instructionSet = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (app.info.primaryCpuAbi != <span class="keyword">null</span>) &#123;</div><div class="line">            instructionSet = VMRuntime.getInstructionSet(app.info.primaryCpuAbi);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        app.gids = gids;</div><div class="line">        app.requiredAbi = requiredAbi;</div><div class="line">        app.instructionSet = instructionSet;</div><div class="line"></div><div class="line">        <span class="comment">// 创建一个进程</span></div><div class="line">        <span class="keyword">boolean</span> isActivityProcess = (entryPoint == <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"Start proc: "</span> +</div><div class="line">                app.processName);</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: asking zygote to start proc"</span>);</div><div class="line">        Process.ProcessStartResult startResult = Process.start(entryPoint,</div><div class="line">                app.processName, uid, uid, gids, debugFlags, mountExternal,</div><div class="line">                app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</div><div class="line">                app.info.dataDir, entryPointArgs);</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: returned from zygote!"</span>);</div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (app.isolated) &#123;</div><div class="line">            mBatteryStatsService.addIsolatedUid(app.uid, app.info.uid);</div><div class="line">        &#125;</div><div class="line">        mBatteryStatsService.noteProcessStart(app.processName, app.info.uid);</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: done updating battery stats"</span>);</div><div class="line"></div><div class="line">        EventLog.writeEvent(EventLogTags.AM_PROC_START,</div><div class="line">                UserHandle.getUserId(uid), startResult.pid, uid,</div><div class="line">                app.processName, hostingType,</div><div class="line">                hostingNameStr != <span class="keyword">null</span> ? hostingNameStr : <span class="string">""</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (app.persistent) &#123;</div><div class="line">            Watchdog.getInstance().processStarted(app.processName, startResult.pid);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//设置一些属性变量</span></div><div class="line">        checkTime(startTime, <span class="string">"startProcess: building log message"</span>);</div><div class="line">        app.setPid(startResult.pid);</div><div class="line">        app.usingWrapper = startResult.usingWrapper;</div><div class="line">        app.removed = <span class="keyword">false</span>;</div><div class="line">        app.killed = <span class="keyword">false</span>;</div><div class="line">        app.killedByAm = <span class="keyword">false</span>;</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: starting to update pids map"</span>);</div><div class="line">        <span class="comment">//将新创建的进程加入到mPidsSelfLocked</span></div><div class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</div><div class="line">            <span class="keyword">this</span>.mPidsSelfLocked.put(startResult.pid, app);</div><div class="line">            <span class="keyword">if</span> (isActivityProcess) &#123;</div><div class="line">                Message msg = mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);</div><div class="line">                msg.obj = app;</div><div class="line">                mHandler.sendMessageDelayed(msg, startResult.usingWrapper</div><div class="line">                        ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        checkTime(startTime, <span class="string">"startProcess: done updating pids map"</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">        app.setPid(<span class="number">0</span>);</div><div class="line">        mBatteryStatsService.noteProcessFinish(app.processName, app.info.uid);</div><div class="line">        <span class="keyword">if</span> (app.isolated) &#123;</div><div class="line">            mBatteryStatsService.removeIsolatedUid(app.uid, app.info.uid);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="新进程"><a href="#新进程" class="headerlink" title="新进程"></a>新进程</h3><p><code>Process.start()</code> 通过socket通信告知Zygote创建fork子进程，创建新进程后将 <code>ActivityThread</code> 类加载到新进程，并调用 <code>ActivityThread.main()</code> 方法。</p>
<h4 id="ActivityThread-main"><a href="#ActivityThread-main" class="headerlink" title="ActivityThread.main()"></a>ActivityThread.main()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ActivityThreadMain"</span>);</div><div class="line">    <span class="comment">//启动性能统计</span></div><div class="line">    SamplingProfilerIntegration.start();</div><div class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">    Environment.initForCurrentUser();</div><div class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</div><div class="line">    AndroidKeyStoreProvider.install();</div><div class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</div><div class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</div><div class="line"></div><div class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</div><div class="line">    <span class="comment">// 初始化主线程消息队列</span></div><div class="line">    Looper.prepareMainLooper();</div><div class="line">    <span class="comment">// 创建ActivityThread对象</span></div><div class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</div><div class="line">    thread.attach(<span class="keyword">false</span>);</div><div class="line">    <span class="comment">// 主线程Handler对象mH</span></div><div class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</div><div class="line">        sMainThreadHandler = thread.getHandler();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">    <span class="comment">// 消息循环开始运行</span></div><div class="line">    Looper.loop();</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityThread-attach"><a href="#ActivityThread-attach" class="headerlink" title="ActivityThread.attach()"></a>ActivityThread.attach()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</div><div class="line">    sCurrentActivityThread = <span class="keyword">this</span>;</div><div class="line">    <span class="comment">// 是否是系统进程</span></div><div class="line">    mSystemThread = system;</div><div class="line">    <span class="keyword">if</span> (!system) &#123;</div><div class="line">        ViewRootImpl.addFirstDrawHandler(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                ensureJitEnabled();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="comment">// 暂时设置进程的名字为&lt;pre-initialized&gt;</span></div><div class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"&lt;pre-initialized&gt;"</span>,</div><div class="line">                                                UserHandle.myUserId());</div><div class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</div><div class="line">        <span class="comment">// 调用AMS</span></div><div class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mgr.attachApplication(mAppThread);</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;&#125;</div><div class="line">        <span class="comment">// GC检测</span></div><div class="line">        BinderInternal.addGcWatcher(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (!mSomeActivitiesChanged) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                Runtime runtime = Runtime.getRuntime();</div><div class="line">                <span class="keyword">long</span> dalvikMax = runtime.maxMemory();</div><div class="line">                <span class="keyword">long</span> dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</div><div class="line">                <span class="keyword">if</span> (dalvikUsed &gt; ((<span class="number">3</span>*dalvikMax)/<span class="number">4</span>)) &#123;</div><div class="line">                    <span class="comment">//当已用内存超过最大内存的3/4,则请求释放内存空间</span></div><div class="line">                    mSomeActivitiesChanged = <span class="keyword">false</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        mgr.releaseSomeActivities(mAppThread);</div><div class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 如果是系统进程，设置名称为system_process</span></div><div class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"system_process"</span>,</div><div class="line">                UserHandle.myUserId());</div><div class="line">        <span class="comment">// 初始化mInstrumentation和mInitialApplication</span></div><div class="line">        <span class="comment">// 非系统进程这些对象的初始化在handleBindApplication()中进行</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mInstrumentation = <span class="keyword">new</span> Instrumentation();</div><div class="line">            ContextImpl context = ContextImpl.createAppContext(</div><div class="line">                    <span class="keyword">this</span>, getSystemContext().mPackageInfo);</div><div class="line">            mInitialApplication = context.mPackageInfo.makeApplication(<span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">            mInitialApplication.onCreate();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    DropBox.setReporter(<span class="keyword">new</span> DropBoxReporter());</div><div class="line">    <span class="comment">// 这里要快速的设置Config回调</span></div><div class="line">    ViewRootImpl.addConfigCallback(<span class="keyword">new</span> ComponentCallbacks2() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</div><div class="line">            <span class="keyword">synchronized</span> (mResourcesManager) &#123;</div><div class="line">                <span class="comment">// 快速响应onConfigurationChanged</span></div><div class="line">                <span class="keyword">if</span> (mResourcesManager.applyConfigurationToResourcesLocked(newConfig, <span class="keyword">null</span>)) &#123;</div><div class="line">                    <span class="keyword">if</span> (mPendingConfiguration == <span class="keyword">null</span> ||</div><div class="line">                            mPendingConfiguration.isOtherSeqNewer(newConfig)) &#123;</div><div class="line">                        mPendingConfiguration = newConfig;</div><div class="line"></div><div class="line">                        sendMessage(H.CONFIGURATION_CHANGED, newConfig);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来又会转到 <code>ActivityManagerService</code> 进程去执行。</p>
<h4 id="ActivityManagerService-attachApplication"><a href="#ActivityManagerService-attachApplication" class="headerlink" title="ActivityManagerService.attachApplication()"></a>ActivityManagerService.attachApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">        <span class="comment">// thread是ApplicationThreadProxy对象，用于和应用进程的ApplicationThread通信</span></div><div class="line">        attachApplicationLocked(thread, callingPid);</div><div class="line">        Binder.restoreCallingIdentity(origId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityManagerService-attachApplicationLocked"><a href="#ActivityManagerService-attachApplicationLocked" class="headerlink" title="ActivityManagerService.attachApplicationLocked()"></a>ActivityManagerService.attachApplicationLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></div><div class="line">        <span class="keyword">int</span> pid) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 根据pid获取应用的ProcessRecord</span></div><div class="line">    ProcessRecord app;</div><div class="line">    <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</div><div class="line">            app = mPidsSelfLocked.get(pid);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        app = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 获取ProcessRecord失败，退出</span></div><div class="line">        EventLog.writeEvent(EventLogTags.AM_DROP_PROCESS, pid);</div><div class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span> &amp;&amp; pid != MY_PID) &#123;</div><div class="line">            Process.killProcessQuiet(pid);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                thread.scheduleExit();</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 如果ProcessRecord还和之前的进程绑定，就清除之前绑定的进程信息</span></div><div class="line">    <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 绑定应用进程的DeathRecipient，当应用进程崩溃时，系统进程可以收到通知</span></div><div class="line">    <span class="keyword">final</span> String processName = app.processName;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        AppDeathRecipient adr = <span class="keyword">new</span> AppDeathRecipient(</div><div class="line">                app, pid, thread);</div><div class="line">        thread.asBinder().linkToDeath(adr, <span class="number">0</span>);</div><div class="line">        app.deathRecipient = adr;</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        app.resetPackageList(mProcessStats);</div><div class="line">        <span class="comment">// 绑定失败，这里会重启进程</span></div><div class="line">        startProcessLocked(app, <span class="string">"link fail"</span>, processName);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName);</div><div class="line">    <span class="comment">// 激活ProcessRecord，设置进程的一些信息</span></div><div class="line">    app.makeActive(thread, mProcessStats);</div><div class="line">    app.curAdj = app.setAdj = -<span class="number">100</span>;</div><div class="line">    app.curSchedGroup = app.setSchedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">    app.forcingToForeground = <span class="keyword">null</span>;</div><div class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">    app.hasShownUi = <span class="keyword">false</span>;</div><div class="line">    app.debugging = <span class="keyword">false</span>;</div><div class="line">    app.cached = <span class="keyword">false</span>;</div><div class="line">    app.killedByAm = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">// 移除超时标志</span></div><div class="line">    mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</div><div class="line">    <span class="comment">// 获取应用所有的provider</span></div><div class="line">    List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="keyword">null</span>;</div><div class="line">    <span class="comment">// 如果有provider在mLaunchingProviders列表中，那么发消息移除它们</span></div><div class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span> &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;</div><div class="line">        Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);</div><div class="line">        msg.obj = app;</div><div class="line">        mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">int</span> testMode = IApplicationThread.DEBUG_OFF;</div><div class="line">        <span class="keyword">if</span> (mDebugApp != <span class="keyword">null</span> &amp;&amp; mDebugApp.equals(processName)) &#123;</div><div class="line">            testMode = mWaitForDebugger</div><div class="line">                ? IApplicationThread.DEBUG_WAIT</div><div class="line">                : IApplicationThread.DEBUG_ON;</div><div class="line">            app.debugging = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (mDebugTransient) &#123;</div><div class="line">                mDebugApp = mOrigDebugApp;</div><div class="line">                mWaitForDebugger = mOrigWaitForDebugger;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        String profileFile = app.instrumentationProfileFile;</div><div class="line">        ParcelFileDescriptor profileFd = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> samplingInterval = <span class="number">0</span>;</div><div class="line">        <span class="keyword">boolean</span> profileAutoStop = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (mProfileApp != <span class="keyword">null</span> &amp;&amp; mProfileApp.equals(processName)) &#123;</div><div class="line">            mProfileProc = app;</div><div class="line">            profileFile = mProfileFile;</div><div class="line">            profileFd = mProfileFd;</div><div class="line">            samplingInterval = mSamplingInterval;</div><div class="line">            profileAutoStop = mAutoStopProfiler;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">boolean</span> enableOpenGlTrace = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (mOpenGlTraceApp != <span class="keyword">null</span> &amp;&amp; mOpenGlTraceApp.equals(processName)) &#123;</div><div class="line">            enableOpenGlTrace = <span class="keyword">true</span>;</div><div class="line">            mOpenGlTraceApp = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> isRestrictedBackupMode = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupAppName.equals(processName)) &#123;</div><div class="line">            isRestrictedBackupMode = (mBackupTarget.backupMode == BackupRecord.RESTORE)</div><div class="line">                    || (mBackupTarget.backupMode == BackupRecord.RESTORE_FULL)</div><div class="line">                    || (mBackupTarget.backupMode == BackupRecord.BACKUP_FULL);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ensurePackageDexOpt(app.instrumentationInfo != <span class="keyword">null</span></div><div class="line">                ? app.instrumentationInfo.packageName</div><div class="line">                : app.info.packageName);</div><div class="line">        <span class="keyword">if</span> (app.instrumentationClass != <span class="keyword">null</span>) &#123;</div><div class="line">            ensurePackageDexOpt(app.instrumentationClass.getPackageName());</div><div class="line">        &#125;</div><div class="line">        ApplicationInfo appInfo = app.instrumentationInfo != <span class="keyword">null</span></div><div class="line">                ? app.instrumentationInfo : app.info;</div><div class="line">        app.compat = compatibilityInfoForPackageLocked(appInfo);</div><div class="line">        <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</div><div class="line">            profileFd = profileFd.dup();</div><div class="line">        &#125;</div><div class="line">        ProfilerInfo profilerInfo = profileFile == <span class="keyword">null</span> ? <span class="keyword">null</span></div><div class="line">                : <span class="keyword">new</span> ProfilerInfo(profileFile, profileFd, samplingInterval, profileAutoStop);</div><div class="line">        <span class="comment">// 发起跨进程调用。绑定应用进程，发送一些参数给应用进程</span></div><div class="line">        thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,</div><div class="line">                profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,</div><div class="line">                app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace,</div><div class="line">                isRestrictedBackupMode || !normalMode, app.persistent,</div><div class="line">                <span class="keyword">new</span> Configuration(mConfiguration), app.compat,</div><div class="line">                getCommonServicesLocked(app.isolated),</div><div class="line">                mCoreSettingsObserver.getCoreSettingsLocked());</div><div class="line">        updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">        app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="comment">// 绑定失败这里会重启进程</span></div><div class="line">        app.resetPackageList(mProcessStats);</div><div class="line">        app.unlinkDeathRecipient();</div><div class="line">        startProcessLocked(app, <span class="string">"bind fail"</span>, processName);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 把进程从待启动进程列表中移除</span></div><div class="line">    mPersistentStartingProcesses.remove(app);</div><div class="line">    mProcessesOnHold.remove(app);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> badApp = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 处理Activity</span></div><div class="line">    <span class="keyword">if</span> (normalMode) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</div><div class="line">                didSomething = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            badApp = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 处理Service</span></div><div class="line">    <span class="keyword">if</span> (!badApp) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            didSomething |= mServices.attachApplicationLocked(app, processName);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            badApp = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 处理Broadcast</span></div><div class="line">    <span class="keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            didSomething |= sendPendingBroadcastsLocked(app);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            badApp = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!badApp &amp;&amp; mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupTarget.appInfo.uid == app.uid) &#123;</div><div class="line">        ensurePackageDexOpt(mBackupTarget.appInfo.packageName);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            thread.scheduleCreateBackupAgent(mBackupTarget.appInfo,</div><div class="line">                    compatibilityInfoForPackageLocked(mBackupTarget.appInfo),</div><div class="line">                    mBackupTarget.backupMode);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            badApp = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 杀掉坏的进程</span></div><div class="line">    <span class="keyword">if</span> (badApp) &#123;</div><div class="line">        app.kill(<span class="string">"error during init"</span>, <span class="keyword">true</span>);</div><div class="line">        handleAppDiedLocked(app, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!didSomething) &#123;</div><div class="line">        updateOomAdjLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityThread-handleBindApplication"><a href="#ActivityThread-handleBindApplication" class="headerlink" title="ActivityThread.handleBindApplication()"></a>ActivityThread.handleBindApplication()</h4><p>这里又转到应用进程来处理进程绑定的工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</div><div class="line">    mBoundApplication = data;</div><div class="line">    mConfiguration = <span class="keyword">new</span> Configuration(data.config);</div><div class="line">    mCompatConfiguration = <span class="keyword">new</span> Configuration(data.config);</div><div class="line"></div><div class="line">    mProfiler = <span class="keyword">new</span> Profiler();</div><div class="line">    <span class="keyword">if</span> (data.initProfilerInfo != <span class="keyword">null</span>) &#123;</div><div class="line">        mProfiler.profileFile = data.initProfilerInfo.profileFile;</div><div class="line">        mProfiler.profileFd = data.initProfilerInfo.profileFd;</div><div class="line">        mProfiler.samplingInterval = data.initProfilerInfo.samplingInterval;</div><div class="line">        mProfiler.autoStopProfiler = data.initProfilerInfo.autoStopProfiler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 设置进程的名字</span></div><div class="line">    Process.setArgV0(data.processName);</div><div class="line">    android.ddm.DdmHandleAppName.setAppName(data.processName,</div><div class="line">                                            UserHandle.myUserId());</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.persistent) &#123;</div><div class="line">        <span class="comment">// 对persistent进程的处理，在低内存设备上不用硬件加速</span></div><div class="line">        <span class="keyword">if</span> (!ActivityManager.isHighEndGfx()) &#123;</div><div class="line">            HardwareRenderer.disable(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mProfiler.profileFd != <span class="keyword">null</span>) &#123;</div><div class="line">        mProfiler.startProfiling();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.appInfo.targetSdkVersion &lt;= android.os.Build.VERSION_CODES.HONEYCOMB_MR1) &#123;</div><div class="line">        AsyncTask.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Message.updateCheckRecycle(data.appInfo.targetSdkVersion);</div><div class="line"></div><div class="line">    <span class="comment">//设置时区</span></div><div class="line">    TimeZone.setDefault(<span class="keyword">null</span>);</div><div class="line">    Locale.setDefault(data.config.locale);</div><div class="line"></div><div class="line">    <span class="comment">// 更新系统配置</span></div><div class="line">    mResourcesManager.applyConfigurationToResourcesLocked(data.config, data.compatInfo);</div><div class="line">    mCurDefaultDisplayDpi = data.config.densityDpi;</div><div class="line">    applyCompatConfiguration(mCurDefaultDisplayDpi);</div><div class="line"></div><div class="line">    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((data.appInfo.flags&amp;ApplicationInfo.FLAG_SUPPORTS_SCREEN_DENSITIES)</div><div class="line">            == <span class="number">0</span>) &#123;</div><div class="line">        mDensityCompatMode = <span class="keyword">true</span>;</div><div class="line">        Bitmap.setDefaultDensity(DisplayMetrics.DENSITY_DEFAULT);</div><div class="line">    &#125;</div><div class="line">    updateDefaultDensity();</div><div class="line"></div><div class="line">    <span class="comment">// 创建Context上下文</span></div><div class="line">    <span class="keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="keyword">this</span>, data.info);</div><div class="line">    <span class="keyword">if</span> (!Process.isIsolated()) &#123;</div><div class="line">        ......</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 设置时区，debug模式，StrictMode</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> is24Hr = <span class="string">"24"</span>.equals(mCoreSettings.getString(Settings.System.TIME_12_24));</div><div class="line">    DateFormat.set24HourTimePref(is24Hr);</div><div class="line"></div><div class="line">    View.mDebugViewAttributes =</div><div class="line">            mCoreSettings.getInt(Settings.Global.DEBUG_VIEW_ATTRIBUTES, <span class="number">0</span>) != <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> ((data.appInfo.flags &amp;</div><div class="line">         (ApplicationInfo.FLAG_SYSTEM |</div><div class="line">          ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != <span class="number">0</span>) &#123;</div><div class="line">        StrictMode.conditionallyEnableDebugLogging();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (data.appInfo.targetSdkVersion &gt; <span class="number">9</span>) &#123;</div><div class="line">        StrictMode.enableDeathOnNetwork();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    NetworkSecurityPolicy.getInstance().setCleartextTrafficPermitted(</div><div class="line">            (data.appInfo.flags &amp; ApplicationInfo.FLAG_USES_CLEARTEXT_TRAFFIC) != <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.debugMode != IApplicationThread.DEBUG_OFF) &#123;</div><div class="line">        Debug.changeDebugPort(<span class="number">8100</span>);</div><div class="line">        <span class="keyword">if</span> (data.debugMode == IApplicationThread.DEBUG_WAIT) &#123;</div><div class="line">            IActivityManager mgr = ActivityManagerNative.getDefault();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mgr.showWaitingForDebugger(mAppThread, <span class="keyword">true</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;&#125;</div><div class="line"></div><div class="line">            Debug.waitForDebugger();</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mgr.showWaitingForDebugger(mAppThread, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;&#125;</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> &#123; &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.enableOpenGlTrace) &#123;</div><div class="line">        GLUtils.setTracingLevel(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 如果是调试模式生成systrace 信息</span></div><div class="line">    <span class="keyword">boolean</span> appTracingAllowed = (data.appInfo.flags&amp;ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</div><div class="line">    Trace.setAppTracingAllowed(appTracingAllowed);</div><div class="line"></div><div class="line">    <span class="comment">// 初始化默认http代理</span></div><div class="line">    IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);</div><div class="line">    <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</div><div class="line">        IConnectivityManager service = IConnectivityManager.Stub.asInterface(b);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">final</span> ProxyInfo proxyInfo = service.getProxyForNetwork(<span class="keyword">null</span>);</div><div class="line">            Proxy.setHttpProxySystemProperty(proxyInfo);</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.instrumentationName != <span class="keyword">null</span>) &#123;</div><div class="line">        InstrumentationInfo ii = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ii = appContext.getPackageManager().</div><div class="line">                getInstrumentationInfo(data.instrumentationName, <span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (ii == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Unable to find instrumentation info for: "</span></div><div class="line">                + data.instrumentationName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mInstrumentationPackageName = ii.packageName;</div><div class="line">        mInstrumentationAppDir = ii.sourceDir;</div><div class="line">        mInstrumentationSplitAppDirs = ii.splitSourceDirs;</div><div class="line">        mInstrumentationLibDir = ii.nativeLibraryDir;</div><div class="line">        mInstrumentedAppDir = data.info.getAppDir();</div><div class="line">        mInstrumentedSplitAppDirs = data.info.getSplitAppDirs();</div><div class="line">        mInstrumentedLibDir = data.info.getLibDir();</div><div class="line"></div><div class="line">        ApplicationInfo instrApp = <span class="keyword">new</span> ApplicationInfo();</div><div class="line">        instrApp.packageName = ii.packageName;</div><div class="line">        instrApp.sourceDir = ii.sourceDir;</div><div class="line">        instrApp.publicSourceDir = ii.publicSourceDir;</div><div class="line">        instrApp.splitSourceDirs = ii.splitSourceDirs;</div><div class="line">        instrApp.splitPublicSourceDirs = ii.splitPublicSourceDirs;</div><div class="line">        instrApp.dataDir = ii.dataDir;</div><div class="line">        instrApp.nativeLibraryDir = ii.nativeLibraryDir;</div><div class="line">        LoadedApk pi = getPackageInfo(instrApp, data.compatInfo,</div><div class="line">                appContext.getClassLoader(), <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">        ContextImpl instrContext = ContextImpl.createAppContext(<span class="keyword">this</span>, pi);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            java.lang.ClassLoader cl = instrContext.getClassLoader();</div><div class="line">            mInstrumentation = (Instrumentation)</div><div class="line">                cl.loadClass(data.instrumentationName.getClassName()).newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Unable to instantiate instrumentation "</span></div><div class="line">                + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mInstrumentation.init(<span class="keyword">this</span>, instrContext, appContext,</div><div class="line">               <span class="keyword">new</span> ComponentName(ii.packageName, ii.name), data.instrumentationWatcher,</div><div class="line">               data.instrumentationUiAutomationConnection);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mProfiler.profileFile != <span class="keyword">null</span> &amp;&amp; !ii.handleProfiling</div><div class="line">                &amp;&amp; mProfiler.profileFd == <span class="keyword">null</span>) &#123;</div><div class="line">            mProfiler.handlingProfiling = <span class="keyword">true</span>;</div><div class="line">            File file = <span class="keyword">new</span> File(mProfiler.profileFile);</div><div class="line">            file.getParentFile().mkdirs();</div><div class="line">            Debug.startMethodTracing(file.toString(), <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 初始化mInstrumentation</span></div><div class="line">        mInstrumentation = <span class="keyword">new</span> Instrumentation();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((data.appInfo.flags&amp;ApplicationInfo.FLAG_LARGE_HEAP) != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 如果设置了largeHeap，清楚内存上限</span></div><div class="line">        dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 设置内存上限</span></div><div class="line">        dalvik.system.VMRuntime.getRuntime().clampGrowthLimit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 创建Application对象</span></div><div class="line">        Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</div><div class="line">        mInitialApplication = app;</div><div class="line"></div><div class="line">        <span class="comment">// 装载Providers</span></div><div class="line">        <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</div><div class="line">            List&lt;ProviderInfo&gt; providers = data.providers;</div><div class="line">            <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</div><div class="line">                installContentProviders(app, providers);</div><div class="line">                mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="number">10</span>*<span class="number">1000</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mInstrumentation.onCreate(data.instrumentationArgs);</div><div class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Exception thrown in onCreate() of "</span></div><div class="line">                + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//调用Application.onCreate()</span></div><div class="line">            mInstrumentation.callApplicationOnCreate(app);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(app, e)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="string">"Unable to create application "</span> + app.getClass().getName()</div><div class="line">                    + <span class="string">": "</span> + e.toString(), e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        StrictMode.setThreadPolicy(savedPolicy);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-attachApplicationLocked"><a href="#ActivityStackSupervisor-attachApplicationLocked" class="headerlink" title="ActivityStackSupervisor.attachApplicationLocked()"></a>ActivityStackSupervisor.attachApplicationLocked()</h4><p>接下来会继续处理 <code>ActivityManagerService.attachApplication()</code> 中的 <code>ActivityStackSupervisor.attachApplicationLocked()</code> 方法。将 <code>ActivityStackSupervisor</code> 绑定到应用进程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">    <span class="keyword">final</span> String processName = app.processName;</div><div class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</div><div class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</div><div class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</div><div class="line">            <span class="keyword">if</span> (!isFrontStack(stack)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            ActivityRecord hr = stack.topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span> (hr != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (hr.app == <span class="keyword">null</span> &amp;&amp; app.uid == hr.info.applicationInfo.uid</div><div class="line">                        &amp;&amp; processName.equals(hr.processName)) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// 真正的启动activity，调用Activity.onCreate，从这里开始的流程</span></div><div class="line">                        <span class="comment">// 就和进程已经存在时启动activity流程一样的了</span></div><div class="line">                        <span class="keyword">if</span> (realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)) &#123;</div><div class="line">                            didSomething = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                        <span class="keyword">throw</span> e;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!didSomething) &#123;</div><div class="line">        ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> didSomething;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-realStartActivityLocked"><a href="#ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="ActivityStackSupervisor.realStartActivityLocked()"></a>ActivityStackSupervisor.realStartActivityLocked()</h4><p>开始执行真正的Activity启动操作，从这里开始的流程就和进程已经存在时启动activity流程一样的了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r,</span></span></div><div class="line">        ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</div><div class="line">        <span class="keyword">throws</span> RemoteException &#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (andResume) &#123;</div><div class="line">        <span class="comment">// 开始冻屏</span></div><div class="line">        r.startFreezingScreenLocked(app, <span class="number">0</span>);</div><div class="line">        mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        r.startLaunchTickingLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (checkConfig) &#123;</div><div class="line">        Configuration config = mWindowManager.updateOrientationFromAppTokens(</div><div class="line">                mService.mConfiguration,</div><div class="line">                r.mayFreezeScreenLocked(app) ? r.appToken : <span class="keyword">null</span>);</div><div class="line">        mService.updateConfigurationLocked(config, r, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    r.app = app;</div><div class="line">    app.waitingToKill = <span class="keyword">null</span>;</div><div class="line">    r.launchCount++;</div><div class="line">    r.lastLaunchTime = SystemClock.uptimeMillis();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> idx = app.activities.indexOf(r);</div><div class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</div><div class="line">        app.activities.add(r);</div><div class="line">    &#125;</div><div class="line">    mService.updateLruProcessLocked(app, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">    mService.updateOomAdjLocked();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TaskRecord task = r.task;</div><div class="line">    <span class="keyword">if</span> (task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE ||</div><div class="line">            task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE_PRIV) &#123;</div><div class="line">        setLockTaskModeLocked(task, LOCK_TASK_MODE_LOCKED, <span class="string">"mLockTaskAuth==LAUNCHABLE"</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ActivityStack stack = task.stack;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</div><div class="line">        &#125;</div><div class="line">        List&lt;ResultInfo&gt; results = <span class="keyword">null</span>;</div><div class="line">        List&lt;ReferrerIntent&gt; newIntents = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (andResume) &#123;</div><div class="line">            results = r.results;</div><div class="line">            newIntents = r.newIntents;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (andResume) &#123;</div><div class="line">            EventLog.writeEvent(EventLogTags.AM_RESTART_ACTIVITY,</div><div class="line">                    r.userId, System.identityHashCode(r),</div><div class="line">                    task.taskId, r.shortComponentName);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (r.isHomeActivity() &amp;&amp; r.isNotResolverActivity()) &#123;</div><div class="line">            <span class="comment">// Home process 是task中的第一个进程</span></div><div class="line">            mService.mHomeProcess = task.mActivities.get(<span class="number">0</span>).app;</div><div class="line">        &#125;</div><div class="line">        mService.ensurePackageDexOpt(r.intent.getComponent().getPackageName());</div><div class="line">        r.sleeping = <span class="keyword">false</span>;</div><div class="line">        r.forceNewConfig = <span class="keyword">false</span>;</div><div class="line">        mService.showAskCompatModeDialogLocked(r);</div><div class="line">        r.compat = mService.compatibilityInfoForPackageLocked(r.info.applicationInfo);</div><div class="line">        ProfilerInfo profilerInfo = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (mService.mProfileApp != <span class="keyword">null</span> &amp;&amp; mService.mProfileApp.equals(app.processName)) &#123;</div><div class="line">            <span class="keyword">if</span> (mService.mProfileProc == <span class="keyword">null</span> || mService.mProfileProc == app) &#123;</div><div class="line">                mService.mProfileProc = app;</div><div class="line">                <span class="keyword">final</span> String profileFile = mService.mProfileFile;</div><div class="line">                <span class="keyword">if</span> (profileFile != <span class="keyword">null</span>) &#123;</div><div class="line">                    ParcelFileDescriptor profileFd = mService.mProfileFd;</div><div class="line">                    <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            profileFd = profileFd.dup();</div><div class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                            <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                    profileFd.close();</div><div class="line">                                &#125; <span class="keyword">catch</span> (IOException o) &#123;</div><div class="line">                                &#125;</div><div class="line">                                profileFd = <span class="keyword">null</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    profilerInfo = <span class="keyword">new</span> ProfilerInfo(profileFile, profileFd,</div><div class="line">                            mService.mSamplingInterval, mService.mAutoStopProfiler);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (andResume) &#123;</div><div class="line">            app.hasShownUi = <span class="keyword">true</span>;</div><div class="line">            app.pendingUiClean = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        app.forceProcessStateUpTo(mService.mTopProcessState);</div><div class="line">        <span class="comment">// 调用ApplicationThreadNative.ApplicationThreadProxy.scheduleLaunchActivity()，跳到应用进程</span></div><div class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</div><div class="line">                System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</div><div class="line">                <span class="keyword">new</span> Configuration(stack.mOverrideConfig), r.compat, r.launchedFromPackage,</div><div class="line">                task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</div><div class="line">                newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((app.info.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (app.processName.equals(app.info.packageName)) &#123;</div><div class="line">                <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span></div><div class="line">                        &amp;&amp; mService.mHeavyWeightProcess != app) &#123;</div><div class="line">                    ...</div><div class="line">                &#125;</div><div class="line">                mService.mHeavyWeightProcess = app;</div><div class="line">                Message msg = mService.mHandler.obtainMessage(</div><div class="line">                        ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);</div><div class="line">                msg.obj = r;</div><div class="line">                mService.mHandler.sendMessage(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">if</span> (r.launchFailed) &#123;</div><div class="line">            mService.appDiedLocked(app);</div><div class="line">            stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</div><div class="line">                    <span class="string">"2nd-crash"</span>, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        app.activities.remove(r);</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    r.launchFailed = <span class="keyword">false</span>;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (andResume) &#123;</div><div class="line">        stack.minimalResumeActivityLocked(r);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        r.state = STOPPED;</div><div class="line">        r.stopped = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isFrontStack(stack)) &#123;</div><div class="line">        mService.startSetupActivityLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mService.mServices.updateServiceConnectionActivitiesLocked(r.app);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityThread-H-handleMessage-LAUNCH-ACTIVITY"><a href="#ActivityThread-H-handleMessage-LAUNCH-ACTIVITY" class="headerlink" title="ActivityThread.H.handleMessage():LAUNCH_ACTIVITY"></a>ActivityThread.H.handleMessage():LAUNCH_ACTIVITY</h4><p>跳转到应用进程来处理，从这里开始就开始Activity的生命周期的运转了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">        <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</div><div class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</div><div class="line">            <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line"></div><div class="line">            r.packageInfo = getPackageInfoNoCheck(</div><div class="line">                    r.activityInfo.applicationInfo, r.compatInfo);</div><div class="line">            handleLaunchActivity(r, <span class="keyword">null</span>);</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityThread-handleLaunchActivity"><a href="#ActivityThread-handleLaunchActivity" class="headerlink" title="ActivityThread.handleLaunchActivity()"></a>ActivityThread.handleLaunchActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line">    unscheduleGcIdler();</div><div class="line">    mSomeActivitiesChanged = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.profilerInfo != <span class="keyword">null</span>) &#123;</div><div class="line">        mProfiler.setProfiler(r.profilerInfo);</div><div class="line">        mProfiler.startProfiling();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 初始化WMS</span></div><div class="line">    WindowManagerGlobal.initialize();</div><div class="line">    <span class="comment">// 创建activity并调用onCreate，onStart等生命周期函数</span></div><div class="line">    Activity a = performLaunchActivity(r, customIntent);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</div><div class="line">        r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</div><div class="line">        Bundle oldState = r.state;</div><div class="line">        <span class="comment">// 调用onResume方法</span></div><div class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</div><div class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                r.activity.mCalled = <span class="keyword">false</span>;</div><div class="line">                mInstrumentation.callActivityOnPause(r.activity);</div><div class="line">                <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</div><div class="line">                    r.state = oldState;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!r.activity.mCalled) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</div><div class="line">                        <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</div><div class="line">                        <span class="string">" did not call through to super.onPause()"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                            <span class="string">"Unable to pause activity "</span></div><div class="line">                            + r.intent.getComponent().toShortString()</div><div class="line">                            + <span class="string">": "</span> + e.toString(), e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            r.paused = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ActivityManagerNative.getDefault()</div><div class="line">                .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ActivityThread-performLaunchActivity"><a href="#ActivityThread-performLaunchActivity" class="headerlink" title="ActivityThread.performLaunchActivity()"></a>ActivityThread.performLaunchActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line">    <span class="comment">// 收集要启动的Activity的package信息</span></div><div class="line">    ActivityInfo aInfo = r.activityInfo;</div><div class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</div><div class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</div><div class="line">                Context.CONTEXT_INCLUDE_CODE);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 收集要启动的Activity的component信息</span></div><div class="line">    ComponentName component = r.intent.getComponent();</div><div class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</div><div class="line">        component = r.intent.resolveActivity(</div><div class="line">            mInitialApplication.getPackageManager());</div><div class="line">        r.intent.setComponent(component);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</div><div class="line">                r.activityInfo.targetActivity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 新建一个Activity对象，通过ClassLoader将要启动的Activity类加载进来</span></div><div class="line">    Activity activity = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">        activity = mInstrumentation.newActivity(</div><div class="line">                cl, component.getClassName(), r.intent);</div><div class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</div><div class="line">        r.intent.setExtrasClassLoader(cl);</div><div class="line">        r.intent.prepareToEnterProcess();</div><div class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">            r.state.setClassLoader(cl);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Unable to instantiate activity "</span> + component</div><div class="line">                + <span class="string">": "</span> + e.toString(), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 获取Application对象</span></div><div class="line">        <span class="comment">// 不知道大家有没有印象，在ActivityThread.handleBindApplication方法中已经调用过makeApplication</span></div><div class="line">        <span class="comment">// 为什么还要make呢？追踪源码会发现，如果已经创建就返回以前创建的对象</span></div><div class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 创建Context对象，并绑定到Activity</span></div><div class="line">            Context appContext = createBaseContextForActivity(r, activity);</div><div class="line">            CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</div><div class="line">            Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</div><div class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                    r.referrer, r.voiceInteractor);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</div><div class="line">                activity.mIntent = customIntent;</div><div class="line">            &#125;</div><div class="line">            r.lastNonConfigurationInstances = <span class="keyword">null</span>;</div><div class="line">            activity.mStartedActivity = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</div><div class="line">            <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</div><div class="line">                activity.setTheme(theme);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            activity.mCalled = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// 调用Activity.onCreate方法</span></div><div class="line">            <span class="comment">// 根据 manifest 中activity的persistableMode配置来执行不同的onCreate方法</span></div><div class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!activity.mCalled) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</div><div class="line">                    <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</div><div class="line">                    <span class="string">" did not call through to super.onCreate()"</span>);</div><div class="line">            &#125;</div><div class="line">            r.activity = activity;</div><div class="line">            r.stopped = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                <span class="comment">// 调用Activity.onStart方法</span></div><div class="line">                activity.performStart();</div><div class="line">                r.stopped = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                <span class="comment">// 调用Activity.onRestoreInstanceState方法</span></div><div class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                    <span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</div><div class="line">                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</div><div class="line">                                r.persistentState);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                activity.mCalled = <span class="keyword">false</span>;</div><div class="line">                <span class="comment">// 调用Activity.onPostCreate方法</span></div><div class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state,</div><div class="line">                            r.persistentState);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</div><div class="line">                        <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</div><div class="line">                        <span class="string">" did not call through to super.onPostCreate()"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        r.paused = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        mActivities.put(r.token, r);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Unable to start activity "</span> + component</div><div class="line">                + <span class="string">": "</span> + e.toString(), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> activity;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从 <code>performLaunchActivity</code> 方法开始，正式进入了 <code>Activity</code> 的 <code>onCreate()</code>、<code>onStart()</code>、<code>onResume()</code>等生命周期过程。<br>至此，<code>Activity</code> 的启动流程基本介绍完了。</p>
<h2 id="方法详解"><a href="#方法详解" class="headerlink" title="方法详解"></a>方法详解</h2><h3 id="findTaskLocked"><a href="#findTaskLocked" class="headerlink" title="findTaskLocked()"></a>findTaskLocked()</h3><h3 id="findActivityLocked"><a href="#findActivityLocked" class="headerlink" title="findActivityLocked()"></a>findActivityLocked()</h3><h3 id="resolveActivity"><a href="#resolveActivity" class="headerlink" title="resolveActivity()"></a>resolveActivity()</h3><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><!--     
http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1#10-amsnewprocessrecordlocked
http://duanqz.github.io/2016-10-23-Activity-LaunchProcess-Part2#3-amsattachapplicationlocked
http://gityuan.com/2016/03/12/start-activity/

http://blog.csdn.net/luoshengyang/article/details/6689748
http://blog.csdn.net/Luoshengyang/article/details/6703247
http://duanqz.github.io/2016-02-01-Activity-Maintenance
http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1
http://gityuan.com/2016/03/12/start-activity/
http://gityuan.com/2016/10/09/app-process-create-2/
http://www.cnblogs.com/franksunny/archive/2012/04/17/2453403.html
http://blog.csdn.net/shan987/article/details/50511439
http://blog.csdn.net/yunbin_7/article/details/46003509
http://www.jianshu.com/p/2d52fa0bce90
-->

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android源码分析/" rel="tag"># Android源码分析</a>
          
            <a href="/tags/startActivity/" rel="tag"># startActivity</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/08/android-source-code-analysis-ams-app-ipc/" rel="next" title="Android AMS 与 APP 进程通信">
                <i class="fa fa-chevron-left"></i> Android AMS 与 APP 进程通信
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/02/android-attr-style-custom/" rel="prev" title="Android -- 自定义Attribute和Style">
                Android -- 自定义Attribute和Style <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/icon.png"
               alt="寒江蓑笠" />
          <p class="site-author-name" itemprop="name">寒江蓑笠</p>
          <p class="site-description motion-element" itemprop="description">技术博客</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">241</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">113</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/heqiangflytosky/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/heqiangflytosky/" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关类介绍"><span class="nav-number">2.</span> <span class="nav-text">相关类介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动流程图"><span class="nav-number">3.</span> <span class="nav-text">启动流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#进程间的通信"><span class="nav-number">4.</span> <span class="nav-text">进程间的通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动流程"><span class="nav-number">5.</span> <span class="nav-text">启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动前期，当前进程"><span class="nav-number">5.1.</span> <span class="nav-text">启动前期，当前进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityManagerService的处理"><span class="nav-number">5.2.</span> <span class="nav-text">ActivityManagerService的处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-startActivityAsUser"><span class="nav-number">5.2.1.</span> <span class="nav-text">ActivityManagerService.startActivityAsUser</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-startActivityMayWait"><span class="nav-number">5.2.2.</span> <span class="nav-text">ActivityStackSupervisor.startActivityMayWait()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-startActivityLocked"><span class="nav-number">5.2.3.</span> <span class="nav-text">ActivityStackSupervisor.startActivityLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-startActivityUncheckedLocked"><span class="nav-number">5.2.4.</span> <span class="nav-text">ActivityStackSupervisor.startActivityUncheckedLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStack-startActivityLocked"><span class="nav-number">5.2.5.</span> <span class="nav-text">ActivityStack.startActivityLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-resumeTopActivitiesLocked"><span class="nav-number">5.2.6.</span> <span class="nav-text">ActivityStackSupervisor.resumeTopActivitiesLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStack-resumeTopActivityLocked"><span class="nav-number">5.2.7.</span> <span class="nav-text">ActivityStack.resumeTopActivityLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStack-resumeTopActivityInnerLocked"><span class="nav-number">5.2.8.</span> <span class="nav-text">ActivityStack.resumeTopActivityInnerLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-startSpecificActivityLocked"><span class="nav-number">5.2.9.</span> <span class="nav-text">ActivityStackSupervisor.startSpecificActivityLocked()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS中启动新进程"><span class="nav-number">5.3.</span> <span class="nav-text">AMS中启动新进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-startProcessLocked"><span class="nav-number">5.3.1.</span> <span class="nav-text">ActivityManagerService.startProcessLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-newProcessRecordLocked"><span class="nav-number">5.3.2.</span> <span class="nav-text">ActivityManagerService.newProcessRecordLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-startProcessLocked-1"><span class="nav-number">5.3.3.</span> <span class="nav-text">ActivityManagerService.startProcessLocked()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新进程"><span class="nav-number">5.4.</span> <span class="nav-text">新进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-main"><span class="nav-number">5.4.1.</span> <span class="nav-text">ActivityThread.main()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-attach"><span class="nav-number">5.4.2.</span> <span class="nav-text">ActivityThread.attach()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-attachApplication"><span class="nav-number">5.4.3.</span> <span class="nav-text">ActivityManagerService.attachApplication()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-attachApplicationLocked"><span class="nav-number">5.4.4.</span> <span class="nav-text">ActivityManagerService.attachApplicationLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-handleBindApplication"><span class="nav-number">5.4.5.</span> <span class="nav-text">ActivityThread.handleBindApplication()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-attachApplicationLocked"><span class="nav-number">5.4.6.</span> <span class="nav-text">ActivityStackSupervisor.attachApplicationLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-realStartActivityLocked"><span class="nav-number">5.4.7.</span> <span class="nav-text">ActivityStackSupervisor.realStartActivityLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-H-handleMessage-LAUNCH-ACTIVITY"><span class="nav-number">5.4.8.</span> <span class="nav-text">ActivityThread.H.handleMessage():LAUNCH_ACTIVITY</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-handleLaunchActivity"><span class="nav-number">5.4.9.</span> <span class="nav-text">ActivityThread.handleLaunchActivity()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-performLaunchActivity"><span class="nav-number">5.4.10.</span> <span class="nav-text">ActivityThread.performLaunchActivity()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方法详解"><span class="nav-number">6.</span> <span class="nav-text">方法详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#findTaskLocked"><span class="nav-number">6.1.</span> <span class="nav-text">findTaskLocked()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#findActivityLocked"><span class="nav-number">6.2.</span> <span class="nav-text">findActivityLocked()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#resolveActivity"><span class="nav-number">6.3.</span> <span class="nav-text">resolveActivity()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">7.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">寒江蓑笠</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "d2475abece3649debc94c21b166fc009",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("6zbrLyUbhXLbd7RqUSMnxhg4-gzGzoHsz", "fb9g4GyEWQysqnpY9t5CPhpU");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
