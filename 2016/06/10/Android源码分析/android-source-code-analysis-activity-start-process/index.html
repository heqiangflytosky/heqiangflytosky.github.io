<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Android源码分析,startActivity,">





  <link rel="alternate" href="/atom.xml" title="孤舟蓑笠翁，独钓寒江雪" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0">






<meta name="description" content="基于Android6.0来分析 Activity 的启动过程">
<meta name="keywords" content="Android源码分析,startActivity">
<meta property="og:type" content="article">
<meta property="og:title" content="Android startActivity 流程分析">
<meta property="og:url" content="http://yoursite.com/2016/06/10/Android源码分析/android-source-code-analysis-activity-start-process/index.html">
<meta property="og:site_name" content="孤舟蓑笠翁，独钓寒江雪">
<meta property="og:description" content="基于Android6.0来分析 Activity 的启动过程">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/pLTDJnin4Btlht13hrL5Zf62590g8WLKiQ5LLLN8U0TYiTWhsqdXrgzJUu1J3-sv4ZTwwQc7_fa6-1draat8ElP-PMbxYPBn-BsPyRDdCg01e0FErJu_yJpzWHghKg5E5A6dWXEGie5MUlHmeDR38NWH5eeI6c6cVOYY8wfEKyOkaqeCZu4fh2XdrWrRcE5341h_v1HXQRNlhNh00dGNLMVBdqMKXRgjUKUGvU63655YT_4L9aV-C8fT91Tkd_HA58MKt2RS7mZ0mMqAHW9D_QjCMGjLgPaTHsgrCKMOhA77A6rukDcOvqaGPaayMfijjQJIkBFpn_4NhE1E4TCloBdf2HSx88UXojbjwAa59q1yExifFUFtV2nffUMbO-ZIRhR0JwJOqeSXC9CQrWcTYDPgjG0d2YuOzrJlTdDH-8xSbI1g836kM9fb2vy-nzHIAFDYEknPH08a3qVWhfV94S1zX97AjyV94GJUlVFiCZA0cAfkmXBff35pJahVspwF4WSAilQuJOwbObz4wp86egPot9ROZu3G0qhAAiV3eK8FY7xB5Mp3wwJxU0XLka4uz2tdZL1k61byBrVY7lXgpT56Mr9BDnY6qCD3hUBPzKM8SKqeuYQgVupFBd___3O-UtVpvltLv-ytlxvUNtoAxUUNuuyNSxkkltou-l5siXWtjnWbbO6zcICq_nmKyN5K0a89gDfvsDxd1C1z4iO3ZL3fFi1cOUu0uI8emMMfn_BnLCoxI2pvFbeoNf7Eu78flx0CQBbkLit5AD0o7iaSv7QOpc1p7kROPzbijNdjTd8DaRw7qx4SjTkfKNTolLl7cBB5jpOPaOsvUd4tLhgAWmhxqxD-WZFt-EJCgatxhDhy5xDgyTWhpwiB5AuUQH1bCTbRqZvbWJqLUsEmcwq49R0NOItQ6s0MXB3k14rBqN9HB2iBWUItnWf_30eVPot_3UoJJNMkYbDDdKegJL58KBtExlR6vbvdezzzrks_gFugJfJf3Auacgxy0HV71U6AwVmltOrwElF_qPgR6MLoB_q1">
<meta property="og:updated_time" content="2019-07-05T01:22:37.912Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android startActivity 流程分析">
<meta name="twitter:description" content="基于Android6.0来分析 Activity 的启动过程">
<meta name="twitter:image" content="http://www.plantuml.com/plantuml/svg/pLTDJnin4Btlht13hrL5Zf62590g8WLKiQ5LLLN8U0TYiTWhsqdXrgzJUu1J3-sv4ZTwwQc7_fa6-1draat8ElP-PMbxYPBn-BsPyRDdCg01e0FErJu_yJpzWHghKg5E5A6dWXEGie5MUlHmeDR38NWH5eeI6c6cVOYY8wfEKyOkaqeCZu4fh2XdrWrRcE5341h_v1HXQRNlhNh00dGNLMVBdqMKXRgjUKUGvU63655YT_4L9aV-C8fT91Tkd_HA58MKt2RS7mZ0mMqAHW9D_QjCMGjLgPaTHsgrCKMOhA77A6rukDcOvqaGPaayMfijjQJIkBFpn_4NhE1E4TCloBdf2HSx88UXojbjwAa59q1yExifFUFtV2nffUMbO-ZIRhR0JwJOqeSXC9CQrWcTYDPgjG0d2YuOzrJlTdDH-8xSbI1g836kM9fb2vy-nzHIAFDYEknPH08a3qVWhfV94S1zX97AjyV94GJUlVFiCZA0cAfkmXBff35pJahVspwF4WSAilQuJOwbObz4wp86egPot9ROZu3G0qhAAiV3eK8FY7xB5Mp3wwJxU0XLka4uz2tdZL1k61byBrVY7lXgpT56Mr9BDnY6qCD3hUBPzKM8SKqeuYQgVupFBd___3O-UtVpvltLv-ytlxvUNtoAxUUNuuyNSxkkltou-l5siXWtjnWbbO6zcICq_nmKyN5K0a89gDfvsDxd1C1z4iO3ZL3fFi1cOUu0uI8emMMfn_BnLCoxI2pvFbeoNf7Eu78flx0CQBbkLit5AD0o7iaSv7QOpc1p7kROPzbijNdjTd8DaRw7qx4SjTkfKNTolLl7cBB5jpOPaOsvUd4tLhgAWmhxqxD-WZFt-EJCgatxhDhy5xDgyTWhpwiB5AuUQH1bCTbRqZvbWJqLUsEmcwq49R0NOItQ6s0MXB3k14rBqN9HB2iBWUItnWf_30eVPot_3UoJJNMkYbDDdKegJL58KBtExlR6vbvdezzzrks_gFugJfJf3Auacgxy0HV71U6AwVmltOrwElF_qPgR6MLoB_q1">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '6377131610457769000',
      author: '寒江蓑笠'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/06/10/Android源码分析/android-source-code-analysis-activity-start-process/">





  <title> Android startActivity 流程分析 | 孤舟蓑笠翁，独钓寒江雪 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  








  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1261134288&web_id=1261134288" language="JavaScript"></script>
  </div>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">孤舟蓑笠翁，独钓寒江雪</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">程序猿的世界</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-users"></i> <br>
            
            友情链接
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/10/Android源码分析/android-source-code-analysis-activity-start-process/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="寒江蓑笠">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/icon.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="孤舟蓑笠翁，独钓寒江雪">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="孤舟蓑笠翁，独钓寒江雪" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android startActivity 流程分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-10T10:00:00+08:00">
                2016-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">Android源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2016/06/10/Android源码分析/android-source-code-analysis-activity-start-process/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/06/10/Android源码分析/android-source-code-analysis-activity-start-process/" class="leancloud_visitors" data-flag-title="Android startActivity 流程分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
              <div class="post-description">
                  基于Android6.0来分析 Activity 的启动过程
              </div>
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Activity的启动方式有两种，一种是显式的，一种是隐式的。<br>而且，启动的 <code>Activity</code> 和原 <code>Activity</code> 的进程关系的不同又可以分为两种情况，一种是在同一个进程，另外一种情况是开启一个新的进程来启动 <code>Activity</code>。</p>
<h2 id="相关类介绍"><a href="#相关类介绍" class="headerlink" title="相关类介绍"></a>相关类介绍</h2><p>涉及到的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Activity.java</span><br><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line">frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</span><br></pre></td></tr></table></figure>
<ul>
<li>ActivityThread：代表了应用的主线程，在Activity.attach()方法中初始化</li>
<li>TaskRecord：Activity的管理者</li>
<li>ActivityStack：Stack的管理者</li>
<li>ActivityStackSupervisor：ActivityStack的管理者，早期的Android版本是没有这个类的，直到Android 6.0才出现。</li>
</ul>
<h2 id="启动流程图"><a href="#启动流程图" class="headerlink" title="启动流程图"></a>启动流程图</h2><p><img src="http://www.plantuml.com/plantuml/svg/pLTDJnin4Btlht13hrL5Zf62590g8WLKiQ5LLLN8U0TYiTWhsqdXrgzJUu1J3-sv4ZTwwQc7_fa6-1draat8ElP-PMbxYPBn-BsPyRDdCg01e0FErJu_yJpzWHghKg5E5A6dWXEGie5MUlHmeDR38NWH5eeI6c6cVOYY8wfEKyOkaqeCZu4fh2XdrWrRcE5341h_v1HXQRNlhNh00dGNLMVBdqMKXRgjUKUGvU63655YT_4L9aV-C8fT91Tkd_HA58MKt2RS7mZ0mMqAHW9D_QjCMGjLgPaTHsgrCKMOhA77A6rukDcOvqaGPaayMfijjQJIkBFpn_4NhE1E4TCloBdf2HSx88UXojbjwAa59q1yExifFUFtV2nffUMbO-ZIRhR0JwJOqeSXC9CQrWcTYDPgjG0d2YuOzrJlTdDH-8xSbI1g836kM9fb2vy-nzHIAFDYEknPH08a3qVWhfV94S1zX97AjyV94GJUlVFiCZA0cAfkmXBff35pJahVspwF4WSAilQuJOwbObz4wp86egPot9ROZu3G0qhAAiV3eK8FY7xB5Mp3wwJxU0XLka4uz2tdZL1k61byBrVY7lXgpT56Mr9BDnY6qCD3hUBPzKM8SKqeuYQgVupFBd___3O-UtVpvltLv-ytlxvUNtoAxUUNuuyNSxkkltou-l5siXWtjnWbbO6zcICq_nmKyN5K0a89gDfvsDxd1C1z4iO3ZL3fFi1cOUu0uI8emMMfn_BnLCoxI2pvFbeoNf7Eu78flx0CQBbkLit5AD0o7iaSv7QOpc1p7kROPzbijNdjTd8DaRw7qx4SjTkfKNTolLl7cBB5jpOPaOsvUd4tLhgAWmhxqxD-WZFt-EJCgatxhDhy5xDgyTWhpwiB5AuUQH1bCTbRqZvbWJqLUsEmcwq49R0NOItQ6s0MXB3k14rBqN9HB2iBWUItnWf_30eVPot_3UoJJNMkYbDDdKegJL58KBtExlR6vbvdezzzrks_gFugJfJf3Auacgxy0HV71U6AwVmltOrwElF_qPgR6MLoB_q1" alt="效果图"></p>
<!-- 
------------------------------------------------------------------------------ FirstActivity 进程
├── Activity.startActivity()
     ├── Activity.startActivityForResult()
          ├── Instrumentation.execStartActivity()
               ├── ActivityManagerNative.ActivityManagerProxy.startActivity()
------------------------------------------------------------------------------ FirstActivity 进程
------------------------------------------------------------------------------ AMS 进程
                    ├── ActivityManagerNative.onTransact()
                         ├── ActivityManagerService.startActivity()
                              ├── ActivityManagerService.startActivityAsUser()
                                   ├── ActivityStackSupervisor.startActivityMayWait()
                                        ├── ActivityStackSupervisor.resolveActivity()
                                        ├── ActivityStackSupervisor.startActivityLocked()
                                             ├── ActivityStackSupervisor.startActivityUncheckedLocked()
                                                  ├── ActivityStack.startActivityLocked()
                                                       ├── ActivityStackSupervisor.resumeTopActivitiesLocked()
                                                            ├── ActivityStack.resumeTopActivityLocked()
                                                                 ├── ActivityStack.resumeTopActivityInnerLocked()
                                                                      ├── ActivityStackSupervisor.startSpecificActivityLocked()
                                                                           ├── ActivityStackSupervisor.realStartActivityLocked() 在本进程启动
                                                                               此方法的分析同新进程启动Activity中的realStartActivityLocked()，下面分析
                                                                                ├── ApplicationThreadNative.ApplicationThreadProxy.scheduleLaunchActivity()
------------------------------------------------------------------------------ AMS 进程
------------------------------------------------------------------------------ FirstActivity 进程
├── ActivityThread.H.handleMessage():LAUNCH_ACTIVITY
     ├── ActivityThread.handleLaunchActivity()
          ├── ActivityThread.performLaunchActivity()
------------------------------------------------------------------------------ FirstActivity 进程
------------------------------------------------------------------------------ AMS 进程
                                                                           ├── ActivityManagerService.startProcessLocked() 启动新的进程
                                                                                ├── ActivityManagerService.newProcessRecordLocked()
                                                                                ├── ActivityManagerService.startProcessLocked()
                                                                                     ├── Process.start()
------------------------------------------------------------------------------ AMS 进程
------------------------------------------------------------------------------ SecondActivity 进程
├── ActivityThread.main()
     ├── ActivityThread.attach()
          ├── ActivityManagerNative.ActivityManagerProxy.attachApplication()
------------------------------------------------------------------------------ SecondActivity 进程
------------------------------------------------------------------------------ AMS 进程
├── ActivityManagerNative.onTransact()
     ├── ActivityManagerService.attachApplication()
          ├── ActivityManagerService.attachApplicationLocked()
               ├── ApplicationThreadNative.ApplicationThreadProxy.bindApplication()
------------------------------------------------------------------------------ AMS 进程
------------------------------------------------------------------------------ SecondActivity 进程
                    ├── ApplicationThread.bindApplication()
                         ├── ActivityThread.handleBindApplication()
------------------------------------------------------------------------------ SecondActivity 进程
------------------------------------------------------------------------------ AMS 进程
               ├── ActivityStackSupervisor.attachApplicationLocked()
                    ├── ActivityStackSupervisor.realStartActivityLocked() 此处同上面的同一进程启动Activity
                         ├── ApplicationThreadNative.ApplicationThreadProxy.scheduleLaunchActivity()
------------------------------------------------------------------------------ AMS 进程
------------------------------------------------------------------------------ SecondActivity 进程
├── ApplicationThread.scheduleLaunchActivity()
   ├── ActivityThread.H.handleMessage():LAUNCH_ACTIVITY
        ├── ActivityThread.handleLaunchActivity()
             ├── ActivityThread.performLaunchActivity()
------------------------------------------------------------------------------ SecondActivity 进程

http://www.plantuml.com/plantuml/png/jLVTYjj65BxNKqnDBsn8qhIzMGmRyCffruuDnZRgPHbBi_OGQKQCHjdrdKCefOKa5oqfj9IIGjbUDIsqjFI7lapjZT-YvqYMFBBbzR9i3AlrdByvSxvlT8wZXro4LD601598Tw9am8XMCREYN1FfgS_WgRYhuy2t9jnZv4HAFP9dbWKschiyf4AJIZyMcWUiuMh-YEjfXT28z1j5c-FfI77FuUoq5OH-OdBij3RYG7Iq8E-GxElRnsaqfsZPZeOJnQW7bjdNbMLxMBHq3XAnSr0Kz-YOTQc0fqhqlMvHNpWBB3OJZJLJBN4Yq-mspk4qfHi7JEXqQrWLzI2mPH1AaPaqxGq3vahLeLFO9jLtBElmaBnxXzXIH13Q8wCfQG_8uQ5bzHlazZseTvr8yO1Dc_9KM1JJfveX3AaUYbqdOtb4tOThBI80Vuc_iws6glSTLBQ7THBAIACwL2oArZPGRu_jM86_iSBDJ6N3ijf3Y9w67vM6JWm0l3fXPyo5eXz9wJCg1gxYeQvMqAk7NeXdjLQfhRq1SUU0tCxYkwl2cIc0YKLzJTxAbGG-gwIm81CgF9zr8Jw6xmu-_FYeOJ_ezUyF1hN4jdZqSebP3aJnlIAA1XCJE1CNICgGtnapRSSA2EUnisgDt2Dt4pFyf03rkca5St6-AH0xa_MwcUbObXfkM685fC0yeCGsr6BCjjtWKCLKCgwa3WwF-CXd2JpIz_3_BN92_OZLjcEj2fQ3aCTAuTxlKA2A8xcNySJTIYQ4HylBSgcKP0Fio6H5pfH8ZKJsIf46cTYNCYHGbnnTm5QmqtoP6vQXqcU1VBGYxMMuR6FJPF1UbrCCKkvjP6uK5zszwxXkml91BC1SYch526TWi0k7tLZihloLDKR5cF1sNuQKsDuLhiAMJqjqAHTflohrtmY0hGDBhgaxiIVSznGJ9KJ51fD9SO6kJNk_8xITJDQqCwT8GoTg21vGH2Wt418S51zFT9qilZfVllnj-Uttyp-Up7-PBMUp-QT_pZ__yUBBl_PlakuYHRx5VU5TCJML41vUdXeQPzeU1_I4-TDB_Gs8tvGqGQ1OAaXK9GHu_Upt-VCNQRsMdpoz-EUd__vzkNZyQfChs9wPHhBWN572ZjRQevNsDGmVRZgOZ6wL4uhgQn9gd-CRHosDYkUcNZ9CLWDZLhf5xjQkS2sRdSjPda27HeiNFviyNtpsnVplsKwUTqfpxrYNlsgCYyTq70vXlXbHrH3UHrnuyXGdhh6IyPuxSYEytTE_RxPVbx-Ir_N7Zh6SVNtntGyuvow--NKDnlDNhyyVBsRdr-xzDz7kzy2wezyROcCmsvOo64foDSoCxnTdnkpN2GwCHVH0Wo_NesmkBkjJ-7EcPEiTujMXafQOF8m9_dy0

@startuml
hide footbox

box "1st App Process" #LightBlue
participant Activity
participant Instrumentation
participant ActivityManagerProxy as ActivityManagerProxy_1
end box

box "AMS Process"
participant ActivityManagerNative
participant ActivityManagerService
participant ActivityStackSupervisor
participant ActivityStack
participant ApplicationThreadProxy
end box

box "2nd App Process" #LightBlue
participant ActivityManagerProxy as ActivityManagerProxy_2
participant ApplicationThread
participant "ActivityThread / ActivityThread$H" as ActivityThread
end box

-> Activity:startActivity
activate Activity
Activity -> Activity:startActivityForResult
activate Activity
Activity -> Instrumentation:execStartActivity
activate Instrumentation
Instrumentation -> ActivityManagerProxy_1:startActivity
activate ActivityManagerProxy_1
ActivityManagerProxy_1 -> ActivityManagerNative:onTransact
activate ActivityManagerNative
ActivityManagerNative -> ActivityManagerService:startActivity
activate ActivityManagerService
ActivityManagerService -> ActivityManagerService:startActivityAsUser
activate ActivityManagerService
ActivityManagerService -> ActivityStackSupervisor:startActivityMayWait
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStackSupervisor:resolveActivity
activate ActivityStackSupervisor
deactivate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStackSupervisor:startActivityLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStackSupervisor:startActivityUncheckedLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStack:startActivityLocked
activate ActivityStack
ActivityStack -> ActivityStackSupervisor:resumeTopActivitiesLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStack:resumeTopActivityLocked
activate ActivityStack
ActivityStack -> ActivityStack:resumeTopActivityInnerLocked
activate ActivityStack
ActivityStack -> ActivityStackSupervisor:startSpecificActivityLocked
activate ActivityStackSupervisor

alt !createNewProcess
  ActivityStackSupervisor -> ActivityStackSupervisor:realStartActivityLocked
  activate ActivityStackSupervisor
  ActivityStackSupervisor -[#Blue]> ApplicationThreadProxy:scheduleLaunchActivity
  note right
  可以参考新进程
  启动Activity
  的流程
  end note
  activate ApplicationThreadProxy
  deactivate ApplicationThreadProxy
  deactivate ActivityStackSupervisor
else createNewProcess
  ActivityStackSupervisor -> ActivityManagerService:startProcessLocked
  activate ActivityManagerService
  ActivityManagerService -> ActivityManagerService:newProcessRecordLocked
  activate ActivityManagerService
  deactivate ActivityManagerService
  ActivityManagerService -> ActivityManagerService:startProcessLocked
  activate ActivityManagerService
  deactivate ActivityManagerService
  deactivate ActivityManagerService
end

deactivate ActivityStackSupervisor
deactivate ActivityStack
deactivate ActivityStack
deactivate ActivityStackSupervisor
deactivate ActivityStack
deactivate ActivityStackSupervisor
deactivate ActivityStackSupervisor
deactivate ActivityStackSupervisor
deactivate ActivityManagerService
deactivate ActivityManagerService
deactivate ActivityManagerNative
deactivate ActivityManagerProxy_1
deactivate Instrumentation
deactivate Activity
deactivate Activity

== create New Process ==

-> ActivityThread:main
activate ActivityThread
ActivityThread -> ActivityThread:attach
activate ActivityThread
ActivityThread -> ActivityManagerProxy_2:attachApplication
activate ActivityManagerProxy_2
ActivityManagerProxy_2 -> ActivityManagerNative:onTransact
activate ActivityManagerNative
ActivityManagerNative -> ActivityManagerService:attachApplication
activate ActivityManagerService
ActivityManagerService -> ActivityManagerService:attachApplicationLocked
activate ActivityManagerService

ActivityManagerService -> ApplicationThreadProxy:bindApplication
activate ApplicationThreadProxy
ApplicationThreadProxy -> ApplicationThread:bindApplication
activate ApplicationThread
ApplicationThread -> ActivityThread:handleBindApplication
activate ActivityThread
deactivate ActivityThread
deactivate ApplicationThread
deactivate ApplicationThreadProxy

ActivityManagerService -> ActivityStackSupervisor:attachApplicationLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -> ActivityStackSupervisor:realStartActivityLocked
activate ActivityStackSupervisor
ActivityStackSupervisor -[#Blue]> ApplicationThreadProxy:scheduleLaunchActivity
activate ApplicationThreadProxy
ApplicationThreadProxy -> ApplicationThread:scheduleLaunchActivity
activate ApplicationThread
ApplicationThread -> ActivityThread:LAUNCH_ACTIVITY
activate ActivityThread
ActivityThread -> ActivityThread:handleLaunchActivity
activate ActivityThread
ActivityThread -> ActivityThread:performLaunchActivity
activate ActivityThread
deactivate ActivityThread
deactivate ActivityThread
deactivate ActivityThread
deactivate ApplicationThread
deactivate ApplicationThreadProxy
deactivate ActivityStackSupervisor
deactivate ActivityStackSupervisor

deactivate ActivityManagerService
deactivate ActivityManagerService
deactivate ActivityManagerNative
deactivate ActivityManagerProxy_2
deactivate ActivityThread

deactivate ActivityThread
@enduml

-->
<h2 id="进程间的通信"><a href="#进程间的通信" class="headerlink" title="进程间的通信"></a>进程间的通信</h2><h2 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h2><h3 id="启动前期，当前进程"><a href="#启动前期，当前进程" class="headerlink" title="启动前期，当前进程"></a>启动前期，当前进程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 一般情况下会走mParent == null分支</span></span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//调用Instrumentation.execStartActivity()启动新的Activity。mMainThread类型为ActivityThread, 在attach()函数被回调时被赋值。</span></span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果activity之前已经启动，而且处于阻塞状态，execStartActivity函数直接返回要启动的activity的result或者null。</span></span><br><span class="line">            <span class="comment">//如果结果不为空，发送结果</span></span><br><span class="line">            mMainThread.sendActivityResult(</span><br><span class="line">                mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                ar.getResultData());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果需要一个返回结果，那么赋值mStartedActivity为true，在结果返回来之前保持当前Activity不可见</span></span><br><span class="line">            mStartedActivity = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cancelInputsAndStartExitTransition(options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里注意到 <code>mParent</code> 变量，一般情况下这里 <code>mParent</code> 是为空的，除非是启动 <code>ActivityGroup</code> 等可以嵌套 <code>Activity</code> 的内部的 <code>Activity</code> 时才会不为空。</p>
<p>Instrumentation.execStartActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">    Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断mActivityMonitors是否为空，mActivityMonitors可以通过addMonitor()方法创建，一般在自动化测试时使用</span></span><br><span class="line">    <span class="comment">// 一般情况下不会走这个分支</span></span><br><span class="line">    <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line">                <span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</span><br><span class="line">                    am.mHits++;</span><br><span class="line">                    <span class="comment">// 如果处于阻塞状态，直接返回</span></span><br><span class="line">                    <span class="keyword">if</span> (am.isBlocking()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess();</span><br><span class="line">        <span class="comment">// 这里的ActivityManagerNative.getDefault返回ActivityManagerService的远程接口，即ActivityManagerProxy接口</span></span><br><span class="line">        <span class="comment">// 由它通过进程间通信调用 AMS 的 startActivity 方法</span></span><br><span class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                    token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                    requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mActivityMonitors</code> 是 <code>ActivityMonitor</code> 的一个集合，该类用来监控应用中的单个活动，可监控一些指定的意图。一般在一些测试Case时使用。创建 <code>ActivityMonitor</code> 实例后，通过调用 <code>ActivityInstrumentationTestCase2</code> 的 <code>getInstrumentation()</code> 方法获取 <code>Instrumentation</code> 实例，然后通过 <code>addMonitor</code> 方法添加这个实例，当目标活动启动后，系统会匹配 <code>Instrumentation</code> 中的 <code>ActivityMonitor</code> 实例列表，如果匹配，就会累加计数器。</p>
<h3 id="ActivityManagerService的处理"><a href="#ActivityManagerService的处理" class="headerlink" title="ActivityManagerService的处理"></a>ActivityManagerService的处理</h3><h4 id="ActivityManagerService-startActivityAsUser"><a href="#ActivityManagerService-startActivityAsUser" class="headerlink" title="ActivityManagerService.startActivityAsUser"></a>ActivityManagerService.startActivityAsUser</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">    userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">            resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">            profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, options, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里开始就在AMS进程中执行了，下面简单介绍一下这些参数代表的意义：</p>
<ul>
<li>resultTo： 指调用者Activity的mToken，mToken对象保存它所处的ActivityRecord信息</li>
</ul>
<h4 id="ActivityStackSupervisor-startActivityMayWait"><a href="#ActivityStackSupervisor-startActivityMayWait" class="headerlink" title="ActivityStackSupervisor.startActivityMayWait()"></a>ActivityStackSupervisor.startActivityMayWait()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">         String callingPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">         IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">         IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">         ProfilerInfo profilerInfo, WaitResult outResult, Configuration config,</span></span></span><br><span class="line"><span class="function"><span class="params">         Bundle options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">         IActivityContainer iContainer, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 不允许传递文件描述符</span></span><br><span class="line">     <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors()) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">boolean</span> componentSpecified = intent.getComponent() != <span class="keyword">null</span>;</span><br><span class="line">     <span class="comment">// 重新实例化一个Intent对象，防止对intent的修改</span></span><br><span class="line">     intent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 通过Intent解析Activity信息，最终会调用PackageManagerService.resolveIntent()来查询和选择相关的Activity</span></span><br><span class="line">     <span class="comment">// 如果有多个Activity匹配，那么就会弹框让用户来选择，这部分分析此处省略</span></span><br><span class="line">     ActivityInfo aInfo =</span><br><span class="line">             resolveActivity(intent, resolvedType, startFlags, profilerInfo, userId);</span><br><span class="line"></span><br><span class="line">     ActivityContainer container = (ActivityContainer)iContainer;</span><br><span class="line">     <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">         <span class="comment">// 一般情况下container 为null</span></span><br><span class="line">         <span class="keyword">if</span> (container != <span class="keyword">null</span> &amp;&amp; container.mParentActivity != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                 container.mParentActivity.state != RESUMED) &#123;</span><br><span class="line">             <span class="keyword">return</span> ActivityManager.START_CANCELED;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">final</span> <span class="keyword">int</span> realCallingPid = Binder.getCallingPid();</span><br><span class="line">         <span class="keyword">final</span> <span class="keyword">int</span> realCallingUid = Binder.getCallingUid();</span><br><span class="line">         <span class="keyword">int</span> callingPid;</span><br><span class="line">         <span class="keyword">if</span> (callingUid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">             callingPid = -<span class="number">1</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (caller == <span class="keyword">null</span>) &#123;</span><br><span class="line">             callingPid = realCallingPid;</span><br><span class="line">             callingUid = realCallingUid;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             callingPid = callingUid = -<span class="number">1</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">final</span> ActivityStack stack;</span><br><span class="line">         <span class="keyword">if</span> (container == <span class="keyword">null</span> || container.mStack.isOnHomeDisplay()) &#123;</span><br><span class="line">             <span class="comment">// 一般会走到这里，将当前的ActivityStack赋值给stack</span></span><br><span class="line">             stack = mFocusedStack;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             stack = container.mStack;</span><br><span class="line">         &#125;</span><br><span class="line">         stack.mConfigWillChange = config != <span class="keyword">null</span> &amp;&amp; mService.mConfiguration.diff(config) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (aInfo != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                 (aInfo.applicationInfo.privateFlags</span><br><span class="line">                         &amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">// 处理heavy-weight process，即重量级进程，这种进程在内存不足时不会被kill掉</span></span><br><span class="line">             <span class="comment">// 一般不会走这里</span></span><br><span class="line">             <span class="keyword">if</span> (aInfo.processName.equals(aInfo.applicationInfo.packageName)) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                         (mService.mHeavyWeightProcess.info.uid != aInfo.applicationInfo.uid ||</span><br><span class="line">                         !mService.mHeavyWeightProcess.processName.equals(aInfo.processName))) &#123;</span><br><span class="line">                     <span class="keyword">int</span> appCallingUid = callingUid;</span><br><span class="line">…………<span class="comment">//此处代码省略</span></span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">int</span> res = startActivityLocked(caller, intent, resolvedType, aInfo,</span><br><span class="line">                 voiceSession, voiceInteractor, resultTo, resultWho,</span><br><span class="line">                 requestCode, callingPid, callingUid, callingPackage,</span><br><span class="line">                 realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity,</span><br><span class="line">                 componentSpecified, <span class="keyword">null</span>, container, inTask);</span><br><span class="line"></span><br><span class="line">         Binder.restoreCallingIdentity(origId);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (stack.mConfigWillChange) &#123;</span><br><span class="line">             <span class="comment">// 一般不会走这里</span></span><br><span class="line">             …………</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="comment">// 一般不会走这里</span></span><br><span class="line">             ……</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> res;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-startActivityLocked"><a href="#ActivityStackSupervisor-startActivityLocked" class="headerlink" title="ActivityStackSupervisor.startActivityLocked()"></a>ActivityStackSupervisor.startActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, ActivityInfo aInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags, Bundle options,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityContainer container, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class="line"></span><br><span class="line">    ProcessRecord callerApp = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取调用者所在的ProcessRecord</span></span><br><span class="line">        callerApp = mService.getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            callingPid = callerApp.pid;</span><br><span class="line">            callingUid = callerApp.info.uid;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = ActivityManager.START_PERMISSION_DENIED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取userId，如果是管理员用户该值为0</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = aInfo != <span class="keyword">null</span> ? UserHandle.getUserId(aInfo.applicationInfo.uid) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS) &#123;</span><br><span class="line">        <span class="comment">// 打印一些信息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ActivityRecord sourceRecord = <span class="keyword">null</span>;</span><br><span class="line">    ActivityRecord resultRecord = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// resultTo为调用者Activity的mToken，保存了它所处的ActivityRecord信息</span></span><br><span class="line">    <span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取调用者Activity所对用的ActivityRecord</span></span><br><span class="line">        sourceRecord = isInAnyStackLocked(resultTo);</span><br><span class="line">        <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果需要返回结果，即requestCode不为-1，赋值resultRecord</span></span><br><span class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</span><br><span class="line">                resultRecord = sourceRecord;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> launchFlags = intent.getFlags();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class="number">0</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 对Intent.FLAG_ACTIVITY_FORWARD_RESULT处理，如果设置了这个flag，执行结果相当于透传</span></span><br><span class="line">        <span class="comment">// 比如Activity启动顺序A-&gt;B-&gt;C，那么C的结果将直接返回给A</span></span><br><span class="line">        …………<span class="comment">//此处代码忽略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        err = ActivityManager.START_INTENT_NOT_RESOLVED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果待启动的Activity没有在Manifestfest中显示声明，就会有这个error</span></span><br><span class="line">        err = ActivityManager.START_CLASS_NOT_FOUND;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS</span><br><span class="line">            &amp;&amp; !isCurrentProfileLocked(userId)</span><br><span class="line">            &amp;&amp; (aInfo.flags &amp; FLAG_SHOW_FOR_ALL_USERS) == <span class="number">0</span>) &#123;</span><br><span class="line">        err = ActivityManager.START_NOT_CURRENT_USER_ACTIVITY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; sourceRecord.task.voiceSession != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ……</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; voiceSession != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ……</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ActivityStack resultStack = resultRecord == <span class="keyword">null</span> ? <span class="keyword">null</span> : resultRecord.task.stack;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != ActivityManager.START_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resultStack.sendActivityResultLocked(-<span class="number">1</span>,</span><br><span class="line">                resultRecord, resultWho, requestCode,</span><br><span class="line">                Activity.RESULT_CANCELED, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ActivityOptions.abort(options);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> abort = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> startAnyPerm = mService.checkPermission(</span><br><span class="line">            START_ANY_ACTIVITY, callingPid, callingUid);</span><br><span class="line"></span><br><span class="line">    执行一系列的权限检查</span><br><span class="line">    …………</span><br><span class="line"></span><br><span class="line">    abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</span><br><span class="line">            callingPid, resolvedType, aInfo.applicationInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mService.mController != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// The Intent we give to the watcher has the extra data</span></span><br><span class="line">            <span class="comment">// stripped off, since it can contain private information.</span></span><br><span class="line">            Intent watchIntent = intent.cloneFilter();</span><br><span class="line">            abort |= !mService.mController.activityStarting(watchIntent,</span><br><span class="line">                    aInfo.applicationInfo.packageName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            mService.mController = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (abort) &#123;</span><br><span class="line">        <span class="comment">// 权限检查不通过就退出</span></span><br><span class="line">        <span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resultStack.sendActivityResultLocked(-<span class="number">1</span>, resultRecord, resultWho, requestCode,</span><br><span class="line">                    Activity.RESULT_CANCELED, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ActivityOptions.abort(options);</span><br><span class="line">        <span class="keyword">return</span> ActivityManager.START_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新建一个ActivityRecord，对应将要启动的Activity</span></span><br><span class="line">    ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</span><br><span class="line">            intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</span><br><span class="line">            requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, <span class="keyword">this</span>, container, options);</span><br><span class="line">    <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        outActivity[<span class="number">0</span>] = r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.appTimeTracker == <span class="keyword">null</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.appTimeTracker = sourceRecord.appTimeTracker;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前的ActivityStack</span></span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = mFocusedStack;</span><br><span class="line">    <span class="keyword">if</span> (voiceSession == <span class="keyword">null</span> &amp;&amp; (stack.mResumedActivity == <span class="keyword">null</span></span><br><span class="line">            || stack.mResumedActivity.info.applicationInfo.uid != callingUid)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mService.checkAppSwitchAllowedLocked(callingPid, callingUid,</span><br><span class="line">                realCallingPid, realCallingUid, <span class="string">"Activity start"</span>)) &#123;</span><br><span class="line">            PendingActivityLaunch pal =</span><br><span class="line">                    <span class="keyword">new</span> PendingActivityLaunch(r, sourceRecord, startFlags, stack);</span><br><span class="line">            mPendingActivityLaunches.add(pal);</span><br><span class="line">            ActivityOptions.abort(options);</span><br><span class="line">            <span class="keyword">return</span> ActivityManager.START_SWITCHES_CANCELED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mService.mDidAppSwitch) &#123;</span><br><span class="line">        mService.mAppSwitchesAllowedTime = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mService.mDidAppSwitch = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line">            startFlags, <span class="keyword">true</span>, options, inTask);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        notifyActivityDrawnForKeyguard();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-startActivityUncheckedLocked"><a href="#ActivityStackSupervisor-startActivityUncheckedLocked" class="headerlink" title="ActivityStackSupervisor.startActivityUncheckedLocked()"></a>ActivityStackSupervisor.startActivityUncheckedLocked()</h4><p>参数中 r 代表即将要启动的 <code>Activity</code> 对应的 <code>ActivityRecord</code>，<code>sourceRecord</code> 代表调用者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityUncheckedLocked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> doResume, Bundle options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Intent intent = r.intent;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = r.launchedFromUid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果指定的inTask不在Recents列表中，认为inTask是无效的</span></span><br><span class="line">    <span class="comment">// inTask不为空，表示调用者希望在指定的task里面启动activity</span></span><br><span class="line">    <span class="comment">// 一般情况下为null</span></span><br><span class="line">    <span class="keyword">if</span> (inTask != <span class="keyword">null</span> &amp;&amp; !inTask.inRecents) &#123;</span><br><span class="line">        inTask = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 被启动Activity的启动模式</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTop = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleInstance = r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTask = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> launchFlags = intent.getFlags();</span><br><span class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_DOCUMENT) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (launchSingleInstance || launchSingleTask)) &#123;</span><br><span class="line">        <span class="comment">//当Inent中定义的launch flag和manifest中定义的有冲突的话优先使用manifest中定义的</span></span><br><span class="line">        launchFlags &amp;=</span><br><span class="line">                ~(Intent.FLAG_ACTIVITY_NEW_DOCUMENT | Intent.FLAG_ACTIVITY_MULTIPLE_TASK);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (r.info.documentLaunchMode) &#123;</span><br><span class="line">            <span class="keyword">case</span> ActivityInfo.DOCUMENT_LAUNCH_NONE:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ActivityInfo.DOCUMENT_LAUNCH_INTO_EXISTING:</span><br><span class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_DOCUMENT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ActivityInfo.DOCUMENT_LAUNCH_ALWAYS:</span><br><span class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_DOCUMENT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ActivityInfo.DOCUMENT_LAUNCH_NEVER:</span><br><span class="line">                launchFlags &amp;= ~Intent.FLAG_ACTIVITY_MULTIPLE_TASK;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 是否为后台启动任务的标志位</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchTaskBehind = r.mLaunchTaskBehind</span><br><span class="line">            &amp;&amp; !launchSingleTask &amp;&amp; !launchSingleInstance</span><br><span class="line">            &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_DOCUMENT) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span> &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; r.resultTo.task.stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果需要返回结果，但是此时的launchFlags有FLAG_ACTIVITY_NEW_TASK，则取消返回结果</span></span><br><span class="line">        r.resultTo.task.stack.sendActivityResultLocked(-<span class="number">1</span>,</span><br><span class="line">                r.resultTo, r.resultWho, r.requestCode,</span><br><span class="line">                Activity.RESULT_CANCELED, <span class="keyword">null</span>);</span><br><span class="line">        r.resultTo = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_DOCUMENT) != <span class="number">0</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 赋予FLAG_ACTIVITY_NEW_TASK标志</span></span><br><span class="line">        launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果设置了android:documentLaunchMode为always，那么设置FLAG_ACTIVITY_MULTIPLE_TASK标志</span></span><br><span class="line">        <span class="comment">// 即使在其他task里面有该Activity以及启动，仍然新建Task再次启动一个Activity</span></span><br><span class="line">        <span class="keyword">if</span> (launchTaskBehind</span><br><span class="line">                || r.info.documentLaunchMode == ActivityInfo.DOCUMENT_LAUNCH_ALWAYS) &#123;</span><br><span class="line">            launchFlags |= Intent.FLAG_ACTIVITY_MULTIPLE_TASK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断一下是否是用户的行为，比如用户按下Home键等等</span></span><br><span class="line">    <span class="comment">// 如果是用户的行为的话Activity跳转的时候是要调用onUserLeaveHint()方法的</span></span><br><span class="line">    mUserLeaving = (launchFlags &amp; Intent.FLAG_ACTIVITY_NO_USER_ACTION) == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果设置了不需要resume，那么设置延迟resume标志</span></span><br><span class="line">    <span class="keyword">if</span> (!doResume) &#123;</span><br><span class="line">        r.delayedResume = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FLAG_ACTIVITY_PREVIOUS_IS_TOP标志来决定待启动Activity会不会被作为栈顶，</span></span><br><span class="line">    <span class="comment">// 如果调用者希望待启动的Activity马上销毁，就会使用该启动参数。</span></span><br><span class="line">    <span class="comment">// 通常情况下notTop为null</span></span><br><span class="line">    ActivityRecord notTop =</span><br><span class="line">            (launchFlags &amp; Intent.FLAG_ACTIVITY_PREVIOUS_IS_TOP) != <span class="number">0</span> ? r : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">        ActivityRecord checkedCaller = sourceRecord;</span><br><span class="line">        <span class="keyword">if</span> (checkedCaller == <span class="keyword">null</span>) &#123;</span><br><span class="line">            checkedCaller = mFocusedStack.topRunningNonDelayedActivityLocked(notTop);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!checkedCaller.realActivity.equals(r.realActivity)) &#123;</span><br><span class="line">            <span class="comment">// 如果调用者和被调用者不是同一个Activity，去掉这个标志，因为这个时候都需要启动</span></span><br><span class="line">            startFlags &amp;= ~ActivityManager.START_FLAG_ONLY_IF_NEEDED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> addingToTask = <span class="keyword">false</span>;<span class="comment">//表示是否需要在inTask中启动activity</span></span><br><span class="line">    TaskRecord reuseTask = <span class="keyword">null</span>;<span class="comment">//表示可以复用的task</span></span><br><span class="line">    <span class="comment">//当调用者不是来自activity，而是明确指定task的情况。</span></span><br><span class="line">    <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> &amp;&amp; inTask != <span class="keyword">null</span> &amp;&amp; inTask.stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Intent baseIntent = inTask.getBaseIntent();</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord root = inTask.getRootActivity();</span><br><span class="line">        </span><br><span class="line">        ……</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果inTask是个空的task，从baseIntent里面挑选出一些flag设置到launchFlags</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flagsOfInterest = Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">                    | Intent.FLAG_ACTIVITY_MULTIPLE_TASK | Intent.FLAG_ACTIVITY_NEW_DOCUMENT</span><br><span class="line">                    | Intent.FLAG_ACTIVITY_RETAIN_IN_RECENTS;</span><br><span class="line">            launchFlags = (launchFlags&amp;~flagsOfInterest)</span><br><span class="line">                    | (baseIntent.getFlags()&amp;flagsOfInterest);</span><br><span class="line">            intent.setFlags(launchFlags);</span><br><span class="line">            inTask.setIntent(r);</span><br><span class="line">            addingToTask = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果inTask非空，launchFlags要求在新task里面启动那么就不加入到这个task里面去</span></span><br><span class="line">            addingToTask = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 其他情况就加入到inTask</span></span><br><span class="line">            addingToTask = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果inTask不为空，就作为复用的task</span></span><br><span class="line">        reuseTask = inTask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        inTask = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 当没有指定task</span></span><br><span class="line">        <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 调用者不是一个activity，那么就在一个新的task里面启动activity</span></span><br><span class="line">            <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span> &amp;&amp; inTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class="line">            <span class="comment">// 如果调用者是一个activity，而且调用者的启动模式是LAUNCH_SINGLE_INSTANCE，</span></span><br><span class="line">            <span class="comment">// 那么也需要在新的task里面启动</span></span><br><span class="line">            launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (launchSingleInstance || launchSingleTask) &#123;</span><br><span class="line">            <span class="comment">// 启动标志位里面是SingleInstance或者launchSingleTask，也需要在新task里面启动</span></span><br><span class="line">            launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ActivityInfo newTaskInfo = <span class="keyword">null</span>;</span><br><span class="line">    Intent newTaskIntent = <span class="keyword">null</span>;</span><br><span class="line">    ActivityStack sourceStack;</span><br><span class="line">    <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sourceRecord.finishing) &#123;</span><br><span class="line">            <span class="comment">// 如果调用者activity处于正在销毁的状态，那么就需要在新的task里启动</span></span><br><span class="line">            <span class="comment">// 并且保存一些调用者的信息，并把sourceRecord和sourceStack置空</span></span><br><span class="line">            <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span>) &#123;</span><br><span class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">                newTaskInfo = sourceRecord.info;</span><br><span class="line">                newTaskIntent = sourceRecord.task.intent;</span><br><span class="line">            &#125;</span><br><span class="line">            sourceRecord = <span class="keyword">null</span>;</span><br><span class="line">            sourceStack = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果不在销毁状态，把其所在的栈赋于sourceStack</span></span><br><span class="line">            sourceStack = sourceRecord.task.stack;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sourceStack = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> movedHome = <span class="keyword">false</span>;</span><br><span class="line">    ActivityStack targetStack;</span><br><span class="line">    <span class="comment">// 至此，启动参数的修正工作结束，设置给intent</span></span><br><span class="line">    intent.setFlags(launchFlags);</span><br><span class="line">    <span class="comment">// 看是否需要动画</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> noAnimation = (launchFlags &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FLAG_ACTIVITY_NEW_TASK &amp;&amp; FLAG_ACTIVITY_MULTIPLE_TASK 表示不是在当前任务中启动，</span></span><br><span class="line">    <span class="comment">// 但是要查看是否有目标Activity已经存在的任务，同launchSingleInstance和launchSingleTask</span></span><br><span class="line">    <span class="keyword">if</span> (((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (launchFlags &amp; Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</span><br><span class="line">            || launchSingleInstance || launchSingleTask) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (inTask == <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 在没有指定task且不要返回结果的情况下，去查找是否有匹配的activity</span></span><br><span class="line">            <span class="comment">// findTaskLocked是找到匹配的目标ActivityRecord所在的任务栈(TaskRecord)，包含taskAffinity的操作</span></span><br><span class="line">            <span class="comment">// 这个方法后面会详细介绍</span></span><br><span class="line">            <span class="comment">// 从栈顶至栈底遍历ActivityStack中的所有Activity，根据Intent和ActivityInfo这</span></span><br><span class="line">            <span class="comment">// 两个参数得到的Activity的包名</span></span><br><span class="line">            ActivityRecord intentActivity = !launchSingleInstance ?</span><br><span class="line">                    findTaskLocked(r) : findActivityLocked(intent, r.info);</span><br><span class="line">            <span class="keyword">if</span> (intentActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// intentActivity不为空表示找到目标activity，那么目标Activity所在的任务(TaskRecord)</span></span><br><span class="line">                <span class="comment">// 和任务所在的栈(ActivityRecord)就是宿主任务和宿主栈</span></span><br><span class="line">                <span class="comment">// 这里通过isLockTaskModeViolation锁定屏幕的那些Task</span></span><br><span class="line">                <span class="keyword">if</span> (isLockTaskModeViolation(intentActivity.task,</span><br><span class="line">                        (launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</span><br><span class="line">                        == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))) &#123;</span><br><span class="line">                    <span class="comment">// 如果不是锁定的task，就结束启动流程</span></span><br><span class="line">                    <span class="comment">// lock task mode 是Android 5.0 Lollipop添加的功能</span></span><br><span class="line">                    showLockTaskToast();</span><br><span class="line">                    <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (r.task == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r.task = intentActivity.task;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (intentActivity.task.intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    intentActivity.task.setIntent(r);</span><br><span class="line">                &#125;</span><br><span class="line">                targetStack = intentActivity.task.stack;</span><br><span class="line">                targetStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果目标task不在前台就需要把它移至前台</span></span><br><span class="line">                <span class="comment">// 这里首先获取焦点所在的栈</span></span><br><span class="line">                <span class="keyword">final</span> ActivityStack focusStack = getFocusedStack();</span><br><span class="line">                <span class="comment">//从焦点栈里面找到当前可见的ActivityRecord</span></span><br><span class="line">                ActivityRecord curTop = (focusStack == <span class="keyword">null</span>)</span><br><span class="line">                        ? <span class="keyword">null</span> : focusStack.topRunningNonDelayedActivityLocked(notTop);</span><br><span class="line">                <span class="keyword">boolean</span> movedToFront = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (curTop != <span class="keyword">null</span> &amp;&amp; (curTop.task != intentActivity.task ||</span><br><span class="line">                        curTop.task != focusStack.topTask())) &#123;</span><br><span class="line">                    <span class="comment">// 满足上面的条件表示待启动的activity和当前可见activity不在同一个task</span></span><br><span class="line">                    <span class="comment">// 那么就需要将待启动的activity所在的栈移动到前台</span></span><br><span class="line">                    r.intent.addFlags(Intent.FLAG_ACTIVITY_BROUGHT_TO_FRONT);</span><br><span class="line">                    <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> || (sourceStack.topActivity() != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                            sourceStack.topActivity().task == sourceRecord.task)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            intentActivity.setTaskToAffiliateWith(sourceRecord.task);</span><br><span class="line">                        &#125;</span><br><span class="line">                        movedHome = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="comment">// 将目标任务移动到栈顶</span></span><br><span class="line">                        targetStack.moveTaskToFrontLocked(intentActivity.task, noAnimation,</span><br><span class="line">                                options, r.appTimeTracker, <span class="string">"bringingFoundTaskToFront"</span>);</span><br><span class="line">                        movedToFront = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((launchFlags &amp;</span><br><span class="line">                                (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</span><br><span class="line">                                == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</span><br><span class="line">                            <span class="comment">//将toReturnTo设置为home</span></span><br><span class="line">                            intentActivity.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</span><br><span class="line">                        &#125;</span><br><span class="line">                        options = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!movedToFront) &#123;</span><br><span class="line">                    <span class="comment">// 将当前栈移动到前台</span></span><br><span class="line">                    targetStack.moveToFront(<span class="string">"intentActivityFound"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 根据需要重置activity所在的task</span></span><br><span class="line">                <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">                    intentActivity = targetStack.resetTaskIfNeededLocked(intentActivity, r);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果不需要启动一个新的activity，结束启动流程</span></span><br><span class="line">                    <span class="keyword">if</span> (doResume) &#123;</span><br><span class="line">                        resumeTopActivitiesLocked(targetStack, <span class="keyword">null</span>, options);</span><br><span class="line">                        <span class="comment">// 如果没有移动到前台，通知Keyguard</span></span><br><span class="line">                        <span class="keyword">if</span> (!movedToFront) &#123;</span><br><span class="line">                            notifyActivityDrawnForKeyguard();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ActivityOptions.abort(options);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</span><br><span class="line">                        == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK)) &#123;</span><br><span class="line">                    <span class="comment">// 这里需要移除目标task中所有关联的其他activity，即要完全替代目标task</span></span><br><span class="line">                    <span class="comment">// 将该启动activity变为task中的根activity</span></span><br><span class="line">                    reuseTask = intentActivity.task;</span><br><span class="line">                    reuseTask.performClearTaskLocked();</span><br><span class="line">                    reuseTask.setIntent(r);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span></span><br><span class="line">                        || launchSingleInstance || launchSingleTask) &#123;</span><br><span class="line">                    <span class="comment">// 清除task中目标activity上面的所有activity，返回目标activity</span></span><br><span class="line">                    ActivityRecord top =</span><br><span class="line">                            intentActivity.task.performClearTaskLocked(r, launchFlags);</span><br><span class="line">                    <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (top.frontOfTask) &#123;</span><br><span class="line">                            top.task.setIntent(r);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//触发调用onNewIntent()</span></span><br><span class="line">                        top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// A special case: we need to start the activity because it is not</span></span><br><span class="line">                        <span class="comment">// currently running, and the caller has asked to clear the current</span></span><br><span class="line">                        <span class="comment">// task to have this activity at the top.</span></span><br><span class="line">                        addingToTask = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="comment">// Now pretend like this activity is being started by the top of its</span></span><br><span class="line">                        <span class="comment">// task, so it is put in the right place.</span></span><br><span class="line">                        sourceRecord = intentActivity;</span><br><span class="line">                        TaskRecord task = sourceRecord.task;</span><br><span class="line">                        <span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; task.stack == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// Target stack got cleared when we all activities were removed</span></span><br><span class="line">                            <span class="comment">// above. Go ahead and reset it.</span></span><br><span class="line">                            targetStack = computeStackFocus(sourceRecord, <span class="keyword">false</span> <span class="comment">/* newTask */</span>);</span><br><span class="line">                            targetStack.addTask(</span><br><span class="line">                                    task, !launchTaskBehind <span class="comment">/* toTop */</span>, <span class="keyword">false</span> <span class="comment">/* moving */</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.realActivity.equals(intentActivity.task.realActivity)) &#123;</span><br><span class="line">                    <span class="comment">// In this case the top activity on the task is the</span></span><br><span class="line">                    <span class="comment">// same as the one being launched, so we take that</span></span><br><span class="line">                    <span class="comment">// as a request to bring the task to the foreground.</span></span><br><span class="line">                    <span class="comment">// If the top activity in the task is the root</span></span><br><span class="line">                    <span class="comment">// activity, deliver this new intent to it if it</span></span><br><span class="line">                    <span class="comment">// desires.</span></span><br><span class="line">                    <span class="keyword">if</span> (((launchFlags&amp;Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span> || launchSingleTop)</span><br><span class="line">                            &amp;&amp; intentActivity.realActivity.equals(r.realActivity)) &#123;</span><br><span class="line">                        ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r,</span><br><span class="line">                                intentActivity.task);</span><br><span class="line">                        <span class="keyword">if</span> (intentActivity.frontOfTask) &#123;</span><br><span class="line">                            intentActivity.task.setIntent(r);</span><br><span class="line">                        &#125;</span><br><span class="line">                        intentActivity.deliverNewIntentLocked(callingUid, r.intent,</span><br><span class="line">                                r.launchedFromPackage);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!r.intent.filterEquals(intentActivity.task.intent)) &#123;</span><br><span class="line">                        <span class="comment">// In this case we are launching the root activity</span></span><br><span class="line">                        <span class="comment">// of the task, but with a different intent.  We</span></span><br><span class="line">                        <span class="comment">// should start a new instance on top.</span></span><br><span class="line">                        addingToTask = <span class="keyword">true</span>;</span><br><span class="line">                        sourceRecord = intentActivity;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// In this case an activity is being launched in to an</span></span><br><span class="line">                    <span class="comment">// existing task, without resetting that task.  This</span></span><br><span class="line">                    <span class="comment">// is typically the situation of launching an activity</span></span><br><span class="line">                    <span class="comment">// from a notification or shortcut.  We want to place</span></span><br><span class="line">                    <span class="comment">// the new activity on top of the current task.</span></span><br><span class="line">                    addingToTask = <span class="keyword">true</span>;</span><br><span class="line">                    sourceRecord = intentActivity;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!intentActivity.task.rootWasReset) &#123;</span><br><span class="line">                    <span class="comment">// In this case we are launching in to an existing task</span></span><br><span class="line">                    <span class="comment">// that has not yet been started from its front door.</span></span><br><span class="line">                    <span class="comment">// The current task has been brought to the front.</span></span><br><span class="line">                    <span class="comment">// Ideally, we'd probably like to place this new task</span></span><br><span class="line">                    <span class="comment">// at the bottom of its stack, but that's a little hard</span></span><br><span class="line">                    <span class="comment">// to do with the current organization of the code so</span></span><br><span class="line">                    <span class="comment">// for now we'll just drop it.</span></span><br><span class="line">                    intentActivity.task.setIntent(r);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!addingToTask &amp;&amp; reuseTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果不需要加入指定的task，且不用复用task，那么直接把找到的目标activity推到前台</span></span><br><span class="line">                    <span class="comment">// 并结束启动流程</span></span><br><span class="line">                    <span class="keyword">if</span> (doResume) &#123;</span><br><span class="line">                        targetStack.resumeTopActivityLocked(<span class="keyword">null</span>, options);</span><br><span class="line">                        <span class="keyword">if</span> (!movedToFront) &#123;</span><br><span class="line">                            notifyActivityDrawnForKeyguard();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ActivityOptions.abort(options);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="comment">//end of (intentActivity != null)</span></span><br><span class="line">        &#125;<span class="comment">//end of (inTask == null &amp;&amp; r.resultTo == null)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 待启动activity包名不为空</span></span><br><span class="line">        ActivityStack topStack = mFocusedStack;</span><br><span class="line">        ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(notTop);</span><br><span class="line">        <span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</span><br><span class="line">                <span class="comment">// 待启动的activity和前台显示的activity是同一个activity的情况</span></span><br><span class="line">                <span class="keyword">if</span> (top.app != <span class="keyword">null</span> &amp;&amp; top.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></span><br><span class="line">                        || launchSingleTop || launchSingleTask) &#123;</span><br><span class="line">                        ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top,</span><br><span class="line">                                top.task);</span><br><span class="line">                        topStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">if</span> (doResume) &#123;</span><br><span class="line">                            resumeTopActivitiesLocked();</span><br><span class="line">                        &#125;</span><br><span class="line">                        ActivityOptions.abort(options);</span><br><span class="line">                        <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</span><br><span class="line">                        &#125;</span><br><span class="line">                        top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</span><br><span class="line">                        <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果目标activity包名为空，表示找不到待启动的activity，结束启动流程</span></span><br><span class="line">        <span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span> &amp;&amp; r.resultTo.task.stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.resultTo.task.stack.sendActivityResultLocked(-<span class="number">1</span>, r.resultTo, r.resultWho,</span><br><span class="line">                    r.requestCode, Activity.RESULT_CANCELED, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ActivityOptions.abort(options);</span><br><span class="line">        <span class="keyword">return</span> ActivityManager.START_CLASS_NOT_FOUND;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>目标activity不存在的情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 接下来处理目标activity不存在的情况</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> keepCurTransition = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    TaskRecord taskToAffiliate = launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span> ?</span><br><span class="line">            sourceRecord.task : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span> &amp;&amp; inTask == <span class="keyword">null</span> &amp;&amp; !addingToTask</span><br><span class="line">            &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 这种情况下要在一个新的task中启动activity</span></span><br><span class="line">        newTask = <span class="keyword">true</span>;</span><br><span class="line">        targetStack = computeStackFocus(r, newTask);</span><br><span class="line">        targetStack.moveToFront(<span class="string">"startingNewTask"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (reuseTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果没有可以复用的就新建一个</span></span><br><span class="line">            r.setTask(targetStack.createTaskRecord(getNextTaskId(),</span><br><span class="line">                    newTaskInfo != <span class="keyword">null</span> ? newTaskInfo : r.info,</span><br><span class="line">                    newTaskIntent != <span class="keyword">null</span> ? newTaskIntent : intent,</span><br><span class="line">                    voiceSession, voiceInteractor, !launchTaskBehind <span class="comment">/* toTop */</span>),</span><br><span class="line">                    taskToAffiliate);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 复用task</span></span><br><span class="line">            r.setTask(reuseTask, taskToAffiliate);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isLockTaskModeViolation(r.task)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!movedHome) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((launchFlags &amp;</span><br><span class="line">                    (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</span><br><span class="line">                    == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</span><br><span class="line">                <span class="comment">// 把当前新启动的任务置于Home任务之上，也就是按back键从这个任务返回的时候</span></span><br><span class="line">                <span class="comment">// 会回到home，即使这个不是他们最后看见的activity</span></span><br><span class="line">                r.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 不用在新task中启动activity</span></span><br><span class="line">        <span class="keyword">final</span> TaskRecord sourceTask = sourceRecord.task;</span><br><span class="line">        <span class="keyword">if</span> (isLockTaskModeViolation(sourceTask)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 那么目标activity的栈也就是调用者所在的栈</span></span><br><span class="line">        targetStack = sourceTask.stack;</span><br><span class="line">        targetStack.moveToFront(<span class="string">"sourceStackToFront"</span>);</span><br><span class="line">        <span class="keyword">final</span> TaskRecord topTask = targetStack.topTask();</span><br><span class="line">        <span class="keyword">if</span> (topTask != sourceTask) &#123;</span><br><span class="line">            <span class="comment">// 移动task到前台</span></span><br><span class="line">            targetStack.moveTaskToFrontLocked(sourceTask, noAnimation, options,</span><br><span class="line">                    r.appTimeTracker, <span class="string">"sourceTaskToFront"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!addingToTask &amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 清除activity</span></span><br><span class="line">            ActivityRecord top = sourceTask.performClearTaskLocked(r, launchFlags);</span><br><span class="line">            keepCurTransition = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, top.task);</span><br><span class="line">                top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</span><br><span class="line">                targetStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (doResume) &#123;</span><br><span class="line">                    targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ActivityOptions.abort(options);</span><br><span class="line">                <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!addingToTask &amp;&amp;</span><br><span class="line">                (launchFlags&amp;Intent.FLAG_ACTIVITY_REORDER_TO_FRONT) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityRecord top = sourceTask.findActivityInHistoryLocked(r);</span><br><span class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> TaskRecord task = top.task;</span><br><span class="line">                task.moveActivityToFrontLocked(top);</span><br><span class="line">                ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, task);</span><br><span class="line">                top.updateOptionsLocked(options);</span><br><span class="line">                top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</span><br><span class="line">                targetStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (doResume) &#123;</span><br><span class="line">                    targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        r.setTask(sourceTask, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 在指定的task中启动activity</span></span><br><span class="line">        <span class="keyword">if</span> (isLockTaskModeViolation(inTask)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class="line">        &#125;</span><br><span class="line">        targetStack = inTask.stack;</span><br><span class="line">        targetStack.moveTaskToFrontLocked(inTask, noAnimation, options, r.appTimeTracker,</span><br><span class="line">                <span class="string">"inTaskToFront"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// check一下是在这个task中启动一个新的activity或者是复用当前栈顶的activity</span></span><br><span class="line">        ActivityRecord top = inTask.getTopActivity();</span><br><span class="line">        <span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></span><br><span class="line">                    || launchSingleTop || launchSingleTask) &#123;</span><br><span class="line">                ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top, top.task);</span><br><span class="line">                <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</span><br><span class="line">                &#125;</span><br><span class="line">                top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</span><br><span class="line">                <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!addingToTask) &#123;</span><br><span class="line">            ActivityOptions.abort(options);</span><br><span class="line">            <span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.setTask(inTask, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 既不启动一个新的activity，也不在指定的task中启动</span></span><br><span class="line">        <span class="comment">// 目前不会走到这个分支中</span></span><br><span class="line">        targetStack = computeStackFocus(r, newTask);</span><br><span class="line">        targetStack.moveToFront(<span class="string">"addingToTopTask"</span>);</span><br><span class="line">        ActivityRecord prev = targetStack.topActivity();</span><br><span class="line">        r.setTask(prev != <span class="keyword">null</span> ? prev.task : targetStack.createTaskRecord(getNextTaskId(),</span><br><span class="line">                        r.info, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">true</span>), <span class="keyword">null</span>);</span><br><span class="line">        mWindowManager.moveTaskToTop(r.task.taskId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</span><br><span class="line">            intent, r.getUriPermissionsLocked(), r.userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span> &amp;&amp; sourceRecord.isRecentsActivity()) &#123;</span><br><span class="line">        r.task.setTaskToReturnTo(RECENTS_ACTIVITY_TYPE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newTask) &#123;</span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_CREATE_TASK, r.userId, r.task.taskId);</span><br><span class="line">    &#125;</span><br><span class="line">    ActivityStack.logStartActivity(EventLogTags.AM_CREATE_ACTIVITY, r, r.task);</span><br><span class="line">    targetStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 进行下一步流程，启动activity</span></span><br><span class="line">    targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options);</span><br><span class="line">    <span class="keyword">if</span> (!launchTaskBehind) &#123;</span><br><span class="line">        <span class="comment">// 如果不是在后台启动就把焦点设置在当前activity</span></span><br><span class="line">        mService.setFocusedActivityLocked(r, <span class="string">"startedActivity"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ActivityManager.START_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这个方法首先是修正了一些启动参数，接着根据目标Activity是否存在分别进行了处理，然后启动activity。</p>
<h4 id="ActivityStack-startActivityLocked"><a href="#ActivityStack-startActivityLocked" class="headerlink" title="ActivityStack.startActivityLocked()"></a>ActivityStack.startActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options)</span> </span>&#123;</span><br><span class="line">    TaskRecord rTask = r.task;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> taskId = rTask.taskId;</span><br><span class="line">    <span class="keyword">if</span> (!r.mLaunchTaskBehind &amp;&amp; (taskForIdLocked(taskId) == <span class="keyword">null</span> || newTask)) &#123;</span><br><span class="line">        <span class="comment">// 历史activity被清除了或者是明确要求在新的task启动activity</span></span><br><span class="line">        <span class="comment">// 将task插入stack栈顶</span></span><br><span class="line">        insertTaskAtTop(rTask, r);</span><br><span class="line">        <span class="comment">// 调用WindowManagerService </span></span><br><span class="line">        mWindowManager.moveTaskToTop(taskId);</span><br><span class="line">    &#125;</span><br><span class="line">    TaskRecord task = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!newTask) &#123;</span><br><span class="line">        <span class="comment">// 在一个已经存在的task中启动activity</span></span><br><span class="line">        <span class="keyword">boolean</span> startIt = <span class="keyword">true</span>;<span class="comment">// 是否需要启动activity的标志位</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">            task = mTaskHistory.get(taskNdx);</span><br><span class="line">            <span class="keyword">if</span> (task.getTopActivity() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//  该task中已经没有activity了</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (task == r.task) &#123;</span><br><span class="line">                <span class="comment">// 匹配到目标task</span></span><br><span class="line">                <span class="keyword">if</span> (!startIt) &#123;</span><br><span class="line">                    <span class="comment">// 如果不需要启动，就先添加到栈顶</span></span><br><span class="line">                    task.addActivityToTop(r);</span><br><span class="line">                    r.putInHistory();</span><br><span class="line">                    <span class="comment">// 调用WindowManagerService 添加apptoken</span></span><br><span class="line">                    mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</span><br><span class="line">                            r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</span><br><span class="line">                            (r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>,</span><br><span class="line">                            r.userId, r.info.configChanges, task.voiceSession != <span class="keyword">null</span>,</span><br><span class="line">                            r.mLaunchTaskBehind);</span><br><span class="line">                    <span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</span><br><span class="line">                        validateAppTokensLocked();</span><br><span class="line">                    &#125;</span><br><span class="line">                    ActivityOptions.abort(options);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.numFullscreen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果在这个任务中有全屏显示的activity，就先不显示</span></span><br><span class="line">                startIt = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 走到这里已经把目标activity所在的task推到了stack的栈顶</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不需要在新的activity中启动，而且上面查到了目标task，且task在栈顶，就不需要调用onUserLeaving方法</span></span><br><span class="line">    <span class="keyword">if</span> (task == r.task &amp;&amp; mTaskHistory.indexOf(task) != (mTaskHistory.size() - <span class="number">1</span>)) &#123;</span><br><span class="line">        mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    task = r.task;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将activity放到task的栈顶</span></span><br><span class="line">    task.addActivityToTop(r);</span><br><span class="line">    <span class="comment">// activity移动或者销毁之后调用setFrontOfTask方法</span></span><br><span class="line">    task.setFrontOfTask();</span><br><span class="line"></span><br><span class="line">    r.putInHistory();</span><br><span class="line">    <span class="keyword">if</span> (!isHomeStack() || numActivities() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 进入这个分支的条件当前stack不是桌面stack，也即当前是否是桌面。或者当前stack中已有task</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一些切换动画相关的操作</span></span><br><span class="line">        <span class="keyword">boolean</span> showStartingIcon = newTask;</span><br><span class="line">        ProcessRecord proc = r.app;</span><br><span class="line">        <span class="keyword">if</span> (proc == <span class="keyword">null</span>) &#123;</span><br><span class="line">            proc = mService.mProcessNames.get(r.processName, r.info.applicationInfo.uid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">            showStartingIcon = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</span><br><span class="line">            mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, keepCurTransition);</span><br><span class="line">            mNoAnimActivities.add(r);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mWindowManager.prepareAppTransition(newTask</span><br><span class="line">                    ? r.mLaunchTaskBehind</span><br><span class="line">                            ? AppTransition.TRANSIT_TASK_OPEN_BEHIND</span><br><span class="line">                            : AppTransition.TRANSIT_TASK_OPEN</span><br><span class="line">                    : AppTransition.TRANSIT_ACTIVITY_OPEN, keepCurTransition);</span><br><span class="line">            mNoAnimActivities.remove(r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用WindowManagerService 添加apptoken</span></span><br><span class="line">        mWindowManager.addAppToken(task.mActivities.indexOf(r),</span><br><span class="line">                r.appToken, r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</span><br><span class="line">                (r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</span><br><span class="line">                r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</span><br><span class="line">        <span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 一些显示StartingWindow的操作</span></span><br><span class="line">        <span class="keyword">if</span> (newTask) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">                resetTaskIfNeededLocked(r, r);</span><br><span class="line">                doShow = topRunningNonDelayedActivityLocked(<span class="keyword">null</span>) == r;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options != <span class="keyword">null</span> &amp;&amp; <span class="keyword">new</span> ActivityOptions(options).getAnimationType()</span><br><span class="line">                == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class="line">            doShow = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class="line">            mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</span><br><span class="line">            ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class="line">            ActivityRecord prev = mResumedActivity;</span><br><span class="line">            <span class="comment">// prev 表示当前在resumed状态的activity</span></span><br><span class="line">            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果它和目标activity不在同一个task</span></span><br><span class="line">                <span class="keyword">if</span> (prev.task != r.task) &#123;</span><br><span class="line">                    prev = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 在同一个task且已经显示</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</span><br><span class="line">                    prev = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mWindowManager.setAppStartingWindow(</span><br><span class="line">                    r.appToken, r.packageName, r.theme,</span><br><span class="line">                    mService.compatibilityInfoForPackageLocked(</span><br><span class="line">                            r.info.applicationInfo), r.nonLocalizedLabel,</span><br><span class="line">                    r.labelRes, r.icon, r.logo, r.windowFlags,</span><br><span class="line">                    prev != <span class="keyword">null</span> ? prev.appToken : <span class="keyword">null</span>, showStartingIcon);</span><br><span class="line">            r.mStartingWindowShown = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 进入这个分支条件：目标stack中还没有任何activity，那就不要做任何动画</span></span><br><span class="line">        <span class="comment">// 调用addAppToken绑定窗口</span></span><br><span class="line">        mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</span><br><span class="line">                r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</span><br><span class="line">                (r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</span><br><span class="line">                r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</span><br><span class="line">        ActivityOptions.abort(options);</span><br><span class="line">        options = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</span><br><span class="line">        validateAppTokensLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 显示activity</span></span><br><span class="line">    <span class="keyword">if</span> (doResume) &#123;</span><br><span class="line">        mStackSupervisor.resumeTopActivitiesLocked(<span class="keyword">this</span>, r, options);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-resumeTopActivitiesLocked"><a href="#ActivityStackSupervisor-resumeTopActivitiesLocked" class="headerlink" title="ActivityStackSupervisor.resumeTopActivitiesLocked()"></a>ActivityStackSupervisor.resumeTopActivitiesLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivitiesLocked</span><span class="params">(ActivityStack targetStack, ActivityRecord target,</span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle targetOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (targetStack == <span class="keyword">null</span>) &#123;</span><br><span class="line">        targetStack = mFocusedStack;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Do targetStack first.</span></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (isFrontStack(targetStack)) &#123;</span><br><span class="line">        result = targetStack.resumeTopActivityLocked(target, targetOptions);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历所有显示设备上的ActivityStack</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</span><br><span class="line">            <span class="keyword">if</span> (stack == targetStack) &#123;</span><br><span class="line">                <span class="comment">// 上面已经处理过</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isFrontStack(stack)) &#123;</span><br><span class="line">                <span class="comment">// 由其他显示设备进行处理</span></span><br><span class="line">                stack.resumeTopActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityStack-resumeTopActivityLocked"><a href="#ActivityStack-resumeTopActivityLocked" class="headerlink" title="ActivityStack.resumeTopActivityLocked()"></a>ActivityStack.resumeTopActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class="line">        <span class="comment">// Don't even start recursing.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 防止递归调用</span></span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) &#123;</span><br><span class="line">            mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN;</span><br><span class="line">            mService.updateSleepIfNeededLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        result = resumeTopActivityInnerLocked(prev, options);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityStack-resumeTopActivityInnerLocked"><a href="#ActivityStack-resumeTopActivityInnerLocked" class="headerlink" title="ActivityStack.resumeTopActivityInnerLocked()"></a>ActivityStack.resumeTopActivityInnerLocked()</h4><p>这里的参数 <code>prev</code> 表示待启动的 <code>ActivityRecord</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mService.mBooting &amp;&amp; !mService.mBooted) &#123;</span><br><span class="line">        <span class="comment">// 如果系统还没有启动结束，这里结束启动流程</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ActivityRecord parent = mActivityContainer.mParentActivity;</span><br><span class="line">    <span class="keyword">if</span> ((parent != <span class="keyword">null</span> &amp;&amp; parent.state != ActivityState.RESUMED) ||</span><br><span class="line">            !mActivityContainer.isAttachedLocked()) &#123;</span><br><span class="line">        <span class="comment">// 如果存在ParentActivity且ParentActivity还没有resume，那么结束启动流程</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在当前activity下面的activity如果有处于INITIALIZING而且正在做窗口动画</span></span><br><span class="line">    <span class="comment">// 那么就取消这些窗口动画</span></span><br><span class="line">    cancelInitializingActivities();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到当前栈顶正在运行的activity，一般表示将要显示的activity</span></span><br><span class="line">    <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> userLeaving = mStackSupervisor.mUserLeaving;</span><br><span class="line">    mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> TaskRecord prevTask = prev != <span class="keyword">null</span> ? prev.task : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 没有将要显示的activity</span></span><br><span class="line">        <span class="keyword">final</span> String reason = <span class="string">"noMoreActivities"</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mFullscreen) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = getNextVisibleStackLocked();</span><br><span class="line">            <span class="keyword">if</span> (adjustFocusToNextVisibleStackLocked(stack, reason)) &#123;</span><br><span class="line">                <span class="keyword">return</span> mStackSupervisor.resumeTopActivitiesLocked(stack, prev, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 显示桌面，结束启动流程</span></span><br><span class="line">        ActivityOptions.abort(options);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> returnTaskType = prevTask == <span class="keyword">null</span> || !prevTask.isOverHomeStack() ?</span><br><span class="line">                HOME_ACTIVITY_TYPE : prevTask.getTaskToReturnTo();</span><br><span class="line">        <span class="keyword">return</span> isOnHomeDisplay() &amp;&amp;</span><br><span class="line">                mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    next.delayedResume = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</span><br><span class="line">                mStackSupervisor.allResumedActivitiesComplete()) &#123;</span><br><span class="line">        <span class="comment">// 当前正在显示的activity就是下一个将要显示的activity，那么结束启动流程</span></span><br><span class="line">        mWindowManager.executeAppTransition();</span><br><span class="line">        mNoAnimActivities.clear();</span><br><span class="line">        ActivityOptions.abort(options);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> TaskRecord nextTask = next.task;</span><br><span class="line">    <span class="keyword">if</span> (prevTask != <span class="keyword">null</span> &amp;&amp; prevTask.stack == <span class="keyword">this</span> &amp;&amp;</span><br><span class="line">            prevTask.isOverHomeStack() &amp;&amp; prev.finishing &amp;&amp; prev.frontOfTask) &#123;</span><br><span class="line">        <span class="keyword">if</span> (prevTask == nextTask) &#123;</span><br><span class="line">            prevTask.setFrontOfTask();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevTask != topTask()) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> taskNdx = mTaskHistory.indexOf(prevTask) + <span class="number">1</span>;</span><br><span class="line">            mTaskHistory.get(taskNdx).setTaskToReturnTo(HOME_ACTIVITY_TYPE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isOnHomeDisplay()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isHomeStack())&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> returnTaskType = prevTask == <span class="keyword">null</span> || !prevTask.isOverHomeStack() ?</span><br><span class="line">                    HOME_ACTIVITY_TYPE : prevTask.getTaskToReturnTo();</span><br><span class="line">            <span class="keyword">return</span> isOnHomeDisplay() &amp;&amp;</span><br><span class="line">                    mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, <span class="string">"prevFinished"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果系统在休眠状态且栈顶activity在pause状态，结束启动流程</span></span><br><span class="line">    <span class="keyword">if</span> (mService.isSleepingOrShuttingDown()</span><br><span class="line">            &amp;&amp; mLastPausedActivity == next</span><br><span class="line">            &amp;&amp; mStackSupervisor.allPausedActivitiesComplete()) &#123;</span><br><span class="line">        mWindowManager.executeAppTransition();</span><br><span class="line">        mNoAnimActivities.clear();</span><br><span class="line">        ActivityOptions.abort(options);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找不到待启动activity的user，结束启动流程</span></span><br><span class="line">    <span class="keyword">if</span> (mService.mStartedUsers.get(next.userId) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从Stopping状态进入休眠状态和待显示状态列表中删除待启动activity</span></span><br><span class="line">    <span class="comment">// 待启动activity有可能处于这些数组中</span></span><br><span class="line">    mStackSupervisor.mStoppingActivities.remove(next);</span><br><span class="line">    mStackSupervisor.mGoingToSleepActivities.remove(next);</span><br><span class="line">    next.sleeping = <span class="keyword">false</span>;</span><br><span class="line">    mStackSupervisor.mWaitingVisibleActivities.remove(next);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果当前正在pause一些activity，那么就要把这些工作做完</span></span><br><span class="line">    <span class="comment">// 这种情况下也会结束启动流程</span></span><br><span class="line">    <span class="keyword">if</span> (!mStackSupervisor.allPausedActivitiesComplete()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>接下来就开始进行一些activity的切换工作，首先要pause当前activity，将待显示的activity进行resume。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置WakeLock，保证在启动过程中系统不会休眠</span></span><br><span class="line">    mStackSupervisor.setLaunchSource(next.info.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始把当前activity进入pause状态，这样才能把待显示activity进入resume状态</span></span><br><span class="line">    <span class="comment">// 如果启动参数里面有FLAG_RESUME_WHILE_PAUSING，表示当前的activity正在pause时，可以执行待显示</span></span><br><span class="line">    <span class="comment">// activity的resume动作</span></span><br><span class="line">    <span class="keyword">boolean</span> dontWaitForPause = (next.info.flags&amp;ActivityInfo.FLAG_RESUME_WHILE_PAUSING) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 开始pause stack里面的activity</span></span><br><span class="line">    <span class="keyword">boolean</span> pausing = mStackSupervisor.pauseBackStacks(userLeaving, <span class="keyword">true</span>, dontWaitForPause);</span><br><span class="line">    <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 把当前正在显示的activity进入pasue状态</span></span><br><span class="line">        pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, <span class="keyword">true</span>, dontWaitForPause);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pausing) &#123;</span><br><span class="line">        <span class="comment">// pausing为true表示当前有正在pause的activity，那么这里先返回，等完全pause再执行后面的操作</span></span><br><span class="line">        <span class="comment">// 一般第一次会走这里，但是在startPausingLocked中发送的消息执行以后还会再次执行这个函数</span></span><br><span class="line">        <span class="comment">// ActivityStack.activityPausedLocked-&gt;ActivityStack.completePauseLocked-&gt;</span></span><br><span class="line">        <span class="comment">// ActivityStackSupervisor.resumeTopActivitiesLocked-&gt;ActivityStack.resumeTopActivityLocked()</span></span><br><span class="line">        <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mService.isSleeping() &amp;&amp; mLastNoHistoryActivity != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            !mLastNoHistoryActivity.finishing) &#123;</span><br><span class="line">        requestFinishActivityLocked(mLastNoHistoryActivity.appToken, Activity.RESULT_CANCELED,</span><br><span class="line">                <span class="keyword">null</span>, <span class="string">"resume-no-history"</span>, <span class="keyword">false</span>);</span><br><span class="line">        mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span> &amp;&amp; prev != next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mStackSupervisor.mWaitingVisibleActivities.contains(prev)</span><br><span class="line">                &amp;&amp; next != <span class="keyword">null</span> &amp;&amp; !next.nowVisible) &#123;</span><br><span class="line">            mStackSupervisor.mWaitingVisibleActivities.add(prev);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (prev.finishing) &#123;</span><br><span class="line">                mWindowManager.setAppVisibility(prev.appToken, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AppGlobals.getPackageManager().setPackageStoppedState(</span><br><span class="line">                next.packageName, <span class="keyword">false</span>, next.userId); <span class="comment">/* <span class="doctag">TODO:</span> Verify if correct userid */</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e1) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> anim = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (prev.finishing) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mNoAnimActivities.contains(prev)) &#123;</span><br><span class="line">                anim = <span class="keyword">false</span>;</span><br><span class="line">                mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mWindowManager.prepareAppTransition(prev.task == next.task</span><br><span class="line">                        ? AppTransition.TRANSIT_ACTIVITY_CLOSE</span><br><span class="line">                        : AppTransition.TRANSIT_TASK_CLOSE, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mWindowManager.setAppWillBeHidden(prev.appToken);</span><br><span class="line">            mWindowManager.setAppVisibility(prev.appToken, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION,</span><br><span class="line">                    <span class="string">"Prepare open transition: prev="</span> + prev);</span><br><span class="line">            <span class="keyword">if</span> (mNoAnimActivities.contains(next)) &#123;</span><br><span class="line">                anim = <span class="keyword">false</span>;</span><br><span class="line">                mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mWindowManager.prepareAppTransition(prev.task == next.task</span><br><span class="line">                        ? AppTransition.TRANSIT_ACTIVITY_OPEN</span><br><span class="line">                        : next.mLaunchTaskBehind</span><br><span class="line">                                ? AppTransition.TRANSIT_TASK_OPEN_BEHIND</span><br><span class="line">                                : AppTransition.TRANSIT_TASK_OPEN, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            mWindowManager.setAppWillBeHidden(prev.appToken);</span><br><span class="line">            mWindowManager.setAppVisibility(prev.appToken, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mNoAnimActivities.contains(next)) &#123;</span><br><span class="line">            anim = <span class="keyword">false</span>;</span><br><span class="line">            mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mWindowManager.prepareAppTransition(AppTransition.TRANSIT_ACTIVITY_OPEN, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Bundle resumeAnimOptions = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (anim) &#123;</span><br><span class="line">        ActivityOptions opts = next.getOptionsForTargetActivityLocked();</span><br><span class="line">        <span class="keyword">if</span> (opts != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resumeAnimOptions = opts.toBundle();</span><br><span class="line">        &#125;</span><br><span class="line">        next.applyOptionsLocked();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next.clearOptionsLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ActivityStack lastStack = mStackSupervisor.getLastStack();</span><br><span class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 走到这个分支说明待启动activity所在的进程已经存在了？</span></span><br><span class="line">        mWindowManager.setAppVisibility(next.appToken, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// schedule launch ticks to collect information about slow apps.</span></span><br><span class="line">        next.startLaunchTickingLocked();</span><br><span class="line"></span><br><span class="line">        ActivityRecord lastResumedActivity =</span><br><span class="line">                lastStack == <span class="keyword">null</span> ? <span class="keyword">null</span> :lastStack.mResumedActivity;</span><br><span class="line">        ActivityState lastState = next.state;</span><br><span class="line"></span><br><span class="line">        mService.updateCpuStats();</span><br><span class="line">        <span class="comment">// 待启动activity状态已经是RESUMED</span></span><br><span class="line">        next.state = ActivityState.RESUMED;</span><br><span class="line">        mResumedActivity = next;</span><br><span class="line">        next.task.touchActiveTime();</span><br><span class="line">        mRecentTasks.addLocked(next.task);</span><br><span class="line">        mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">        updateLRUListLocked(next);</span><br><span class="line">        mService.updateOomAdjLocked();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> notUpdated = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (mStackSupervisor.isFrontStack(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            Configuration config = mWindowManager.updateOrientationFromAppTokens(</span><br><span class="line">                    mService.mConfiguration,</span><br><span class="line">                    next.mayFreezeScreenLocked(next.app) ? next.appToken : <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line">                next.frozenBeforeDestroy = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            notUpdated = !mService.updateConfigurationLocked(config, next, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (notUpdated) &#123;</span><br><span class="line">            ActivityRecord nextNext = topRunningActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (nextNext != next) &#123;</span><br><span class="line">                mStackSupervisor.scheduleResumeTopActivities();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mStackSupervisor.reportResumedActivityLocked(next)) &#123;</span><br><span class="line">                mNoAnimActivities.clear();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ArrayList&lt;ResultInfo&gt; a = next.results;</span><br><span class="line">            <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = a.size();</span><br><span class="line">                <span class="keyword">if</span> (!next.finishing &amp;&amp; N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    next.app.thread.scheduleSendResult(next.appToken, a);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (next.newIntents != <span class="keyword">null</span>) &#123;</span><br><span class="line">                next.app.thread.scheduleNewIntent(next.newIntents, next.appToken);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_RESUME_ACTIVITY, next.userId,</span><br><span class="line">                    System.identityHashCode(next), next.task.taskId, next.shortComponentName);</span><br><span class="line"></span><br><span class="line">            next.sleeping = <span class="keyword">false</span>;</span><br><span class="line">            mService.showAskCompatModeDialogLocked(next);</span><br><span class="line">            next.app.pendingUiClean = <span class="keyword">true</span>;</span><br><span class="line">            next.app.forceProcessStateUpTo(mService.mTopProcessState);</span><br><span class="line">            next.clearOptionsLocked();</span><br><span class="line">            next.app.thread.scheduleResumeActivity(next.appToken, next.app.repProcState,</span><br><span class="line">                    mService.isNextTransitionForward(), resumeAnimOptions);</span><br><span class="line"></span><br><span class="line">            mStackSupervisor.checkReadyForSleepLocked();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Whoops, need to restart this activity!</span></span><br><span class="line">            next.state = lastState;</span><br><span class="line">            <span class="keyword">if</span> (lastStack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lastStack.mResumedActivity = lastResumedActivity;</span><br><span class="line">            &#125;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Restarting because process died: "</span> + next);</span><br><span class="line">            <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</span><br><span class="line">                next.hasBeenLaunched = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span>  <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; lastStack != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    mStackSupervisor.isFrontStack(lastStack)) &#123;</span><br><span class="line">                mWindowManager.setAppStartingWindow(</span><br><span class="line">                        next.appToken, next.packageName, next.theme,</span><br><span class="line">                        mService.compatibilityInfoForPackageLocked(next.info.applicationInfo),</span><br><span class="line">                        next.nonLocalizedLabel, next.labelRes, next.icon, next.logo,</span><br><span class="line">                        next.windowFlags, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            next.visible = <span class="keyword">true</span>;</span><br><span class="line">            completeResumeLocked(next);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            requestFinishActivityLocked(next.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="string">"resume-exception"</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        next.stopped = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 走到这个分支说明待启动activity所在的进程没有指定</span></span><br><span class="line">        <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</span><br><span class="line">            next.hasBeenLaunched = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW) &#123;</span><br><span class="line">                mWindowManager.setAppStartingWindow(</span><br><span class="line">                        next.appToken, next.packageName, next.theme,</span><br><span class="line">                        mService.compatibilityInfoForPackageLocked(</span><br><span class="line">                                next.info.applicationInfo),</span><br><span class="line">                        next.nonLocalizedLabel,</span><br><span class="line">                        next.labelRes, next.icon, next.logo, next.windowFlags,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此方法中把待启动activity推到栈顶，并把activity的状态置为resume状态。</p>
<h4 id="ActivityStackSupervisor-startSpecificActivityLocked"><a href="#ActivityStackSupervisor-startSpecificActivityLocked" class="headerlink" title="ActivityStackSupervisor.startSpecificActivityLocked()"></a>ActivityStackSupervisor.startSpecificActivityLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里获取一下activity所运行的进程</span></span><br><span class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    r.task.stack.setLaunchTime(r);</span><br><span class="line">    <span class="comment">// 这里会走两个分支，一个是进程已经存在，一个是不存在</span></span><br><span class="line">    <span class="comment">// 已经存在进程的case下面走的流程已经包含在创建进程case的流程里面</span></span><br><span class="line">    <span class="comment">// 这里就不再单独介绍</span></span><br><span class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line">                    || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</span><br><span class="line">                app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</span><br><span class="line">                        mService.mProcessStats);</span><br><span class="line">            &#125;</span><br><span class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果抛出异常，那么重启发起启动activity进程</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//启动一个新进程</span></span><br><span class="line">    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">            <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AMS中启动新进程"><a href="#AMS中启动新进程" class="headerlink" title="AMS中启动新进程"></a>AMS中启动新进程</h3><h4 id="ActivityManagerService-startProcessLocked"><a href="#ActivityManagerService-startProcessLocked" class="headerlink" title="ActivityManagerService.startProcessLocked()"></a>ActivityManagerService.startProcessLocked()</h4><p>这里先介绍一些什么是bad进程：如果一个进程在一分钟内crash两次，那么就会被认为是bad进程而被添加到<code>mBadProcesses</code>列表，<code>BadProcessInfo</code>里面保存了添加的时间。如果如果用户重新启动进程，那么就把该进程重列表中删除，直到下次crash时。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, String hostingType, ComponentName hostingName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid, <span class="keyword">boolean</span> keepIfLarge,</span></span></span><br><span class="line"><span class="function"><span class="params">        String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="comment">// 代表是否是完全隔绝的沙箱进程，完全隔绝的沙箱进程每次启动都是独立的，不能复用已有的进程信息。</span></span><br><span class="line">    <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">        app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: after getProcessRecord"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((intentFlags &amp; Intent.FLAG_FROM_BACKGROUND) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果是后台进程要判断一下是否是bad进程，如果是bad进程，直接退出</span></span><br><span class="line">            <span class="keyword">if</span> (mBadProcesses.get(info.processName, info.uid) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果是前台启动，清除bad进程标志</span></span><br><span class="line">            mProcessCrashTimes.remove(info.processName, info.uid);</span><br><span class="line">            <span class="keyword">if</span> (mBadProcesses.get(info.processName, info.uid) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,</span><br><span class="line">                        UserHandle.getUserId(info.uid), info.uid,</span><br><span class="line">                        info.processName);</span><br><span class="line">                mBadProcesses.remove(info.processName, info.uid);</span><br><span class="line">                <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    app.bad = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果是完全隔绝的沙箱进程，那么就不能复用一些已经存在的进程的信息。</span></span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">        nativeMigrateToBoost();</span><br><span class="line">        mIsBoosted = <span class="keyword">true</span>;</span><br><span class="line">        mBoostStartTime = SystemClock.uptimeMillis();</span><br><span class="line">        Message msg = mHandler.obtainMessage(APP_BOOST_DEACTIVATE_MSG);</span><br><span class="line">        mHandler.sendMessageDelayed(msg, APP_BOOST_MESSAGE_DELAY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ProcessRecord已经存在，且已经分配了pid</span></span><br><span class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!knownToBeDead || app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 调用者不认为该进程已死亡或者没有thread对象attached到该进程.则不应该清理该进程</span></span><br><span class="line">            app.addPackage(info.packageName, info.versionCode, mProcessStats);</span><br><span class="line">            checkTime(startTime, <span class="string">"startProcess: done, added package to proc"</span>);</span><br><span class="line">            <span class="keyword">return</span> app;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 有thread实例attach到该进程，那么杀死并清理该进程</span></span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: bad proc running, killing"</span>);</span><br><span class="line">        killProcessGroup(app.info.uid, app.pid);</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done killing old proc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String hostingNameStr = hostingName != <span class="keyword">null</span></span><br><span class="line">            ? hostingName.flattenToShortString() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: creating new process record"</span>);</span><br><span class="line">        <span class="comment">// 创建新的ProcessRecord对象</span></span><br><span class="line">        app = newProcessRecordLocked(info, processName, isolated, isolatedUid);</span><br><span class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建失败</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        app.crashHandler = crashHandler;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done creating new process record"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果这是进程中新package，则添加到列表</span></span><br><span class="line">        app.addPackage(info.packageName, info.versionCode, mProcessStats);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: added package to existing proc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当系统未准备完毕，则将当前进程加入到mProcessesOnHold</span></span><br><span class="line">    <span class="keyword">if</span> (!mProcessesReady</span><br><span class="line">            &amp;&amp; !isAllowedWhileBooting(info)</span><br><span class="line">            &amp;&amp; !allowWhileBooting) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mProcessesOnHold.contains(app)) &#123;</span><br><span class="line">            mProcessesOnHold.add(app);</span><br><span class="line">        &#125;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: returning with proc on hold"</span>);</span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    checkTime(startTime, <span class="string">"startProcess: stepping in to startProcess"</span>);</span><br><span class="line">    <span class="comment">// 启动进程</span></span><br><span class="line">    startProcessLocked(</span><br><span class="line">            app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);</span><br><span class="line">    checkTime(startTime, <span class="string">"startProcess: done starting proc!"</span>);</span><br><span class="line">    <span class="keyword">return</span> (app.pid != <span class="number">0</span>) ? app : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityManagerService-newProcessRecordLocked"><a href="#ActivityManagerService-newProcessRecordLocked" class="headerlink" title="ActivityManagerService.newProcessRecordLocked()"></a>ActivityManagerService.newProcessRecordLocked()</h4><p>创建新的ProcessRecord对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid)</span> </span>&#123;</span><br><span class="line">    String proc = customProcess != <span class="keyword">null</span> ? customProcess : info.processName;</span><br><span class="line">    <span class="comment">// 电量统计</span></span><br><span class="line">    BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(info.uid);</span><br><span class="line">    <span class="keyword">int</span> uid = info.uid;</span><br><span class="line">    <span class="keyword">if</span> (isolated) &#123;</span><br><span class="line">        <span class="comment">// 隔离进程相关</span></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> ProcessRecord r = <span class="keyword">new</span> ProcessRecord(stats, info, proc, uid);</span><br><span class="line">    <span class="keyword">if</span> (!mBooted &amp;&amp; !mBooting</span><br><span class="line">            &amp;&amp; userId == UserHandle.USER_OWNER</span><br><span class="line">            &amp;&amp; (info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</span><br><span class="line">        r.persistent = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    addProcessNameLocked(r);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityManagerService-startProcessLocked-1"><a href="#ActivityManagerService-startProcessLocked-1" class="headerlink" title="ActivityManagerService.startProcessLocked()"></a>ActivityManagerService.startProcessLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType,</span></span></span><br><span class="line"><span class="function"><span class="params">        String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != MY_PID) &#123;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: removing from pids map"</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            mPidsSelfLocked.remove(app.pid);</span><br><span class="line">            mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line">        &#125;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done removing from pids map"</span>);</span><br><span class="line">        app.setPid(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从HoldProcesses列表中移除该ProcessRecord</span></span><br><span class="line">    mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">    checkTime(startTime, <span class="string">"startProcess: starting to update cpu stats"</span>);</span><br><span class="line">    updateCpuStats();</span><br><span class="line">    checkTime(startTime, <span class="string">"startProcess: done updating cpu stats"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (AppGlobals.getPackageManager().isPackageFrozen(app.info.packageName)) &#123;</span><br><span class="line">                <span class="comment">// This is caught below as if we had failed to fork zygote</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Package "</span> + app.info.packageName + <span class="string">" is frozen!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> uid = app.uid;</span><br><span class="line">        <span class="keyword">int</span>[] gids = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">        <span class="keyword">if</span> (!app.isolated) &#123;</span><br><span class="line">            <span class="keyword">int</span>[] permGids = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                checkTime(startTime, <span class="string">"startProcess: getting gids from package manager"</span>);</span><br><span class="line">                <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">                permGids = pm.getPackageGids(app.info.packageName, app.userId);</span><br><span class="line">                MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">                        MountServiceInternal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                mountExternal = mountServiceInternal.getExternalStorageMountMode(uid,</span><br><span class="line">                        app.info.packageName);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ArrayUtils.isEmpty(permGids)) &#123;</span><br><span class="line">                gids = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                gids = <span class="keyword">new</span> <span class="keyword">int</span>[permGids.length + <span class="number">2</span>];</span><br><span class="line">                System.arraycopy(permGids, <span class="number">0</span>, gids, <span class="number">2</span>, permGids.length);</span><br><span class="line">            &#125;</span><br><span class="line">            gids[<span class="number">0</span>] = UserHandle.getSharedAppGid(UserHandle.getAppId(uid));</span><br><span class="line">            gids[<span class="number">1</span>] = UserHandle.getUserGid(UserHandle.getUserId(uid));</span><br><span class="line">        &#125;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: building args"</span>);</span><br><span class="line">        <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_OFF) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</span><br><span class="line">                    &amp;&amp; mTopComponent != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; app.processName.equals(mTopComponent.getPackageName())) &#123;</span><br><span class="line">                uid = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_HIGH_LEVEL</span><br><span class="line">                    &amp;&amp; (app.info.flags&amp;ApplicationInfo.FLAG_FACTORY_TEST) != <span class="number">0</span>) &#123;</span><br><span class="line">                uid = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置一些debug参数</span></span><br><span class="line">        <span class="keyword">int</span> debugFlags = <span class="number">0</span>;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        String requiredAbi = (abiOverride != <span class="keyword">null</span>) ? abiOverride : app.info.primaryCpuAbi;</span><br><span class="line">        <span class="keyword">if</span> (requiredAbi == <span class="keyword">null</span>) &#123;</span><br><span class="line">            requiredAbi = Build.SUPPORTED_ABIS[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String instructionSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (app.info.primaryCpuAbi != <span class="keyword">null</span>) &#123;</span><br><span class="line">            instructionSet = VMRuntime.getInstructionSet(app.info.primaryCpuAbi);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        app.gids = gids;</span><br><span class="line">        app.requiredAbi = requiredAbi;</span><br><span class="line">        app.instructionSet = instructionSet;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个进程</span></span><br><span class="line">        <span class="keyword">boolean</span> isActivityProcess = (entryPoint == <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"Start proc: "</span> +</span><br><span class="line">                app.processName);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: asking zygote to start proc"</span>);</span><br><span class="line">        Process.ProcessStartResult startResult = Process.start(entryPoint,</span><br><span class="line">                app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">                app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</span><br><span class="line">                app.info.dataDir, entryPointArgs);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: returned from zygote!"</span>);</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (app.isolated) &#123;</span><br><span class="line">            mBatteryStatsService.addIsolatedUid(app.uid, app.info.uid);</span><br><span class="line">        &#125;</span><br><span class="line">        mBatteryStatsService.noteProcessStart(app.processName, app.info.uid);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done updating battery stats"</span>);</span><br><span class="line"></span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_PROC_START,</span><br><span class="line">                UserHandle.getUserId(uid), startResult.pid, uid,</span><br><span class="line">                app.processName, hostingType,</span><br><span class="line">                hostingNameStr != <span class="keyword">null</span> ? hostingNameStr : <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (app.persistent) &#123;</span><br><span class="line">            Watchdog.getInstance().processStarted(app.processName, startResult.pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置一些属性变量</span></span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: building log message"</span>);</span><br><span class="line">        app.setPid(startResult.pid);</span><br><span class="line">        app.usingWrapper = startResult.usingWrapper;</span><br><span class="line">        app.removed = <span class="keyword">false</span>;</span><br><span class="line">        app.killed = <span class="keyword">false</span>;</span><br><span class="line">        app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: starting to update pids map"</span>);</span><br><span class="line">        <span class="comment">//将新创建的进程加入到mPidsSelfLocked</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            <span class="keyword">this</span>.mPidsSelfLocked.put(startResult.pid, app);</span><br><span class="line">            <span class="keyword">if</span> (isActivityProcess) &#123;</span><br><span class="line">                Message msg = mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);</span><br><span class="line">                msg.obj = app;</span><br><span class="line">                mHandler.sendMessageDelayed(msg, startResult.usingWrapper</span><br><span class="line">                        ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done updating pids map"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        app.setPid(<span class="number">0</span>);</span><br><span class="line">        mBatteryStatsService.noteProcessFinish(app.processName, app.info.uid);</span><br><span class="line">        <span class="keyword">if</span> (app.isolated) &#123;</span><br><span class="line">            mBatteryStatsService.removeIsolatedUid(app.uid, app.info.uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="新进程"><a href="#新进程" class="headerlink" title="新进程"></a>新进程</h3><p><code>Process.start()</code> 通过socket通信告知Zygote创建fork子进程，创建新进程后将 <code>ActivityThread</code> 类加载到新进程，并调用 <code>ActivityThread.main()</code> 方法。</p>
<h4 id="ActivityThread-main"><a href="#ActivityThread-main" class="headerlink" title="ActivityThread.main()"></a>ActivityThread.main()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ActivityThreadMain"</span>);</span><br><span class="line">    <span class="comment">//启动性能统计</span></span><br><span class="line">    SamplingProfilerIntegration.start();</span><br><span class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    Environment.initForCurrentUser();</span><br><span class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</span><br><span class="line">    AndroidKeyStoreProvider.install();</span><br><span class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</span><br><span class="line">    <span class="comment">// 初始化主线程消息队列</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">    <span class="comment">// 创建ActivityThread对象</span></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 主线程Handler对象mH</span></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    <span class="comment">// 消息循环开始运行</span></span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityThread-attach"><a href="#ActivityThread-attach" class="headerlink" title="ActivityThread.attach()"></a>ActivityThread.attach()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">    sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 是否是系统进程</span></span><br><span class="line">    mSystemThread = system;</span><br><span class="line">    <span class="keyword">if</span> (!system) &#123;</span><br><span class="line">        ViewRootImpl.addFirstDrawHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ensureJitEnabled();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 暂时设置进程的名字为&lt;pre-initialized&gt;</span></span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"&lt;pre-initialized&gt;"</span>,</span><br><span class="line">                                                UserHandle.myUserId());</span><br><span class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">        <span class="comment">// 调用AMS</span></span><br><span class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mgr.attachApplication(mAppThread);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;&#125;</span><br><span class="line">        <span class="comment">// GC检测</span></span><br><span class="line">        BinderInternal.addGcWatcher(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!mSomeActivitiesChanged) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Runtime runtime = Runtime.getRuntime();</span><br><span class="line">                <span class="keyword">long</span> dalvikMax = runtime.maxMemory();</span><br><span class="line">                <span class="keyword">long</span> dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</span><br><span class="line">                <span class="keyword">if</span> (dalvikUsed &gt; ((<span class="number">3</span>*dalvikMax)/<span class="number">4</span>)) &#123;</span><br><span class="line">                    <span class="comment">//当已用内存超过最大内存的3/4,则请求释放内存空间</span></span><br><span class="line">                    mSomeActivitiesChanged = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mgr.releaseSomeActivities(mAppThread);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果是系统进程，设置名称为system_process</span></span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"system_process"</span>,</span><br><span class="line">                UserHandle.myUserId());</span><br><span class="line">        <span class="comment">// 初始化mInstrumentation和mInitialApplication</span></span><br><span class="line">        <span class="comment">// 非系统进程这些对象的初始化在handleBindApplication()中进行</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">            ContextImpl context = ContextImpl.createAppContext(</span><br><span class="line">                    <span class="keyword">this</span>, getSystemContext().mPackageInfo);</span><br><span class="line">            mInitialApplication = context.mPackageInfo.makeApplication(<span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">            mInitialApplication.onCreate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DropBox.setReporter(<span class="keyword">new</span> DropBoxReporter());</span><br><span class="line">    <span class="comment">// 这里要快速的设置Config回调</span></span><br><span class="line">    ViewRootImpl.addConfigCallback(<span class="keyword">new</span> ComponentCallbacks2() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">                <span class="comment">// 快速响应onConfigurationChanged</span></span><br><span class="line">                <span class="keyword">if</span> (mResourcesManager.applyConfigurationToResourcesLocked(newConfig, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mPendingConfiguration == <span class="keyword">null</span> ||</span><br><span class="line">                            mPendingConfiguration.isOtherSeqNewer(newConfig)) &#123;</span><br><span class="line">                        mPendingConfiguration = newConfig;</span><br><span class="line"></span><br><span class="line">                        sendMessage(H.CONFIGURATION_CHANGED, newConfig);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来又会转到 <code>ActivityManagerService</code> 进程去执行。</p>
<h4 id="ActivityManagerService-attachApplication"><a href="#ActivityManagerService-attachApplication" class="headerlink" title="ActivityManagerService.attachApplication()"></a>ActivityManagerService.attachApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="comment">// thread是ApplicationThreadProxy对象，用于和应用进程的ApplicationThread通信</span></span><br><span class="line">        attachApplicationLocked(thread, callingPid);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityManagerService-attachApplicationLocked"><a href="#ActivityManagerService-attachApplicationLocked" class="headerlink" title="ActivityManagerService.attachApplicationLocked()"></a>ActivityManagerService.attachApplicationLocked()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据pid获取应用的ProcessRecord</span></span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            app = mPidsSelfLocked.get(pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取ProcessRecord失败，退出</span></span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_DROP_PROCESS, pid);</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span> &amp;&amp; pid != MY_PID) &#123;</span><br><span class="line">            Process.killProcessQuiet(pid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                thread.scheduleExit();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果ProcessRecord还和之前的进程绑定，就清除之前绑定的进程信息</span></span><br><span class="line">    <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定应用进程的DeathRecipient，当应用进程崩溃时，系统进程可以收到通知</span></span><br><span class="line">    <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AppDeathRecipient adr = <span class="keyword">new</span> AppDeathRecipient(</span><br><span class="line">                app, pid, thread);</span><br><span class="line">        thread.asBinder().linkToDeath(adr, <span class="number">0</span>);</span><br><span class="line">        app.deathRecipient = adr;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        app.resetPackageList(mProcessStats);</span><br><span class="line">        <span class="comment">// 绑定失败，这里会重启进程</span></span><br><span class="line">        startProcessLocked(app, <span class="string">"link fail"</span>, processName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName);</span><br><span class="line">    <span class="comment">// 激活ProcessRecord，设置进程的一些信息</span></span><br><span class="line">    app.makeActive(thread, mProcessStats);</span><br><span class="line">    app.curAdj = app.setAdj = -<span class="number">100</span>;</span><br><span class="line">    app.curSchedGroup = app.setSchedGroup = Process.THREAD_GROUP_DEFAULT;</span><br><span class="line">    app.forcingToForeground = <span class="keyword">null</span>;</span><br><span class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    app.hasShownUi = <span class="keyword">false</span>;</span><br><span class="line">    app.debugging = <span class="keyword">false</span>;</span><br><span class="line">    app.cached = <span class="keyword">false</span>;</span><br><span class="line">    app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 移除超时标志</span></span><br><span class="line">    mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</span><br><span class="line">    <span class="comment">// 获取应用所有的provider</span></span><br><span class="line">    List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 如果有provider在mLaunchingProviders列表中，那么发消息移除它们</span></span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span> &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;</span><br><span class="line">        Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);</span><br><span class="line">        msg.obj = app;</span><br><span class="line">        mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> testMode = IApplicationThread.DEBUG_OFF;</span><br><span class="line">        <span class="keyword">if</span> (mDebugApp != <span class="keyword">null</span> &amp;&amp; mDebugApp.equals(processName)) &#123;</span><br><span class="line">            testMode = mWaitForDebugger</span><br><span class="line">                ? IApplicationThread.DEBUG_WAIT</span><br><span class="line">                : IApplicationThread.DEBUG_ON;</span><br><span class="line">            app.debugging = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (mDebugTransient) &#123;</span><br><span class="line">                mDebugApp = mOrigDebugApp;</span><br><span class="line">                mWaitForDebugger = mOrigWaitForDebugger;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String profileFile = app.instrumentationProfileFile;</span><br><span class="line">        ParcelFileDescriptor profileFd = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> samplingInterval = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> profileAutoStop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mProfileApp != <span class="keyword">null</span> &amp;&amp; mProfileApp.equals(processName)) &#123;</span><br><span class="line">            mProfileProc = app;</span><br><span class="line">            profileFile = mProfileFile;</span><br><span class="line">            profileFd = mProfileFd;</span><br><span class="line">            samplingInterval = mSamplingInterval;</span><br><span class="line">            profileAutoStop = mAutoStopProfiler;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> enableOpenGlTrace = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mOpenGlTraceApp != <span class="keyword">null</span> &amp;&amp; mOpenGlTraceApp.equals(processName)) &#123;</span><br><span class="line">            enableOpenGlTrace = <span class="keyword">true</span>;</span><br><span class="line">            mOpenGlTraceApp = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isRestrictedBackupMode = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupAppName.equals(processName)) &#123;</span><br><span class="line">            isRestrictedBackupMode = (mBackupTarget.backupMode == BackupRecord.RESTORE)</span><br><span class="line">                    || (mBackupTarget.backupMode == BackupRecord.RESTORE_FULL)</span><br><span class="line">                    || (mBackupTarget.backupMode == BackupRecord.BACKUP_FULL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ensurePackageDexOpt(app.instrumentationInfo != <span class="keyword">null</span></span><br><span class="line">                ? app.instrumentationInfo.packageName</span><br><span class="line">                : app.info.packageName);</span><br><span class="line">        <span class="keyword">if</span> (app.instrumentationClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ensurePackageDexOpt(app.instrumentationClass.getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line">        ApplicationInfo appInfo = app.instrumentationInfo != <span class="keyword">null</span></span><br><span class="line">                ? app.instrumentationInfo : app.info;</span><br><span class="line">        app.compat = compatibilityInfoForPackageLocked(appInfo);</span><br><span class="line">        <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            profileFd = profileFd.dup();</span><br><span class="line">        &#125;</span><br><span class="line">        ProfilerInfo profilerInfo = profileFile == <span class="keyword">null</span> ? <span class="keyword">null</span></span><br><span class="line">                : <span class="keyword">new</span> ProfilerInfo(profileFile, profileFd, samplingInterval, profileAutoStop);</span><br><span class="line">        <span class="comment">// 发起跨进程调用。绑定应用进程，发送一些参数给应用进程</span></span><br><span class="line">        thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,</span><br><span class="line">                profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,</span><br><span class="line">                app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace,</span><br><span class="line">                isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                <span class="keyword">new</span> Configuration(mConfiguration), app.compat,</span><br><span class="line">                getCommonServicesLocked(app.isolated),</span><br><span class="line">                mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line">        updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// 绑定失败这里会重启进程</span></span><br><span class="line">        app.resetPackageList(mProcessStats);</span><br><span class="line">        app.unlinkDeathRecipient();</span><br><span class="line">        startProcessLocked(app, <span class="string">"bind fail"</span>, processName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把进程从待启动进程列表中移除</span></span><br><span class="line">    mPersistentStartingProcesses.remove(app);</span><br><span class="line">    mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> badApp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理Activity</span></span><br><span class="line">    <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">                didSomething = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理Service</span></span><br><span class="line">    <span class="keyword">if</span> (!badApp) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            didSomething |= mServices.attachApplicationLocked(app, processName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理Broadcast</span></span><br><span class="line">    <span class="keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            didSomething |= sendPendingBroadcastsLocked(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!badApp &amp;&amp; mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupTarget.appInfo.uid == app.uid) &#123;</span><br><span class="line">        ensurePackageDexOpt(mBackupTarget.appInfo.packageName);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread.scheduleCreateBackupAgent(mBackupTarget.appInfo,</span><br><span class="line">                    compatibilityInfoForPackageLocked(mBackupTarget.appInfo),</span><br><span class="line">                    mBackupTarget.backupMode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 杀掉坏的进程</span></span><br><span class="line">    <span class="keyword">if</span> (badApp) &#123;</span><br><span class="line">        app.kill(<span class="string">"error during init"</span>, <span class="keyword">true</span>);</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">        updateOomAdjLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityThread-handleBindApplication"><a href="#ActivityThread-handleBindApplication" class="headerlink" title="ActivityThread.handleBindApplication()"></a>ActivityThread.handleBindApplication()</h4><p>这里又转到应用进程来处理进程绑定的工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line">    mBoundApplication = data;</span><br><span class="line">    mConfiguration = <span class="keyword">new</span> Configuration(data.config);</span><br><span class="line">    mCompatConfiguration = <span class="keyword">new</span> Configuration(data.config);</span><br><span class="line"></span><br><span class="line">    mProfiler = <span class="keyword">new</span> Profiler();</span><br><span class="line">    <span class="keyword">if</span> (data.initProfilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProfiler.profileFile = data.initProfilerInfo.profileFile;</span><br><span class="line">        mProfiler.profileFd = data.initProfilerInfo.profileFd;</span><br><span class="line">        mProfiler.samplingInterval = data.initProfilerInfo.samplingInterval;</span><br><span class="line">        mProfiler.autoStopProfiler = data.initProfilerInfo.autoStopProfiler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置进程的名字</span></span><br><span class="line">    Process.setArgV0(data.processName);</span><br><span class="line">    android.ddm.DdmHandleAppName.setAppName(data.processName,</span><br><span class="line">                                            UserHandle.myUserId());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data.persistent) &#123;</span><br><span class="line">        <span class="comment">// 对persistent进程的处理，在低内存设备上不用硬件加速</span></span><br><span class="line">        <span class="keyword">if</span> (!ActivityManager.isHighEndGfx()) &#123;</span><br><span class="line">            HardwareRenderer.disable(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mProfiler.profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProfiler.startProfiling();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data.appInfo.targetSdkVersion &lt;= android.os.Build.VERSION_CODES.HONEYCOMB_MR1) &#123;</span><br><span class="line">        AsyncTask.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Message.updateCheckRecycle(data.appInfo.targetSdkVersion);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置时区</span></span><br><span class="line">    TimeZone.setDefault(<span class="keyword">null</span>);</span><br><span class="line">    Locale.setDefault(data.config.locale);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新系统配置</span></span><br><span class="line">    mResourcesManager.applyConfigurationToResourcesLocked(data.config, data.compatInfo);</span><br><span class="line">    mCurDefaultDisplayDpi = data.config.densityDpi;</span><br><span class="line">    applyCompatConfiguration(mCurDefaultDisplayDpi);</span><br><span class="line"></span><br><span class="line">    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((data.appInfo.flags&amp;ApplicationInfo.FLAG_SUPPORTS_SCREEN_DENSITIES)</span><br><span class="line">            == <span class="number">0</span>) &#123;</span><br><span class="line">        mDensityCompatMode = <span class="keyword">true</span>;</span><br><span class="line">        Bitmap.setDefaultDensity(DisplayMetrics.DENSITY_DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line">    updateDefaultDensity();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Context上下文</span></span><br><span class="line">    <span class="keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="keyword">this</span>, data.info);</span><br><span class="line">    <span class="keyword">if</span> (!Process.isIsolated()) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置时区，debug模式，StrictMode</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> is24Hr = <span class="string">"24"</span>.equals(mCoreSettings.getString(Settings.System.TIME_12_24));</span><br><span class="line">    DateFormat.set24HourTimePref(is24Hr);</span><br><span class="line"></span><br><span class="line">    View.mDebugViewAttributes =</span><br><span class="line">            mCoreSettings.getInt(Settings.Global.DEBUG_VIEW_ATTRIBUTES, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((data.appInfo.flags &amp;</span><br><span class="line">         (ApplicationInfo.FLAG_SYSTEM |</span><br><span class="line">          ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != <span class="number">0</span>) &#123;</span><br><span class="line">        StrictMode.conditionallyEnableDebugLogging();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (data.appInfo.targetSdkVersion &gt; <span class="number">9</span>) &#123;</span><br><span class="line">        StrictMode.enableDeathOnNetwork();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NetworkSecurityPolicy.getInstance().setCleartextTrafficPermitted(</span><br><span class="line">            (data.appInfo.flags &amp; ApplicationInfo.FLAG_USES_CLEARTEXT_TRAFFIC) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data.debugMode != IApplicationThread.DEBUG_OFF) &#123;</span><br><span class="line">        Debug.changeDebugPort(<span class="number">8100</span>);</span><br><span class="line">        <span class="keyword">if</span> (data.debugMode == IApplicationThread.DEBUG_WAIT) &#123;</span><br><span class="line">            IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.showWaitingForDebugger(mAppThread, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;&#125;</span><br><span class="line"></span><br><span class="line">            Debug.waitForDebugger();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.showWaitingForDebugger(mAppThread, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;&#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data.enableOpenGlTrace) &#123;</span><br><span class="line">        GLUtils.setTracingLevel(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是调试模式生成systrace 信息</span></span><br><span class="line">    <span class="keyword">boolean</span> appTracingAllowed = (data.appInfo.flags&amp;ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line">    Trace.setAppTracingAllowed(appTracingAllowed);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化默认http代理</span></span><br><span class="line">    IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">        IConnectivityManager service = IConnectivityManager.Stub.asInterface(b);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> ProxyInfo proxyInfo = service.getProxyForNetwork(<span class="keyword">null</span>);</span><br><span class="line">            Proxy.setHttpProxySystemProperty(proxyInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data.instrumentationName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        InstrumentationInfo ii = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ii = appContext.getPackageManager().</span><br><span class="line">                getInstrumentationInfo(data.instrumentationName, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ii == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to find instrumentation info for: "</span></span><br><span class="line">                + data.instrumentationName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mInstrumentationPackageName = ii.packageName;</span><br><span class="line">        mInstrumentationAppDir = ii.sourceDir;</span><br><span class="line">        mInstrumentationSplitAppDirs = ii.splitSourceDirs;</span><br><span class="line">        mInstrumentationLibDir = ii.nativeLibraryDir;</span><br><span class="line">        mInstrumentedAppDir = data.info.getAppDir();</span><br><span class="line">        mInstrumentedSplitAppDirs = data.info.getSplitAppDirs();</span><br><span class="line">        mInstrumentedLibDir = data.info.getLibDir();</span><br><span class="line"></span><br><span class="line">        ApplicationInfo instrApp = <span class="keyword">new</span> ApplicationInfo();</span><br><span class="line">        instrApp.packageName = ii.packageName;</span><br><span class="line">        instrApp.sourceDir = ii.sourceDir;</span><br><span class="line">        instrApp.publicSourceDir = ii.publicSourceDir;</span><br><span class="line">        instrApp.splitSourceDirs = ii.splitSourceDirs;</span><br><span class="line">        instrApp.splitPublicSourceDirs = ii.splitPublicSourceDirs;</span><br><span class="line">        instrApp.dataDir = ii.dataDir;</span><br><span class="line">        instrApp.nativeLibraryDir = ii.nativeLibraryDir;</span><br><span class="line">        LoadedApk pi = getPackageInfo(instrApp, data.compatInfo,</span><br><span class="line">                appContext.getClassLoader(), <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        ContextImpl instrContext = ContextImpl.createAppContext(<span class="keyword">this</span>, pi);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = instrContext.getClassLoader();</span><br><span class="line">            mInstrumentation = (Instrumentation)</span><br><span class="line">                cl.loadClass(data.instrumentationName.getClassName()).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate instrumentation "</span></span><br><span class="line">                + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mInstrumentation.init(<span class="keyword">this</span>, instrContext, appContext,</span><br><span class="line">               <span class="keyword">new</span> ComponentName(ii.packageName, ii.name), data.instrumentationWatcher,</span><br><span class="line">               data.instrumentationUiAutomationConnection);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mProfiler.profileFile != <span class="keyword">null</span> &amp;&amp; !ii.handleProfiling</span><br><span class="line">                &amp;&amp; mProfiler.profileFd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mProfiler.handlingProfiling = <span class="keyword">true</span>;</span><br><span class="line">            File file = <span class="keyword">new</span> File(mProfiler.profileFile);</span><br><span class="line">            file.getParentFile().mkdirs();</span><br><span class="line">            Debug.startMethodTracing(file.toString(), <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化mInstrumentation</span></span><br><span class="line">        mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((data.appInfo.flags&amp;ApplicationInfo.FLAG_LARGE_HEAP) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果设置了largeHeap，清楚内存上限</span></span><br><span class="line">        dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 设置内存上限</span></span><br><span class="line">        dalvik.system.VMRuntime.getRuntime().clampGrowthLimit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建Application对象</span></span><br><span class="line">        Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line">        mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 装载Providers</span></span><br><span class="line">        <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</span><br><span class="line">            List&lt;ProviderInfo&gt; providers = data.providers;</span><br><span class="line">            <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                installContentProviders(app, providers);</span><br><span class="line">                mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Exception thrown in onCreate() of "</span></span><br><span class="line">                + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//调用Application.onCreate()</span></span><br><span class="line">            mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to create application "</span> + app.getClass().getName()</span><br><span class="line">                    + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        StrictMode.setThreadPolicy(savedPolicy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-attachApplicationLocked"><a href="#ActivityStackSupervisor-attachApplicationLocked" class="headerlink" title="ActivityStackSupervisor.attachApplicationLocked()"></a>ActivityStackSupervisor.attachApplicationLocked()</h4><p>接下来会继续处理 <code>ActivityManagerService.attachApplication()</code> 中的 <code>ActivityStackSupervisor.attachApplicationLocked()</code> 方法。将 <code>ActivityStackSupervisor</code> 绑定到应用进程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</span><br><span class="line">            <span class="keyword">if</span> (!isFrontStack(stack)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ActivityRecord hr = stack.topRunningActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (hr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (hr.app == <span class="keyword">null</span> &amp;&amp; app.uid == hr.info.applicationInfo.uid</span><br><span class="line">                        &amp;&amp; processName.equals(hr.processName)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 真正的启动activity，调用Activity.onCreate，从这里开始的流程</span></span><br><span class="line">                        <span class="comment">// 就和进程已经存在时启动activity流程一样的了</span></span><br><span class="line">                        <span class="keyword">if</span> (realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                            didSomething = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">        ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityStackSupervisor-realStartActivityLocked"><a href="#ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="ActivityStackSupervisor.realStartActivityLocked()"></a>ActivityStackSupervisor.realStartActivityLocked()</h4><p>开始执行真正的Activity启动操作，从这里开始的流程就和进程已经存在时启动activity流程一样的了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">        <span class="comment">// 开始冻屏</span></span><br><span class="line">        r.startFreezingScreenLocked(app, <span class="number">0</span>);</span><br><span class="line">        mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        r.startLaunchTickingLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (checkConfig) &#123;</span><br><span class="line">        Configuration config = mWindowManager.updateOrientationFromAppTokens(</span><br><span class="line">                mService.mConfiguration,</span><br><span class="line">                r.mayFreezeScreenLocked(app) ? r.appToken : <span class="keyword">null</span>);</span><br><span class="line">        mService.updateConfigurationLocked(config, r, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.app = app;</span><br><span class="line">    app.waitingToKill = <span class="keyword">null</span>;</span><br><span class="line">    r.launchCount++;</span><br><span class="line">    r.lastLaunchTime = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> idx = app.activities.indexOf(r);</span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        app.activities.add(r);</span><br><span class="line">    &#125;</span><br><span class="line">    mService.updateLruProcessLocked(app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">    mService.updateOomAdjLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> TaskRecord task = r.task;</span><br><span class="line">    <span class="keyword">if</span> (task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE ||</span><br><span class="line">            task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE_PRIV) &#123;</span><br><span class="line">        setLockTaskModeLocked(task, LOCK_TASK_MODE_LOCKED, <span class="string">"mLockTaskAuth==LAUNCHABLE"</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = task.stack;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;ResultInfo&gt; results = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;ReferrerIntent&gt; newIntents = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">            results = r.results;</span><br><span class="line">            newIntents = r.newIntents;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_RESTART_ACTIVITY,</span><br><span class="line">                    r.userId, System.identityHashCode(r),</span><br><span class="line">                    task.taskId, r.shortComponentName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r.isHomeActivity() &amp;&amp; r.isNotResolverActivity()) &#123;</span><br><span class="line">            <span class="comment">// Home process 是task中的第一个进程</span></span><br><span class="line">            mService.mHomeProcess = task.mActivities.get(<span class="number">0</span>).app;</span><br><span class="line">        &#125;</span><br><span class="line">        mService.ensurePackageDexOpt(r.intent.getComponent().getPackageName());</span><br><span class="line">        r.sleeping = <span class="keyword">false</span>;</span><br><span class="line">        r.forceNewConfig = <span class="keyword">false</span>;</span><br><span class="line">        mService.showAskCompatModeDialogLocked(r);</span><br><span class="line">        r.compat = mService.compatibilityInfoForPackageLocked(r.info.applicationInfo);</span><br><span class="line">        ProfilerInfo profilerInfo = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mService.mProfileApp != <span class="keyword">null</span> &amp;&amp; mService.mProfileApp.equals(app.processName)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mService.mProfileProc == <span class="keyword">null</span> || mService.mProfileProc == app) &#123;</span><br><span class="line">                mService.mProfileProc = app;</span><br><span class="line">                <span class="keyword">final</span> String profileFile = mService.mProfileFile;</span><br><span class="line">                <span class="keyword">if</span> (profileFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ParcelFileDescriptor profileFd = mService.mProfileFd;</span><br><span class="line">                    <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            profileFd = profileFd.dup();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    profileFd.close();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IOException o) &#123;</span><br><span class="line">                                &#125;</span><br><span class="line">                                profileFd = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    profilerInfo = <span class="keyword">new</span> ProfilerInfo(profileFile, profileFd,</span><br><span class="line">                            mService.mSamplingInterval, mService.mAutoStopProfiler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">            app.hasShownUi = <span class="keyword">true</span>;</span><br><span class="line">            app.pendingUiClean = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        app.forceProcessStateUpTo(mService.mTopProcessState);</span><br><span class="line">        <span class="comment">// 调用ApplicationThreadNative.ApplicationThreadProxy.scheduleLaunchActivity()，跳到应用进程</span></span><br><span class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                <span class="keyword">new</span> Configuration(stack.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((app.info.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (app.processName.equals(app.info.packageName)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; mService.mHeavyWeightProcess != app) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                mService.mHeavyWeightProcess = app;</span><br><span class="line">                Message msg = mService.mHandler.obtainMessage(</span><br><span class="line">                        ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);</span><br><span class="line">                msg.obj = r;</span><br><span class="line">                mService.mHandler.sendMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.launchFailed) &#123;</span><br><span class="line">            mService.appDiedLocked(app);</span><br><span class="line">            stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="string">"2nd-crash"</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        app.activities.remove(r);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.launchFailed = <span class="keyword">false</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">        stack.minimalResumeActivityLocked(r);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.state = STOPPED;</span><br><span class="line">        r.stopped = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isFrontStack(stack)) &#123;</span><br><span class="line">        mService.startSetupActivityLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mService.mServices.updateServiceConnectionActivitiesLocked(r.app);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityThread-H-handleMessage-LAUNCH-ACTIVITY"><a href="#ActivityThread-H-handleMessage-LAUNCH-ACTIVITY" class="headerlink" title="ActivityThread.H.handleMessage():LAUNCH_ACTIVITY"></a>ActivityThread.H.handleMessage():LAUNCH_ACTIVITY</h4><p>跳转到应用进程来处理，从这里开始就开始Activity的生命周期的运转了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">            <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">            r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                    r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">            handleLaunchActivity(r, <span class="keyword">null</span>);</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityThread-handleLaunchActivity"><a href="#ActivityThread-handleLaunchActivity" class="headerlink" title="ActivityThread.handleLaunchActivity()"></a>ActivityThread.handleLaunchActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    unscheduleGcIdler();</span><br><span class="line">    mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProfiler.setProfiler(r.profilerInfo);</span><br><span class="line">        mProfiler.startProfiling();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化WMS</span></span><br><span class="line">    WindowManagerGlobal.initialize();</span><br><span class="line">    <span class="comment">// 创建activity并调用onCreate，onStart等生命周期函数</span></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">        Bundle oldState = r.state;</span><br><span class="line">        <span class="comment">// 调用onResume方法</span></span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                r.activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                mInstrumentation.callActivityOnPause(r.activity);</span><br><span class="line">                <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</span><br><span class="line">                    r.state = oldState;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!r.activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                        <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">" did not call through to super.onPause()"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                            <span class="string">"Unable to pause activity "</span></span><br><span class="line">                            + r.intent.getComponent().toShortString()</span><br><span class="line">                            + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            r.paused = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ActivityManagerNative.getDefault()</span><br><span class="line">                .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityThread-performLaunchActivity"><a href="#ActivityThread-performLaunchActivity" class="headerlink" title="ActivityThread.performLaunchActivity()"></a>ActivityThread.performLaunchActivity()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 收集要启动的Activity的package信息</span></span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 收集要启动的Activity的component信息</span></span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = r.intent.resolveActivity(</span><br><span class="line">            mInitialApplication.getPackageManager());</span><br><span class="line">        r.intent.setComponent(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                r.activityInfo.targetActivity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新建一个Activity对象，通过ClassLoader将要启动的Activity类加载进来</span></span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取Application对象</span></span><br><span class="line">        <span class="comment">// 不知道大家有没有印象，在ActivityThread.handleBindApplication方法中已经调用过makeApplication</span></span><br><span class="line">        <span class="comment">// 为什么还要make呢？追踪源码会发现，如果已经创建就返回以前创建的对象</span></span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建Context对象，并绑定到Activity</span></span><br><span class="line">            Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">            CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">            Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.referrer, r.voiceInteractor);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                activity.mIntent = customIntent;</span><br><span class="line">            &#125;</span><br><span class="line">            r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">            activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">            <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                activity.setTheme(theme);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// 调用Activity.onCreate方法</span></span><br><span class="line">            <span class="comment">// 根据 manifest 中activity的persistableMode配置来执行不同的onCreate方法</span></span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                    <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                    <span class="string">" did not call through to super.onCreate()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.activity = activity;</span><br><span class="line">            r.stopped = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                <span class="comment">// 调用Activity.onStart方法</span></span><br><span class="line">                activity.performStart();</span><br><span class="line">                r.stopped = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                <span class="comment">// 调用Activity.onRestoreInstanceState方法</span></span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</span><br><span class="line">                                r.persistentState);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// 调用Activity.onPostCreate方法</span></span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state,</span><br><span class="line">                            r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                        <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">" did not call through to super.onPostCreate()"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        r.paused = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to start activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 <code>performLaunchActivity</code> 方法开始，正式进入了 <code>Activity</code> 的 <code>onCreate()</code>、<code>onStart()</code>、<code>onResume()</code>等生命周期过程。<br>至此，<code>Activity</code> 的启动流程基本介绍完了。</p>
<h2 id="方法详解"><a href="#方法详解" class="headerlink" title="方法详解"></a>方法详解</h2><h3 id="findTaskLocked"><a href="#findTaskLocked" class="headerlink" title="findTaskLocked()"></a>findTaskLocked()</h3><h3 id="findActivityLocked"><a href="#findActivityLocked" class="headerlink" title="findActivityLocked()"></a>findActivityLocked()</h3><h3 id="resolveActivity"><a href="#resolveActivity" class="headerlink" title="resolveActivity()"></a>resolveActivity()</h3><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><!--     
http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1#10-amsnewprocessrecordlocked
http://duanqz.github.io/2016-10-23-Activity-LaunchProcess-Part2#3-amsattachapplicationlocked
http://gityuan.com/2016/03/12/start-activity/

http://blog.csdn.net/luoshengyang/article/details/6689748
http://blog.csdn.net/Luoshengyang/article/details/6703247
http://duanqz.github.io/2016-02-01-Activity-Maintenance
http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1
http://gityuan.com/2016/03/12/start-activity/
http://gityuan.com/2016/10/09/app-process-create-2/
http://www.cnblogs.com/franksunny/archive/2012/04/17/2453403.html
http://blog.csdn.net/shan987/article/details/50511439
http://blog.csdn.net/yunbin_7/article/details/46003509
http://www.jianshu.com/p/2d52fa0bce90
-->

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android源码分析/" rel="tag"># Android源码分析</a>
          
            <a href="/tags/startActivity/" rel="tag"># startActivity</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/08/Android源码分析/android-source-code-analysis-ams-app-ipc/" rel="next" title="Android AMS 与 APP 进程通信">
                <i class="fa fa-chevron-left"></i> Android AMS 与 APP 进程通信
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/06/12/Android/android-usefull-class-function/" rel="prev" title="Android -- 那些让你相见恨晚的方法、类或接口">
                Android -- 那些让你相见恨晚的方法、类或接口 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/icon.png" alt="寒江蓑笠">
          <p class="site-author-name" itemprop="name">寒江蓑笠</p>
          <p class="site-description motion-element" itemprop="description">技术博客</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">287</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">119</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/heqiangflytosky/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/heqiangflytosky/" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关类介绍"><span class="nav-number">2.</span> <span class="nav-text">相关类介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动流程图"><span class="nav-number">3.</span> <span class="nav-text">启动流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#进程间的通信"><span class="nav-number">4.</span> <span class="nav-text">进程间的通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动流程"><span class="nav-number">5.</span> <span class="nav-text">启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动前期，当前进程"><span class="nav-number">5.1.</span> <span class="nav-text">启动前期，当前进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityManagerService的处理"><span class="nav-number">5.2.</span> <span class="nav-text">ActivityManagerService的处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-startActivityAsUser"><span class="nav-number">5.2.1.</span> <span class="nav-text">ActivityManagerService.startActivityAsUser</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-startActivityMayWait"><span class="nav-number">5.2.2.</span> <span class="nav-text">ActivityStackSupervisor.startActivityMayWait()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-startActivityLocked"><span class="nav-number">5.2.3.</span> <span class="nav-text">ActivityStackSupervisor.startActivityLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-startActivityUncheckedLocked"><span class="nav-number">5.2.4.</span> <span class="nav-text">ActivityStackSupervisor.startActivityUncheckedLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStack-startActivityLocked"><span class="nav-number">5.2.5.</span> <span class="nav-text">ActivityStack.startActivityLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-resumeTopActivitiesLocked"><span class="nav-number">5.2.6.</span> <span class="nav-text">ActivityStackSupervisor.resumeTopActivitiesLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStack-resumeTopActivityLocked"><span class="nav-number">5.2.7.</span> <span class="nav-text">ActivityStack.resumeTopActivityLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStack-resumeTopActivityInnerLocked"><span class="nav-number">5.2.8.</span> <span class="nav-text">ActivityStack.resumeTopActivityInnerLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-startSpecificActivityLocked"><span class="nav-number">5.2.9.</span> <span class="nav-text">ActivityStackSupervisor.startSpecificActivityLocked()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS中启动新进程"><span class="nav-number">5.3.</span> <span class="nav-text">AMS中启动新进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-startProcessLocked"><span class="nav-number">5.3.1.</span> <span class="nav-text">ActivityManagerService.startProcessLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-newProcessRecordLocked"><span class="nav-number">5.3.2.</span> <span class="nav-text">ActivityManagerService.newProcessRecordLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-startProcessLocked-1"><span class="nav-number">5.3.3.</span> <span class="nav-text">ActivityManagerService.startProcessLocked()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新进程"><span class="nav-number">5.4.</span> <span class="nav-text">新进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-main"><span class="nav-number">5.4.1.</span> <span class="nav-text">ActivityThread.main()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-attach"><span class="nav-number">5.4.2.</span> <span class="nav-text">ActivityThread.attach()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-attachApplication"><span class="nav-number">5.4.3.</span> <span class="nav-text">ActivityManagerService.attachApplication()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityManagerService-attachApplicationLocked"><span class="nav-number">5.4.4.</span> <span class="nav-text">ActivityManagerService.attachApplicationLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-handleBindApplication"><span class="nav-number">5.4.5.</span> <span class="nav-text">ActivityThread.handleBindApplication()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-attachApplicationLocked"><span class="nav-number">5.4.6.</span> <span class="nav-text">ActivityStackSupervisor.attachApplicationLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervisor-realStartActivityLocked"><span class="nav-number">5.4.7.</span> <span class="nav-text">ActivityStackSupervisor.realStartActivityLocked()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-H-handleMessage-LAUNCH-ACTIVITY"><span class="nav-number">5.4.8.</span> <span class="nav-text">ActivityThread.H.handleMessage():LAUNCH_ACTIVITY</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-handleLaunchActivity"><span class="nav-number">5.4.9.</span> <span class="nav-text">ActivityThread.handleLaunchActivity()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread-performLaunchActivity"><span class="nav-number">5.4.10.</span> <span class="nav-text">ActivityThread.performLaunchActivity()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方法详解"><span class="nav-number">6.</span> <span class="nav-text">方法详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#findTaskLocked"><span class="nav-number">6.1.</span> <span class="nav-text">findTaskLocked()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#findActivityLocked"><span class="nav-number">6.2.</span> <span class="nav-text">findActivityLocked()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#resolveActivity"><span class="nav-number">6.3.</span> <span class="nav-text">resolveActivity()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">7.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">寒江蓑笠</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "d2475abece3649debc94c21b166fc009",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("6zbrLyUbhXLbd7RqUSMnxhg4-gzGzoHsz", "fb9g4GyEWQysqnpY9t5CPhpU");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
