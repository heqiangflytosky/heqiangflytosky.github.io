<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="onSaveInstanceState," />





  <link rel="alternate" href="/atom.xml" title="孤舟蓑笠翁，独钓寒江雪" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="基于Android6.0来分析 onSaveInstanceState 数据保存源码">
<meta property="og:type" content="article">
<meta property="og:title" content="Android -- Activity 之 onSaveInstanceState 深入理解">
<meta property="og:url" content="http://yoursite.com/2018/08/12/android-knowledge-about-activity-save-state/index.html">
<meta property="og:site_name" content="孤舟蓑笠翁，独钓寒江雪">
<meta property="og:description" content="基于Android6.0来分析 onSaveInstanceState 数据保存源码">
<meta property="og:updated_time" content="2019-07-09T02:37:08.006Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android -- Activity 之 onSaveInstanceState 深入理解">
<meta name="twitter:description" content="基于Android6.0来分析 onSaveInstanceState 数据保存源码">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '6377131610457769000',
      author: '寒江蓑笠'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/08/12/android-knowledge-about-activity-save-state/"/>





  <title> Android -- Activity 之 onSaveInstanceState 深入理解 | 孤舟蓑笠翁，独钓寒江雪 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  








  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1261134288&web_id=1261134288" language="JavaScript"></script>
  </div>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">孤舟蓑笠翁，独钓寒江雪</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">程序猿的世界</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-users"></i> <br />
            
            友情链接
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/12/android-knowledge-about-activity-save-state/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="寒江蓑笠">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/icon.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="孤舟蓑笠翁，独钓寒江雪">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="孤舟蓑笠翁，独钓寒江雪" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android -- Activity 之 onSaveInstanceState 深入理解
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-12T10:00:00+08:00">
                2018-08-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2018/08/12/android-knowledge-about-activity-save-state/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2018/08/12/android-knowledge-about-activity-save-state/" class="leancloud_visitors" data-flag-title="Android -- Activity 之 onSaveInstanceState 深入理解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
              <div class="post-description">
                  基于Android6.0来分析 onSaveInstanceState 数据保存源码
              </div>
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>我们在 Android 开发过程中应该都用过 onSaveInstanceState() 方法和 onRestoreInstanceState()，它们是 Android 系统为我们提供的保存和恢复 Activity 数据的方法。当 Activity 屏幕旋转导致重建或者被意外杀掉后，我们可以使用上面的方法来进行数据的保存和恢复工作，这样重新打开 Activity 时，可以恢复成原来的状态。<br>onSaveInstanceState() 只应该被用来保存 Activity 暂时的状态（例如，类成员变量的值关联着UI），而不应该用来保存持久化数据。持久化数据应该当用户离开当前的 Activity 时，在 onPause() 或者 onResume 中保存（比如，保存到数据库）。<br>一般情况下，通过 onSaveInstanceState 保存的数据是保存在 system 进程中，当 Activity 意外杀掉后可以做数据恢复，但是如果手机重启的话，这些数据是会丢失的。那么这个时候可以用 PersistableBundle 来做数据恢复，为此 Android 也重载的 onCreate、onSaveInstanceState 和 onRestoreInstanceState 来做相关操作。</p>
<h2 id="相关方法介绍"><a href="#相关方法介绍" class="headerlink" title="相关方法介绍"></a>相关方法介绍</h2><ul>
<li>onCreate(@Nullable Bundle savedInstanceState)</li>
<li>onCreate(@Nullable Bundle savedInstanceState,@Nullable PersistableBundle persistentState)</li>
<li>onSaveInstanceState(Bundle outState)</li>
<li>onSaveInstanceState(Bundle outState, PersistableBundle outPersistentState)</li>
<li>onRestoreInstanceState(Bundle savedInstanceState)</li>
<li>onRestoreInstanceState(Bundle savedInstanceState,PersistableBundle persistentState)</li>
</ul>
<p>上面的 onSaveInstanceState 用于存储我们需要保存的数据，onCreate 和 onRestoreInstanceState 用户恢复数据。<br>onCreate 和 onRestoreInstanceState 都可以恢复数据，但他们也有些区别：</p>
<ul>
<li>onRestoreInstanceState 是和 onSaveInstanceState 一一对应的方法。</li>
<li>onCreate 中的 Bundle 可能为 null，而 onRestoreInstanceState 中的 Bundle 不会为 null。</li>
<li>onRestoreInstanceState 不保证一定会被调用，除非上次Activity意外退出。</li>
</ul>
<p>正常打开应用时 onCreate 中的 Bundle 为空，此时不会调用 onRestoreInstanceState。如果出现了意外退出，下次启动 Activity 时，onCreate 中的 Bundle 不为空，会调用 onRestoreInstanceState，且其参数 Bundle 不会为空。<br>上面的方法都有一个重载的方法，多了个 PersistableBundle 参数。这个方法后面会介绍。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">protected void onSaveInstanceState(Bundle outState) &#123;</div><div class="line">    super.onSaveInstanceState(outState);</div><div class="line">    outState.putString(&quot;Test1&quot;,&quot;Test1&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 onSaveInstanceState 中添加我们需要保存的数据。<br>然后在 onCreate 或者 onRestoreInstanceState 中取出数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">    super.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_other_test);</div><div class="line">    Intent intent = getIntent();</div><div class="line">    Bundle bundle = intent.getExtras();</div><div class="line">    if(bundle != null)&#123;</div><div class="line">        Log.e(&quot;Test&quot;,&quot;Test = &quot;+bundle.getString(&quot;Test&quot;));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // savedInstanceState 可能为空</div><div class="line">    if (savedInstanceState != null) &#123;</div><div class="line">        Log.e(&quot;Test&quot;,&quot;get savedInstanceState&quot;+savedInstanceState);</div><div class="line">        Log.e(&quot;Test&quot;,&quot;Test1 = &quot;+savedInstanceState.getString(&quot;Test1&quot;));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">protected void onRestoreInstanceState(Bundle savedInstanceState) &#123;</div><div class="line">    super.onRestoreInstanceState(savedInstanceState);</div><div class="line">    Log.e(&quot;Test&quot;,&quot;Test1 = &quot;+savedInstanceState.getString(&quot;Test1&quot;));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="关于-PersistableBundle"><a href="#关于-PersistableBundle" class="headerlink" title="关于 PersistableBundle"></a>关于 PersistableBundle</h2><p>PersistableBundle 是 API 21为 Activity 新增加的属性，用于保存异常状况下Activity中的数据。<br>要想使用 PersistableBundle ，可以在 Manifest 中为 Activity 设置属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:persistableMode=&quot;persistRootOnly&quot;</div></pre></td></tr></table></figure>
<p>和这个属性相关的方法有三个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void onSaveInstanceState(Bundle outState, PersistableBundle outPersistentState)</div><div class="line">public void onRestoreInstanceState(Bundle savedInstanceState, PersistableBundle persistentState) </div><div class="line">public void onCreate(Bundle savedInstanceState, PersistableBundle persistentState)</div></pre></td></tr></table></figure>
<p>persistableMode 可以有三种不同的配置：</p>
<ul>
<li>persistNever：不起作用，不会调用上面方法做相关状态保存操作。</li>
<li>persistRootOnly：默认值。仅仅会作用在根activity或者task中。</li>
<li>persistAcrossReboots：重启设备，会持久化页面的数据或者状态。</li>
</ul>
<h2 id="onSaveInstanceState-调用时机"><a href="#onSaveInstanceState-调用时机" class="headerlink" title="onSaveInstanceState 调用时机"></a>onSaveInstanceState 调用时机</h2><p>系统不会保证onSaveInstanceState()在activity被销毁前总被调用（因为有一些不需要保存状态的情况，比如，用户用 BACK 键关闭此activity。如果onSaveInstanceState()被调用，那么一定是在onStop()之前，或者可能在onPause()之前。<br>如果你在onSaveInstanceState()不做啥事(不重载它)，有些 Activity 的状态也会被 Activity 默认的 onSaveInstanceState() 保存。比如，通常 EditText 会保存自己的状态，原因就是 Activity 默认的 onSaveInstanceState() 会调用其 layout 里面每一个 View 的 onSaveInstanceState()，当然也包括此 EditView 。你只需要为这些view提供唯一的ID（android:id属性），他们就会保存自己的状态，不用你操心了。这个自动保存可以通过 android:saveEnabled 属性或者 setSaveEnabled() 方法来禁用。</p>
<p>APP 进程调用栈如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">├── ActivityThread.H.handleMessage:STOP_ACTIVITY_HIDE</div><div class="line">    ├── ActivityThread.handleStopActivity</div><div class="line">        ├── ActivityThread.performStopActivityInner</div><div class="line">            ├── ActivityThread.callCallActivityOnSaveInstanceState</div><div class="line">                ├── Instrumentation.callActivityOnSaveInstanceState</div><div class="line">                    ├── Activity.performSaveInstanceState</div><div class="line">                        ├── MyActivity.onSaveInstanceState</div></pre></td></tr></table></figure>
<p>当我们按返回键退出当前 Activity 时，是不会调用 onSaveInstanceState 的。</p>
<p>我们来看一下 Activity 的 onSaveInstanceState 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">   protected void onSaveInstanceState(Bundle outState) &#123;</div><div class="line">// 保存 View 的状态</div><div class="line">       outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState());</div><div class="line"></div><div class="line">       outState.putInt(LAST_AUTOFILL_ID, mLastAutofillId);</div><div class="line">// 保存 Fragment 的状态</div><div class="line">       Parcelable p = mFragments.saveAllState();</div><div class="line">       if (p != null) &#123;</div><div class="line">           outState.putParcelable(FRAGMENTS_TAG, p);</div><div class="line">       &#125;</div><div class="line">       if (mAutoFillResetNeeded) &#123;</div><div class="line">           outState.putBoolean(AUTOFILL_RESET_NEEDED, true);</div><div class="line">           getAutofillManager().onSaveInstanceState(outState);</div><div class="line">       &#125;</div><div class="line">// 通知一些声明周期的监听器来执行状态保存</div><div class="line">       getApplication().dispatchActivitySaveInstanceState(this, outState);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="数据保存"><a href="#数据保存" class="headerlink" title="数据保存"></a>数据保存</h2><p>那么是如何把我们需要保存的数据保存到 system 进程中的呢？</p>
<p>先来看 <strong>App 进程</strong>部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">├── ApplicationThreadNative.onTransact:SCHEDULE_STOP_ACTIVITY_TRANSACTION</div><div class="line">    ├── ActivityThread.ApplicationThread.scheduleStopActivity</div><div class="line">        ├── ActivityThread.handleStopActivity</div><div class="line">            ├── StopInfo.run</div><div class="line">                ├── ActivityManagerProxy.activityStopped</div><div class="line">                    ├── mRemote.transact(ACTIVITY_STOPPED_TRANSACTION, data, reply, IBinder.FLAG_ONEWAY)</div></pre></td></tr></table></figure>
<p>可以看到，数据的保存是伴随着 onStop 回调方法的调用而进行的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">private void handleStopActivity(IBinder token, boolean show, int configChanges, int seq) &#123;</div><div class="line">    //从 mActivities 中 取出 ActivityClientRecord 实例</div><div class="line">    ActivityClientRecord r = mActivities.get(token);</div><div class="line">    if (!checkAndUpdateLifecycleSeq(seq, r, &quot;stopActivity&quot;)) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    // FLYME:huangjinhai@BugFixAOSP Check this to avoid a NullPointerException &#123;@</div><div class="line">    if (r == null) &#123;</div><div class="line">        Log.w(TAG, &quot;handleStopActivity: no activity for token &quot; + token);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    // @&#125;</div><div class="line">    StopInfo info = new StopInfo();</div><div class="line">    performStopActivityInner(r, info, show, true, &quot;handleStopActivity&quot;);</div><div class="line"></div><div class="line">    if (localLOGV) Slog.v(</div><div class="line">        TAG, &quot;Finishing stop of &quot; + r + &quot;: show=&quot; + show</div><div class="line">        + &quot; win=&quot; + r.window);</div><div class="line"></div><div class="line">    updateVisibility(r, show);</div><div class="line"></div><div class="line">    // Make sure any pending writes are now committed.</div><div class="line">    if (!r.isPreHoneycomb()) &#123;</div><div class="line">        QueuedWork.waitToFinish();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Schedule the call to tell the activity manager we have</div><div class="line">    // stopped.  We don&apos;t do this immediately, because we want to</div><div class="line">    // have a chance for any other pending work (in particular memory</div><div class="line">    // trim requests) to complete before you tell the activity</div><div class="line">    // manager to proceed and allow us to go fully into the background.</div><div class="line">    // 赋值，传送到 system进程</div><div class="line">    info.activity = r;</div><div class="line">    info.state = r.state;</div><div class="line">    info.persistentState = r.persistentState;</div><div class="line">    mH.post(info);</div><div class="line">    mSomeActivitiesChanged = true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">private static class StopInfo implements Runnable &#123;</div><div class="line">    ActivityClientRecord activity;</div><div class="line">    Bundle state;</div><div class="line">    PersistableBundle persistentState;</div><div class="line">    CharSequence description;</div><div class="line"></div><div class="line">    @Override public void run() &#123;</div><div class="line">        // Tell activity manager we have been stopped.</div><div class="line">        try &#123;</div><div class="line">            if (DEBUG_MEMORY_TRIM) Slog.v(TAG, &quot;Reporting activity stopped: &quot; + activity);</div><div class="line">            ActivityManagerNative.getDefault().activityStopped(</div><div class="line">                activity.token, state, persistentState, description);</div><div class="line">        &#125; catch (RemoteException ex) &#123;</div><div class="line">            if (ex instanceof TransactionTooLargeException</div><div class="line">                    &amp;&amp; activity.packageInfo.getTargetSdkVersion() &lt; Build.VERSION_CODES.N) &#123;</div><div class="line">                Log.e(TAG, &quot;App sent too much data in instance state, so it was ignored&quot;, ex);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">            throw ex.rethrowFromSystemServer();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 StopInfo 的run方法中，把state等数据发送给system进程。</p>
<p>后面会把数据传送到 system 进程。<br>再来看一下 <strong>system 进程</strong>部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">├── ActivityManagerNative.onTransact:ACTIVITY_STOPPED_TRANSACTION</div><div class="line">    ├── ActivityManagerService.activityStopped</div><div class="line">        ├── ActivityStack.activityStoppedLocked</div></pre></td></tr></table></figure>
<p>保存 state 操作是在 ActivityStack.activityStoppedLocked进行的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">final void activityStoppedLocked(ActivityRecord r, Bundle icicle,</div><div class="line">        PersistableBundle persistentState, CharSequence description) &#123;</div><div class="line">    if (r.state != ActivityState.STOPPING) &#123;</div><div class="line">        Slog.i(TAG, &quot;Activity reported stop, but no longer stopping: &quot; + r);</div><div class="line">        mHandler.removeMessages(STOP_TIMEOUT_MSG, r);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    // 把 persistentState  保存到 system 进程</div><div class="line">    if (persistentState != null) &#123;</div><div class="line">        r.persistentState = persistentState;</div><div class="line">        mService.notifyTaskPersisterLocked(r.task, false);</div><div class="line">    &#125;</div><div class="line">    if (DEBUG_SAVED_STATE) Slog.i(TAG_SAVED_STATE, &quot;Saving icicle of &quot; + r + &quot;: &quot; + icicle);</div><div class="line">    if (icicle != null) &#123;</div><div class="line">        // If icicle is null, this is happening due to a timeout, so we</div><div class="line">        // haven&apos;t really saved the state.</div><div class="line">        // 把 icicle  保存到 system 进程</div><div class="line">        r.icicle = icicle;</div><div class="line">        r.haveState = true;</div><div class="line">        r.launchCount = 0;</div><div class="line">        r.updateThumbnailLocked(null, description);</div><div class="line">    &#125;</div><div class="line">    ......</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="数据恢复过程"><a href="#数据恢复过程" class="headerlink" title="数据恢复过程"></a>数据恢复过程</h2><p>我们从 App 进程再到 system 进程来反向追踪这个调用流程。<br>APP 进程调用栈如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">├── ApplicationThreadNative.onTransact:SCHEDULE_LAUNCH_ACTIVITY_TRANSACTION</div><div class="line">    ├── ActivityThread.ApplicationThread.scheduleLaunchActivity</div><div class="line">        ├── ActivityThread.H.handleMessage:LAUNCH_ACTIVITY</div><div class="line">            ├── ActivityThread.handleLaunchActivity</div><div class="line">                ├── ActivityThread.performLaunchActivity</div><div class="line">                    ├── Instrumentation.callActivityOnCreate</div><div class="line">                        ├── Activity.performCreate</div><div class="line">                            ├── MyActivity.onCreate</div><div class="line">                    ├── Instrumentation.callActivityOnRestoreInstanceState</div><div class="line">                        ├── Activity.performRestoreInstanceState</div><div class="line">                            ├── MyActivity.onRestoreInstanceState</div></pre></td></tr></table></figure>
<p>先来看一下 ActivityThread.performLaunchActivity 这部分代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</div><div class="line">    ......</div><div class="line">            activity.mCalled = false;</div><div class="line">            // 调用 callActivityOnCreate</div><div class="line">            if (r.isPersistable()) &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</div><div class="line">            &#125; else &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">            &#125;</div><div class="line">            if (!activity.mCalled) &#123;</div><div class="line">                throw new SuperNotCalledException(</div><div class="line">                    &quot;Activity &quot; + r.intent.getComponent().toShortString() +</div><div class="line">                    &quot; did not call through to super.onCreate()&quot;);</div><div class="line">            &#125;</div><div class="line">            r.activity = activity;</div><div class="line">            r.stopped = true;</div><div class="line">            if (!r.activity.mFinished) &#123;</div><div class="line">                activity.performStart();</div><div class="line">                r.stopped = false;</div><div class="line">            &#125;</div><div class="line">            // 根据 r.state 来决定是否调用 callActivityOnRestoreInstanceState</div><div class="line">            // 因此，onRestoreInstanceState 回调在 Activity的生命周期中不是必调用的</div><div class="line">            if (!r.activity.mFinished) &#123;</div><div class="line">                if (r.isPersistable()) &#123;</div><div class="line">                    if (r.state != null || r.persistentState != null) &#123;</div><div class="line">                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</div><div class="line">                                r.persistentState);</div><div class="line">                    &#125;</div><div class="line">                &#125; else if (r.state != null) &#123;</div><div class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        r.paused = true;</div><div class="line"></div><div class="line">        mActivities.put(r.token, r);</div><div class="line">    ......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据上面的代码我们发现，Acitivity 的 OnCreate 的 Bundle 参数是否为空以及是否回调 onRestoreInstanceState 是根据 r.state 是否为空来决定的。<br>那么决定这一切的 ActivityClientRecord 是什么呢？<br>ActivityClientRecord 是 ActivityThread 的一个内部类，它是 App 进程中一个 Activity 的代表，和 Activity 有一一对应的关系，它的 activity 成员引用真正的 Activity 组件。<br>那么 ActivityClientRecord 又是从 哪里传递过来的呢？<br>现在我们来看一下 App 进程调用的源头：ActivityThread.ApplicationThread.scheduleLaunchActivity：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public final void scheduleLaunchActivity(Intent intent, IBinder token, int ident,</div><div class="line">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</div><div class="line">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">        int procState, Bundle state, PersistableBundle persistentState,</div><div class="line">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</div><div class="line">        boolean notResumed, boolean isForward, ProfilerInfo profilerInfo) &#123;</div><div class="line"></div><div class="line">    updateProcessState(procState, false);</div><div class="line"></div><div class="line">    ActivityClientRecord r = new ActivityClientRecord();</div><div class="line"></div><div class="line">    r.token = token;</div><div class="line">    r.ident = ident;</div><div class="line">    r.intent = intent;</div><div class="line">    r.referrer = referrer;</div><div class="line">    r.voiceInteractor = voiceInteractor;</div><div class="line">    r.activityInfo = info;</div><div class="line">    r.compatInfo = compatInfo;</div><div class="line">    r.state = state;</div><div class="line">    r.persistentState = persistentState;</div><div class="line"></div><div class="line">    r.pendingResults = pendingResults;</div><div class="line">    r.pendingIntents = pendingNewIntents;</div><div class="line"></div><div class="line">    r.startsNotResumed = notResumed;</div><div class="line">    r.isForward = isForward;</div><div class="line"></div><div class="line">    r.profilerInfo = profilerInfo;</div><div class="line"></div><div class="line">    r.overrideConfig = overrideConfig;</div><div class="line">    updatePendingConfiguration(curConfig);</div><div class="line"></div><div class="line">    sendMessage(H.LAUNCH_ACTIVITY, r);</div></pre></td></tr></table></figure>
<p>这里创建了一个 ActivityClientRecord 对象，然后对我们关心的 r.state 进行赋值。state 是从 system_server 通过进程间调用传递过来的。</p>
<p>那么我们现在就开始分析 <strong>system_server 进程</strong>部分：</p>
<p>在 ApplicationThreadProxy.scheduleLaunchActivity 里面，state 被写入然后传递到客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public final void scheduleLaunchActivity(Intent intent, IBinder token, int ident,</div><div class="line">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</div><div class="line">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">        int procState, Bundle state, PersistableBundle persistentState,</div><div class="line">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</div><div class="line">        boolean notResumed, boolean isForward, ProfilerInfo profilerInfo) throws RemoteException &#123;</div><div class="line">    Parcel data = Parcel.obtain();</div><div class="line">    ......</div><div class="line">    data.writeInt(procState);</div><div class="line">    data.writeBundle(state);</div><div class="line">    data.writePersistableBundle(persistentState);</div><div class="line">    ......</div><div class="line">    mRemote.transact(SCHEDULE_LAUNCH_ACTIVITY_TRANSACTION, data, null,</div><div class="line">            IBinder.FLAG_ONEWAY);</div><div class="line">    data.recycle();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么现在我们就追踪一下，state的来源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">├── ActivityStack.resumeTopActivityInnerLocked</div><div class="line">    ├── ActivityStackSupervisor.startSpecificActivityLocked</div><div class="line">        ├── ActivityStackSupervisor.realStartActivityLocked</div><div class="line">            ├── ApplicationThreadProxy.scheduleLaunchActivity</div></pre></td></tr></table></figure>
<p>在 ActivityStackSupervisor.realStartActivityLocked 方法中，把参数 ActivityRecord 的 icicle 属性作为参数传递给ActivityStack.resumeTopActivityInnerLocked。<br>ActivityRecord 对应着 App 进程中的一个Acitivty实例，保存了 Activity 的所有信息。<br>那么 ActivityRecord 参数又是从哪里得到的呢？<br>在 ActivityStack.resumeTopActivityInnerLocked 方法中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">private boolean resumeTopActivityInnerLocked(ActivityRecord prev, ActivityOptions options) &#123;</div><div class="line">    ......</div><div class="line">    final ActivityRecord next = topRunningActivityLocked();</div><div class="line">    ......</div><div class="line">    mStackSupervisor.startSpecificActivityLocked(next, true, true);</div><div class="line">    ......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过追踪源码发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">final ActivityRecord topRunningActivityLocked() &#123;</div><div class="line">    for (int taskNdx = mTaskHistory.size() - 1; taskNdx &gt;= 0; --taskNdx) &#123;</div><div class="line">        ActivityRecord r = mTaskHistory.get(taskNdx).topRunningActivityLocked();</div><div class="line">        if (r != null) &#123;</div><div class="line">            return r;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mTaskHistory 中存储了对应与 App 进程中的任务栈。<br>因此，当 App 进程中的 Activity 意外退出时，system 进程还是保存着 Activity 的信息的，以便于下次启动时恢复数据。</p>
<h2 id="数据清理"><a href="#数据清理" class="headerlink" title="数据清理"></a>数据清理</h2><p>system_server 进程</p>
<p>强制停止：当调用 am fore-stop 或者 设置里面的强制停止时，调用流程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">├── ActivityManagerService.forceStopPackage</div><div class="line">    ├── ActivityManagerService.forceStopPackageLocked</div><div class="line">        ├── ActivityManagerService.forceStopPackageLocked</div><div class="line">            ├── ActivityStackSupervisor.finishDisabledPackageActivitiesLocked</div><div class="line">                ├── ActivityStack.finishDisabledPackageActivitiesLocked</div><div class="line">                    ├── ActivityStack.finishActivityLocked</div><div class="line">                        ├── ActivityStack.finishActivityResultsLocked</div></pre></td></tr></table></figure>
<p>onDestory：当Activity 走正常销毁逻辑时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">├── ActivityManagerService.activityDestroyed</div><div class="line">    ├── ActivityStack.activityDestroyedLocked</div><div class="line">        ├── ActivityStack.removeActivityFromHistoryLocked</div><div class="line">            ├── ActivityStack.finishActivityResultsLocked</div></pre></td></tr></table></figure>
<p>都调用了 ActivityStack.finishActivityResultsLocked，在这个方法中，会对 icicle 进行置空操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">final void finishActivityResultsLocked(ActivityRecord r, int resultCode, Intent resultData) &#123;</div><div class="line">    // send the result</div><div class="line">    ActivityRecord resultTo = r.resultTo;</div><div class="line">    if (resultTo != null) &#123;</div><div class="line">        if (DEBUG_RESULTS) Slog.v(TAG_RESULTS, &quot;Adding result to &quot; + resultTo</div><div class="line">                + &quot; who=&quot; + r.resultWho + &quot; req=&quot; + r.requestCode</div><div class="line">                + &quot; res=&quot; + resultCode + &quot; data=&quot; + resultData);</div><div class="line">        if (resultTo.userId != r.userId) &#123;</div><div class="line">            if (resultData != null) &#123;</div><div class="line">                resultData.prepareToLeaveUser(r.userId);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (r.info.applicationInfo.uid &gt; 0) &#123;</div><div class="line">            mService.grantUriPermissionFromIntentLocked(r.info.applicationInfo.uid,</div><div class="line">                    resultTo.packageName, resultData,</div><div class="line">                    resultTo.getUriPermissionsLocked(), resultTo.userId);</div><div class="line">        &#125;</div><div class="line">        resultTo.addResultLocked(r, r.resultWho, r.requestCode, resultCode,</div><div class="line">                                 resultData);</div><div class="line">        r.resultTo = null;</div><div class="line">    &#125;</div><div class="line">    else if (DEBUG_RESULTS) Slog.v(TAG_RESULTS, &quot;No result destination from &quot; + r);</div><div class="line"></div><div class="line">    // Make sure this HistoryRecord is not holding on to other resources,</div><div class="line">    // because clients have remote IPC references to this object so we</div><div class="line">    // can&apos;t assume that will go away and want to avoid circular IPC refs.</div><div class="line">    r.results = null;</div><div class="line">    r.pendingResults = null;</div><div class="line">    r.newIntents = null;</div><div class="line">    r.icicle = null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/onSaveInstanceState/" rel="tag"># onSaveInstanceState</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/06/android-basic-oncreate-application-contentprovider/" rel="next" title="Android -- Application 和 ContentProvider 的 onCreate() 方法的执行顺序">
                <i class="fa fa-chevron-left"></i> Android -- Application 和 ContentProvider 的 onCreate() 方法的执行顺序
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/15/android-knowledge-about-view-save-state/" rel="prev" title="Android -- View 之 onSaveInstanceState 深入理解">
                Android -- View 之 onSaveInstanceState 深入理解 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/icon.png"
               alt="寒江蓑笠" />
          <p class="site-author-name" itemprop="name">寒江蓑笠</p>
          <p class="site-description motion-element" itemprop="description">技术博客</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">222</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">108</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/heqiangflytosky/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/heqiangflytosky/" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关方法介绍"><span class="nav-number">2.</span> <span class="nav-text">相关方法介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用方法"><span class="nav-number">3.</span> <span class="nav-text">使用方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于-PersistableBundle"><span class="nav-number">4.</span> <span class="nav-text">关于 PersistableBundle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#onSaveInstanceState-调用时机"><span class="nav-number">5.</span> <span class="nav-text">onSaveInstanceState 调用时机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据保存"><span class="nav-number">6.</span> <span class="nav-text">数据保存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据恢复过程"><span class="nav-number">7.</span> <span class="nav-text">数据恢复过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据清理"><span class="nav-number">8.</span> <span class="nav-text">数据清理</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">寒江蓑笠</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "d2475abece3649debc94c21b166fc009",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("6zbrLyUbhXLbd7RqUSMnxhg4-gzGzoHsz", "fb9g4GyEWQysqnpY9t5CPhpU");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
